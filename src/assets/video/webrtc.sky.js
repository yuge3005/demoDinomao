(()=>{var e={329:()=>{window.Skylynx=function(){this.debug=!1,this.connected=!1,this.init=function(e){this.errorCallback=e.errorCallback,this.reconnectCallback=e.reconnectCallback;var n=this.debug=e.debug,r=e.turnAddress,a=this.stopStream,t=this.log,o=this.error,s=this,i=document.querySelector("#"+e.videoObject),d=e.turnUsername?e.turnUsername:"",u=e.turnCredential?e.turnCredential:"",c=function(e,n,r){var a=[],t=e.replace(" ","").split(",");for(var o in t)a.push(r+":"+t[o]+"?transport="+n);return a};Janus.init({debug:!!n&&"all",callback:function(){Janus.isWebrtcSupported()?s.janus=new Janus({server:e.websocketAddress,iceTransportPolicy:"relay",iceServers:[{urls:c(r,"udp","turn"),username:d,credential:u},{urls:c(r,"tcp","turns"),username:d,credential:u}],success:function(){s.connected=!0,s.janus.attach({plugin:"janus.plugin.streaming",opaqueId:d,success:function(n){s.streaming=n,t("Plugin attached! ("+s.streaming.getPlugin()+", id="+s.streaming.getId()+")"),e.successCallback()},error:function(n){n("  -- Error attaching plugin... ",e.errorCallback)},iceState:function(e){t("ICE state changed to "+e)},webrtcState:function(e){t("Janus says our WebRTC PeerConnection is "+(e?"up":"down")+" now")},onmessage:function(n,r){t(" ::: Got a message :::",n);var i=n.result;if(i){if(i.status){var d=i.status;"starting"===d?t("starting"):"started"===d?t("started"):"stopped"===d&&(t("stopped"),a(s))}else if("event"===n.streaming){i.substream;var u=i.temporal,c=i.spatial_layer;u=i.temporal_layer,null==c&&null==u||svcStarted||(svcStarted=!0)}}else if(n.error)return o(n.error,e.errorCallback),void a(s);if(r){t("Handling SDP as well...",r);var l=-1!==r.sdp.indexOf("stereo=1");s.streaming.createAnswer({jsep:r,media:{audioSend:!1,videoSend:!1,data:!0},customizeSdp:function(e){l&&-1==e.sdp.indexOf("stereo=1")&&(e.sdp=e.sdp.replace("useinbandfec=1","useinbandfec=1;stereo=1"))},success:function(e){t("Got SDP!",e);s.streaming.send({message:{request:"start"},jsep:e})},error:function(n){Janus.error("WebRTC error:",n),n("WebRTC error:"+n,e.errorCallback)}})}},onremotestream:function(n,r){if(i){r&&e.startedCallback(r),Janus.attachMediaStream(i,n);var a=n.getVideoTracks();a&&0!==a.length||setTimeout((function(){var r=n.getVideoTracks();r&&0!==r.length||o("No remote video available!",e.errorCallback)}),5e3)}else o("HTML video object not found!",e.errorCallback)},ondataopen:function(e){Janus.log("The DataChannel is available!")},ondata:function(e){t("We got data from the DataChannel!",e)},oncleanup:function(){t("oncleanup")}})},error:function(n){"Lost connection to the server (is it down?)"===n&&(s.connected=!1,e.reconnectCallback?e.reconnectCallback():console.log("reconnectCallback not implemented")),console.error(n)},destroyed:function(){t("destroyed")}}):o("No WebRTC support... ",e.errorCallback)}})},this.start=function(e,n){this.startStream(e,n,this)},this.startStream=function(e,n,r){if(!e)return!1;var a={request:"watch",id:e,pin:n};r.streaming.send({message:a})},this.play=function(e){var n=this;e.play().then((function(e){})).catch((function(e){n.error("Error: "+e,n.errorCallback)}))},this.stopStream=function(e){e.streaming.send({message:{request:"stop"}}),e.streaming.hangup()},this.stop=function(){this.stopStream(this)},this.destroyStream=function(e){e.janus.destroy()},this.destroy=function(){this.destroyStream(this)},this.log=function(e){this.debug&&console.log(e)},this.error=function(e,n){console.error(e),n&&n(e)}}},69:()=>{function e(n){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e(n)}function n(e,n){var a="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!a){if(Array.isArray(e)||(a=function(e,n){if(!e)return;if("string"==typeof e)return r(e,n);var a=Object.prototype.toString.call(e).slice(8,-1);"Object"===a&&e.constructor&&(a=e.constructor.name);if("Map"===a||"Set"===a)return Array.from(e);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return r(e,n)}(e))||n&&e&&"number"==typeof e.length){a&&(e=a);var t=0,o=function(){};return{s:o,n:function(){return t>=e.length?{done:!0}:{done:!1,value:e[t++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,i=!0,d=!1;return{s:function(){a=a.call(e)},n:function(){var e=a.next();return i=e.done,e},e:function(e){d=!0,s=e},f:function(){try{i||null==a.return||a.return()}finally{if(d)throw s}}}}function r(e,n){(null==n||n>e.length)&&(n=e.length);for(var r=0,a=new Array(n);r<n;r++)a[r]=e[r];return a}window.Janus=function(r){if((r=r||{}).success="function"==typeof r.success?r.success:Janus.noop,r.error="function"==typeof r.error?r.error:Janus.noop,r.destroyed="function"==typeof r.destroyed?r.destroyed:Janus.noop,!Janus.initDone)return r.error("Library not initialized"),{};if(!Janus.isWebrtcSupported())return r.error("WebRTC not supported by this browser"),{};if(Janus.log("Library initialized: "+Janus.initDone),!r.server)return r.error("Invalid server url"),{};var a=!1,t=null,o={},s=null,i=null,d=0,u=r.server;Janus.isArray(u)?(Janus.log("Multiple servers provided ("+u.length+"), will use the first that works"),u=null,i=r.server,Janus.debug(i)):0===u.indexOf("ws")?(a=!0,Janus.log("Using WebSockets to contact Janus: "+u)):(a=!1,Janus.log("Using REST API to contact Janus: "+u));var c=r.iceServers||[{urls:"stun:stun.l.google.com:19302"}],l=r.iceTransportPolicy,f=r.bundlePolicy,v=!0===r.ipv6,g=!1;void 0!==r.withCredentials&&null!==r.withCredentials&&(g=!0===r.withCredentials);var p=10;void 0!==r.max_poll_events&&null!==r.max_poll_events&&(p=r.max_poll_events),p<1&&(p=1);var m=null;void 0!==r.token&&null!==r.token&&(m=r.token);var b=null;void 0!==r.apisecret&&null!==r.apisecret&&(b=r.apisecret),this.destroyOnUnload=!0,void 0!==r.destroyOnUnload&&null!==r.destroyOnUnload&&(this.destroyOnUnload=!0===r.destroyOnUnload);var J=25e3;void 0!==r.keepAlivePeriod&&null!==r.keepAlivePeriod&&(J=r.keepAlivePeriod),isNaN(J)&&(J=25e3);var h=6e4;function w(e){var n={high:9e5,medium:3e5,low:1e5};return null!=e&&(e.high&&(n.high=e.high),e.medium&&(n.medium=e.medium),e.low&&(n.low=e.low)),n}void 0!==r.longPollTimeout&&null!==r.longPollTimeout&&(h=r.longPollTimeout),isNaN(h)&&(h=6e4);var S=!1,y=null,k={},T=this,C=0,A={};function D(){if(null!=y)if(Janus.debug("Long poll..."),S){var e=u+"/"+y+"?rid="+(new Date).getTime();p&&(e=e+"&maxev="+p),m&&(e=e+"&token="+encodeURIComponent(m)),b&&(e=e+"&apisecret="+encodeURIComponent(b)),Janus.httpAPICall(e,{verb:"GET",withCredentials:g,success:R,timeout:h,error:function(e,n){if(Janus.error(e+":",n),++C>3)return S=!1,void r.error("Lost connection to the server (is it down?)");D()}})}else Janus.warn("Is the server down? (connected=false)")}function R(e,n){if(C=0,a||null==y||!0===n||D(),a||!Janus.isArray(e))if("keepalive"!==e.janus)if("server_info"!==e.janus)if("ack"!==e.janus)if("success"!==e.janus)if("trickle"===e.janus){if(!(d=e.sender))return void Janus.warn("Missing sender...");if(!(c=k[d]))return void Janus.debug("This handle is not attached to this session");var r=e.candidate;Janus.debug("Got a trickled candidate on session "+y),Janus.debug(r);var o=c.webrtcStuff;o.pc&&o.remoteSdp?(Janus.debug("Adding remote candidate:",r),r&&!0!==r.completed?o.pc.addIceCandidate(r):o.pc.addIceCandidate(Janus.endOfCandidates)):(Janus.debug("We didn't do setRemoteDescription (trickle got here before the offer?), caching candidate"),o.candidates||(o.candidates=[]),o.candidates.push(r),Janus.debug(o.candidates))}else{if("webrtcup"===e.janus)return Janus.debug("Got a webrtcup event on session "+y),Janus.debug(e),(d=e.sender)?(c=k[d])?void c.webrtcState(!0):void Janus.debug("This handle is not attached to this session"):void Janus.warn("Missing sender...");if("hangup"===e.janus){if(Janus.debug("Got a hangup event on session "+y),Janus.debug(e),!(d=e.sender))return void Janus.warn("Missing sender...");if(!(c=k[d]))return void Janus.debug("This handle is not attached to this session");c.webrtcState(!1,e.reason),c.hangup()}else if("detached"===e.janus){if(Janus.debug("Got a detached event on session "+y),Janus.debug(e),!(d=e.sender))return void Janus.warn("Missing sender...");if(!(c=k[d]))return;c.ondetached(),c.detach()}else if("media"===e.janus){if(Janus.debug("Got a media event on session "+y),Janus.debug(e),!(d=e.sender))return void Janus.warn("Missing sender...");if(!(c=k[d]))return void Janus.debug("This handle is not attached to this session");c.mediaState(e.type,e.receiving)}else if("slowlink"===e.janus){if(Janus.debug("Got a slowlink event on session "+y),Janus.debug(e),!(d=e.sender))return void Janus.warn("Missing sender...");if(!(c=k[d]))return void Janus.debug("This handle is not attached to this session");c.slowLink(e.uplink,e.lost)}else{if("error"===e.janus){var s,i;if(Janus.error("Ooops: "+e.error.code+" "+e.error.reason),Janus.debug(e),s=e.transaction)(i=A[s])&&i(e),delete A[s];return}if("event"===e.janus){var d;if(Janus.debug("Got a plugin event on session "+y),Janus.debug(e),!(d=e.sender))return void Janus.warn("Missing sender...");var u=e.plugindata;if(!u)return void Janus.warn("Missing plugindata...");Janus.debug("  -- Event is coming from "+d+" ("+u.plugin+")");var c,l=u.data;if(Janus.debug(l),!(c=k[d]))return void Janus.warn("This handle is not attached to this session");var f=e.jsep;f&&(Janus.debug("Handling SDP as well..."),Janus.debug(f));var v=c.onmessage;v?(Janus.debug("Notifying application..."),v(l,f)):Janus.debug("No provided notification callback")}else{if("timeout"===e.janus)return Janus.error("Timeout on session "+y),Janus.debug(e),void(a&&t.close(3504,"Gateway timeout"));Janus.warn("Unknown message/event  '"+e.janus+"' on session "+y),Janus.debug(e)}}}else Janus.debug("Got a success on session "+y),Janus.debug(e),(s=e.transaction)&&((i=A[s])&&i(e),delete A[s]);else Janus.debug("Got an ack on session "+y),Janus.debug(e),(s=e.transaction)&&((i=A[s])&&i(e),delete A[s]);else Janus.debug("Got info on the Janus instance"),Janus.debug(e),(s=e.transaction)&&((i=A[s])&&i(e),delete A[s]);else Janus.vdebug("Got a keepalive on session "+y);else for(var g=0;g<e.length;g++)R(e[g],!0)}function I(){if(u&&a&&S){s=setTimeout(I,J);var e={janus:"keepalive",session_id:y,transaction:Janus.randomString(12)};m&&(e.token=m),b&&(e.apisecret=b),t.send(JSON.stringify(e))}}function P(e){var n=Janus.randomString(12),c={janus:"create",transaction:n};if(e.reconnect&&(S=!1,c.janus="claim",c.session_id=y,t&&(t.onopen=null,t.onerror=null,t.onclose=null,s&&(clearTimeout(s),s=null))),m&&(c.token=m),b&&(c.apisecret=b),!u&&Janus.isArray(i)&&(0===(u=i[d]).indexOf("ws")?(a=!0,Janus.log("Server #"+(d+1)+": trying WebSockets to contact Janus ("+u+")")):(a=!1,Janus.log("Server #"+(d+1)+": trying REST API to contact Janus ("+u+")"))),a)for(var l in t=Janus.newWebSocket(u,"janus-protocol"),o={error:function(){if(Janus.error("Error connecting to the Janus WebSockets server... "+u),Janus.isArray(i)&&!e.reconnect)return++d===i.length?void e.error("Error connecting to any of the provided Janus servers: Is the server down?"):(u=null,void setTimeout((function(){P(e)}),200));e.error("Error connecting to the Janus WebSockets server: Is the server down?")},open:function(){A[n]=function(n){if(Janus.debug(n),"success"!==n.janus)return Janus.error("Ooops: "+n.error.code+" "+n.error.reason),void e.error(n.error.reason);s=setTimeout(I,J),S=!0,y=n.session_id?n.session_id:n.data.id,e.reconnect?Janus.log("Claimed session: "+y):Janus.log("Created session: "+y),Janus.sessions[y]=T,e.success()},t.send(JSON.stringify(c))},message:function(e){R(JSON.parse(e.data))},close:function(){u&&S&&(S=!1,r.error("Lost connection to the server (is it down?)"))}})t.addEventListener(l,o[l]);else Janus.httpAPICall(u,{verb:"POST",withCredentials:g,body:c,success:function(n){if(Janus.debug(n),"success"!==n.janus)return Janus.error("Ooops: "+n.error.code+" "+n.error.reason),void e.error(n.error.reason);S=!0,y=n.session_id?n.session_id:n.data.id,e.reconnect?Janus.log("Claimed session: "+y):Janus.log("Created session: "+y),Janus.sessions[y]=T,D(),e.success()},error:function(n,r){if(Janus.error(n+":",r),Janus.isArray(i)&&!e.reconnect)return++d===i.length?void e.error("Error connecting to any of the provided Janus servers: Is the server down?"):(u=null,void setTimeout((function(){P(e)}),200));""===r?e.error(n+": Is the server down?"):e.error(n+": "+r)}})}function V(e,n){if((n=n||{}).success="function"==typeof n.success?n.success:Janus.noop,n.error="function"==typeof n.error?n.error:Janus.noop,!S)return Janus.warn("Is the server down? (connected=false)"),void n.error("Is the server down? (connected=false)");var r=k[e];if(!r||!r.webrtcStuff)return Janus.warn("Invalid handle"),void n.error("Invalid handle");var o=n.message,s=n.jsep,i=Janus.randomString(12),d={janus:"message",body:o,transaction:i};if(r.token&&(d.token=r.token),b&&(d.apisecret=b),s&&(d.jsep={type:s.type,sdp:s.sdp},s.e2ee&&(d.jsep.e2ee=!0),"hml"!==s.rid_order&&"lmh"!==s.rid_order||(d.jsep.rid_order=s.rid_order)),Janus.debug("Sending message to plugin (handle="+e+"):"),Janus.debug(d),a)return d.session_id=y,d.handle_id=e,A[i]=function(e){if(Janus.debug("Message sent!"),Janus.debug(e),"success"===e.janus){var r=e.plugindata;if(!r)return Janus.warn("Request succeeded, but missing plugindata..."),void n.success();Janus.log("Synchronous transaction successful ("+r.plugin+")");var a=r.data;return Janus.debug(a),void n.success(a)}"ack"===e.janus?n.success():e.error?(Janus.error("Ooops: "+e.error.code+" "+e.error.reason),n.error(e.error.code+" "+e.error.reason)):(Janus.error("Unknown error"),n.error("Unknown error"))},void t.send(JSON.stringify(d));Janus.httpAPICall(u+"/"+y+"/"+e,{verb:"POST",withCredentials:g,body:d,success:function(e){if(Janus.debug("Message sent!"),Janus.debug(e),"success"===e.janus){var r=e.plugindata;if(!r)return Janus.warn("Request succeeded, but missing plugindata..."),void n.success();Janus.log("Synchronous transaction successful ("+r.plugin+")");var a=r.data;return Janus.debug(a),void n.success(a)}"ack"===e.janus?n.success():e.error?(Janus.error("Ooops: "+e.error.code+" "+e.error.reason),n.error(e.error.code+" "+e.error.reason)):(Janus.error("Unknown error"),n.error("Unknown error"))},error:function(e,r){Janus.error(e+":",r),n.error(e+": "+r)}})}function x(e,n){if(S){var r=k[e];if(r&&r.webrtcStuff){var o={janus:"trickle",candidate:n,transaction:Janus.randomString(12)};if(r.token&&(o.token=r.token),b&&(o.apisecret=b),Janus.vdebug("Sending trickle candidate (handle="+e+"):"),Janus.vdebug(o),a)return o.session_id=y,o.handle_id=e,void t.send(JSON.stringify(o));Janus.httpAPICall(u+"/"+y+"/"+e,{verb:"POST",withCredentials:g,body:o,success:function(e){Janus.vdebug("Candidate sent!"),Janus.vdebug(e),"ack"===e.janus||Janus.error("Ooops: "+e.error.code+" "+e.error.reason)},error:function(e,n){Janus.error(e+":",n)}})}else Janus.warn("Invalid handle")}else Janus.warn("Is the server down? (connected=false)")}function j(e,r,a,t,o){var s=k[e];if(s&&s.webrtcStuff){var i=s.webrtcStuff;if(i.pc){var d=function(e){Janus.log("Received state change on data channel:",e);var r=e.target.label,a=e.target.protocol,t=i.dataChannel[r]?i.dataChannel[r].readyState:"null";if(Janus.log("State change on <"+r+"> data channel: "+t),"open"===t){if(i.dataChannel[r].pending&&i.dataChannel[r].pending.length>0){Janus.log("Sending pending messages on <"+r+">:",i.dataChannel[r].pending.length);var o,d=n(i.dataChannel[r].pending);try{for(d.s();!(o=d.n()).done;){var u=o.value;Janus.log("Sending data on data channel <"+r+">"),Janus.debug(u),i.dataChannel[r].send(u)}}catch(e){d.e(e)}finally{d.f()}i.dataChannel[r].pending=[]}s.ondataopen(r,a)}};if(t)i.dataChannel[r]=t;else{var u={ordered:!0};a&&(u.protocol=a),i.dataChannel[r]=i.pc.createDataChannel(r,u)}i.dataChannel[r].onmessage=function(e){Janus.log("Received message on data channel:",e);var n=e.target.label;s.ondata(e.data,n)},i.dataChannel[r].onopen=d,i.dataChannel[r].onclose=d,i.dataChannel[r].onerror=function(e){Janus.error("Got error on data channel:",e)},i.dataChannel[r].pending=[],o&&i.dataChannel[r].pending.push(o)}else Janus.warn("Invalid PeerConnection")}else Janus.warn("Invalid handle")}function E(e,n){(n=n||{}).success="function"==typeof n.success?n.success:Janus.noop,n.error="function"==typeof n.error?n.error:Janus.noop;var r=k[e];if(!r||!r.webrtcStuff)return Janus.warn("Invalid handle"),void n.error("Invalid handle");var a=r.webrtcStuff,t=n.text||n.data;if(!t)return Janus.warn("Invalid data"),void n.error("Invalid data");var o=n.label?n.label:Janus.dataChanDefaultLabel;return a.dataChannel[o]?"open"!==a.dataChannel[o].readyState?(a.dataChannel[o].pending.push(t),void n.success()):(Janus.log("Sending data on data channel <"+o+">"),Janus.debug(t),a.dataChannel[o].send(t),void n.success()):(j(e,o,n.protocol,!1,t,n.protocol),void n.success())}function M(e,n){(n=n||{}).success="function"==typeof n.success?n.success:Janus.noop,n.error="function"==typeof n.error?n.error:Janus.noop;var r=k[e];if(!r||!r.webrtcStuff)return Janus.warn("Invalid handle"),void n.error("Invalid handle");var a=r.webrtcStuff;if(!a.dtmfSender){if(a.pc){var t=a.pc.getSenders().find((function(e){return e.track&&"audio"===e.track.kind}));if(!t)return Janus.warn("Invalid DTMF configuration (no audio track)"),void n.error("Invalid DTMF configuration (no audio track)");a.dtmfSender=t.dtmf,a.dtmfSender&&(Janus.log("Created DTMF Sender"),a.dtmfSender.ontonechange=function(e){Janus.debug("Sent DTMF tone: "+e.tone)})}if(!a.dtmfSender)return Janus.warn("Invalid DTMF configuration"),void n.error("Invalid DTMF configuration")}var o=n.dtmf;if(!o)return Janus.warn("Invalid DTMF parameters"),void n.error("Invalid DTMF parameters");var s=o.tones;if(!s)return Janus.warn("Invalid DTMF string"),void n.error("Invalid DTMF string");var i="number"==typeof o.duration?o.duration:500,d="number"==typeof o.gap?o.gap:50;Janus.debug("Sending DTMF string "+s+" (duration "+i+"ms, gap "+d+"ms)"),a.dtmfSender.insertDTMF(s,i,d),n.success()}function O(e,n){(n=n||{}).success="function"==typeof n.success?n.success:Janus.noop,n.error="function"==typeof n.error?n.error:Janus.noop;var r=!0===n.noRequest;Janus.log("Destroying handle "+e+" (only-locally="+r+")"),q(e);var o=k[e];if(!o||o.detached)return delete k[e],void n.success();if(o.detached=!0,r)return delete k[e],void n.success();if(!S)return Janus.warn("Is the server down? (connected=false)"),void n.error("Is the server down? (connected=false)");var s={janus:"detach",transaction:Janus.randomString(12)};if(o.token&&(s.token=o.token),b&&(s.apisecret=b),a)return s.session_id=y,s.handle_id=e,t.send(JSON.stringify(s)),delete k[e],void n.success();Janus.httpAPICall(u+"/"+y+"/"+e,{verb:"POST",withCredentials:g,body:s,success:function(r){Janus.log("Destroyed handle:"),Janus.debug(r),"success"!==r.janus&&Janus.error("Ooops: "+r.error.code+" "+r.error.reason),delete k[e],n.success()},error:function(r,a){Janus.error(r+":",a),delete k[e],n.success()}})}function L(r,a,t,o,s){var i=k[r];if(!i||!i.webrtcStuff)return Janus.warn("Invalid handle"),o.stream||Janus.stopAllTracks(s),void o.error("Invalid handle");var d=i.webrtcStuff;Janus.debug("streamsDone:",s),s&&(Janus.debug("  -- Audio tracks:",s.getAudioTracks()),Janus.debug("  -- Video tracks:",s.getVideoTracks()));var u=!1;if(d.myStream&&t.update&&(!d.streamExternal||t.replaceAudio||t.replaceVideo)){if((!t.update&&z(t)||t.update&&(t.addAudio||t.replaceAudio))&&s.getAudioTracks()&&s.getAudioTracks().length)if(d.myStream.addTrack(s.getAudioTracks()[0]),Janus.unifiedPlan){Janus.log((t.replaceAudio?"Replacing":"Adding")+" audio track:",s.getAudioTracks()[0]);var g=null;if((b=d.pc.getTransceivers())&&b.length>0){var p,m=n(b);try{for(m.s();!(p=m.n()).done;){if((y=p.value).sender&&y.sender.track&&"audio"===y.sender.track.kind||y.receiver&&y.receiver.track&&"audio"===y.receiver.track.kind){g=y;break}}}catch(e){m.e(e)}finally{m.f()}}g&&g.sender?g.sender.replaceTrack(s.getAudioTracks()[0]):d.pc.addTrack(s.getAudioTracks()[0],s)}else Janus.log((t.replaceAudio?"Replacing":"Adding")+" audio track:",s.getAudioTracks()[0]),d.pc.addTrack(s.getAudioTracks()[0],s);if((!t.update&&Q(t)||t.update&&(t.addVideo||t.replaceVideo))&&s.getVideoTracks()&&s.getVideoTracks().length)if(d.myStream.addTrack(s.getVideoTracks()[0]),Janus.unifiedPlan){Janus.log((t.replaceVideo?"Replacing":"Adding")+" video track:",s.getVideoTracks()[0]);var b,J=null;if((b=d.pc.getTransceivers())&&b.length>0){var h,S=n(b);try{for(S.s();!(h=S.n()).done;){var y;if((y=h.value).sender&&y.sender.track&&"video"===y.sender.track.kind||y.receiver&&y.receiver.track&&"video"===y.receiver.track.kind){J=y;break}}}catch(e){S.e(e)}finally{S.f()}}J&&J.sender?J.sender.replaceTrack(s.getVideoTracks()[0]):d.pc.addTrack(s.getVideoTracks()[0],s)}else Janus.log((t.replaceVideo?"Replacing":"Adding")+" video track:",s.getVideoTracks()[0]),d.pc.addTrack(s.getVideoTracks()[0],s)}else d.myStream=s,u=!0;if(!d.pc){var T={iceServers:c,iceTransportPolicy:l,bundlePolicy:f};"chrome"===Janus.webRTCAdapter.browserDetails.browser&&(T.sdpSemantics=Janus.webRTCAdapter.browserDetails.version<72?"plan-b":"unified-plan");var C={optional:[{DtlsSrtpKeyAgreement:!0}]};if(v&&C.optional.push({googIPv6:!0}),o.rtcConstraints&&"object"===e(o.rtcConstraints))for(var A in Janus.debug("Adding custom PeerConnection constraints:",o.rtcConstraints),o.rtcConstraints)C.optional.push(o.rtcConstraints[A]);"edge"===Janus.webRTCAdapter.browserDetails.browser&&(T.bundlePolicy="max-bundle"),RTCRtpSender&&(RTCRtpSender.prototype.createEncodedStreams||RTCRtpSender.prototype.createEncodedAudioStreams&&RTCRtpSender.prototype.createEncodedVideoStreams)&&(o.senderTransforms||o.receiverTransforms)&&(d.senderTransforms=o.senderTransforms,d.receiverTransforms=o.receiverTransforms,T.forceEncodedAudioInsertableStreams=!0,T.forceEncodedVideoInsertableStreams=!0,T.encodedInsertableStreams=!0),Janus.log("Creating PeerConnection"),Janus.debug(C),d.pc=new RTCPeerConnection(T,C),Janus.debug(d.pc),d.pc.getStats&&(d.volume={},d.bitrate.value="0 kbits/sec"),Janus.log("Preparing local SDP and gathering candidates (trickle="+d.trickle+")"),d.pc.oniceconnectionstatechange=function(e){d.pc&&i.iceState(d.pc.iceConnectionState)},d.pc.onicecandidate=function(e){if(!e.candidate||"edge"===Janus.webRTCAdapter.browserDetails.browser&&e.candidate.candidate.indexOf("endOfCandidates")>0)Janus.log("End of candidates."),d.iceDone=!0,!0===d.trickle?x(r,{completed:!0}):function(e,n){(n=n||{}).success="function"==typeof n.success?n.success:Janus.noop,n.error="function"==typeof n.error?n.error:Janus.noop;var r=k[e];if(!r||!r.webrtcStuff)return void Janus.warn("Invalid handle, not sending anything");var a=r.webrtcStuff;if(Janus.log("Sending offer/answer SDP..."),!a.mySdp)return void Janus.warn("Local SDP instance is invalid, not sending anything...");a.mySdp={type:a.pc.localDescription.type,sdp:a.pc.localDescription.sdp},!1===a.trickle&&(a.mySdp.trickle=!1);Janus.debug(n),a.sdpSent=!0,n.success(a.mySdp)}(r,o);else{var n={candidate:e.candidate.candidate,sdpMid:e.candidate.sdpMid,sdpMLineIndex:e.candidate.sdpMLineIndex};!0===d.trickle&&x(r,n)}},d.pc.ontrack=function(e){if(Janus.log("Handling Remote Track"),Janus.debug(e),e.streams&&(d.remoteStream=e.streams[0],i.onremotestream(d.remoteStream),!e.track.onended)){if(d.receiverTransforms){var n=null;RTCRtpSender.prototype.createEncodedStreams?n=e.receiver.createEncodedStreams():(RTCRtpSender.prototype.createAudioEncodedStreams||RTCRtpSender.prototype.createEncodedVideoStreams)&&("audio"===e.track.kind&&d.receiverTransforms.audio?n=e.receiver.createEncodedAudioStreams():"video"===e.track.kind&&d.receiverTransforms.video&&(n=e.receiver.createEncodedVideoStreams())),n&&(console.log(n),n.readableStream&&n.writableStream?n.readableStream.pipeThrough(d.receiverTransforms[e.track.kind]).pipeTo(n.writableStream):n.readable&&n.writable&&n.readable.pipeThrough(d.receiverTransforms[e.track.kind]).pipeTo(n.writable))}var r=null;Janus.log("Adding onended callback to track:",e.track),e.track.onended=function(e){Janus.log("Remote track removed:",e),d.remoteStream&&(clearTimeout(r),d.remoteStream.removeTrack(e.target),i.onremotestream(d.remoteStream))},e.track.onmute=function(e){Janus.log("Remote track muted:",e),d.remoteStream&&null==r&&(r=setTimeout((function(){Janus.log("Removing remote track"),d.remoteStream&&(d.remoteStream.removeTrack(e.target),i.onremotestream(d.remoteStream)),r=null}),2520))},e.track.onunmute=function(e){if(Janus.log("Remote track flowing again:",e),null!=r)clearTimeout(r),r=null;else try{d.remoteStream.addTrack(e.target),i.onremotestream(d.remoteStream)}catch(e){Janus.error(e)}}}}}if(u&&s){Janus.log("Adding local stream");var D=!0===o.simulcast2;s.getTracks().forEach((function(e){Janus.log("Adding local track:",e);var n=null;if(D&&"audio"!==e.kind){Janus.log("Enabling rid-based simulcasting:",e);var r=w(o.simulcastMaxBitrates),a=d.pc.addTransceiver(e,{direction:"sendrecv",streams:[s],sendEncodings:o.sendEncodings||[{rid:"h",active:!0,maxBitrate:r.high},{rid:"m",active:!0,maxBitrate:r.medium,scaleResolutionDownBy:2},{rid:"l",active:!0,maxBitrate:r.low,scaleResolutionDownBy:4}]});a&&(n=a.sender)}else n=d.pc.addTrack(e,s);if(n&&d.senderTransforms){var t=null;RTCRtpSender.prototype.createEncodedStreams?t=n.createEncodedStreams():(RTCRtpSender.prototype.createAudioEncodedStreams||RTCRtpSender.prototype.createEncodedVideoStreams)&&("audio"===n.track.kind&&d.senderTransforms.audio?t=n.createEncodedAudioStreams():"video"===n.track.kind&&d.senderTransforms.video&&(t=n.createEncodedVideoStreams())),t&&(console.log(t),t.readableStream&&t.writableStream?t.readableStream.pipeThrough(d.senderTransforms[n.track.kind]).pipeTo(t.writableStream):t.readable&&t.writable&&t.readable.pipeThrough(d.senderTransforms[n.track.kind]).pipeTo(t.writable))}}))}(function(e){if(Janus.debug("isDataEnabled:",e),"edge"===Janus.webRTCAdapter.browserDetails.browser)return Janus.warn("Edge doesn't support data channels yet"),!1;return null!=e&&!0===e.data})(t)&&!d.dataChannel[Janus.dataChanDefaultLabel]&&(Janus.log("Creating default data channel"),j(r,Janus.dataChanDefaultLabel,null,!1),d.pc.ondatachannel=function(e){Janus.log("Data channel created by Janus:",e),j(r,e.channel.label,e.channel.protocol,e.channel)}),d.myStream&&i.onlocalstream(d.myStream),a?d.pc.setRemoteDescription(a).then((function(){if(Janus.log("Remote description accepted!"),d.remoteSdp=a.sdp,d.candidates&&d.candidates.length>0){for(var e=0;e<d.candidates.length;e++){var s=d.candidates[e];Janus.debug("Adding remote candidate:",s),s&&!0!==s.completed?d.pc.addIceCandidate(s):d.pc.addIceCandidate(Janus.endOfCandidates)}d.candidates=[]}!function(e,r,a){(a=a||{}).success="function"==typeof a.success?a.success:Janus.noop,a.error="function"==typeof a.error?a.error:Janus.noop,a.customizeSdp="function"==typeof a.customizeSdp?a.customizeSdp:Janus.noop;var t=k[e];if(!t||!t.webrtcStuff)return Janus.warn("Invalid handle"),void a.error("Invalid handle");var o=t.webrtcStuff,s=!0===a.simulcast;s?Janus.log("Creating answer (iceDone="+o.iceDone+", simulcast="+s+")"):Janus.log("Creating answer (iceDone="+o.iceDone+")");var i=null;if(Janus.unifiedPlan){i={};var d=null,u=null,c=o.pc.getTransceivers();if(c&&c.length>0){var l,f=n(c);try{for(f.s();!(l=f.n()).done;){var v=l.value;v.sender&&v.sender.track&&"audio"===v.sender.track.kind||v.receiver&&v.receiver.track&&"audio"===v.receiver.track.kind?d||(d=v):(v.sender&&v.sender.track&&"video"===v.sender.track.kind||v.receiver&&v.receiver.track&&"video"===v.receiver.track.kind)&&(u||(u=v))}}catch(e){f.e(e)}finally{f.f()}}var g=z(r),p=H(r);if(g||p){if(g&&p){if(d)try{d.setDirection?d.setDirection("sendrecv"):d.direction="sendrecv",Janus.log("Setting audio transceiver to sendrecv:",d)}catch(e){Janus.error(e)}}else if(g&&!p)try{d&&(d.setDirection?d.setDirection("sendonly"):d.direction="sendonly",Janus.log("Setting audio transceiver to sendonly:",d))}catch(e){Janus.error(e)}else if(!g&&p)if(d)try{d.setDirection?d.setDirection("recvonly"):d.direction="recvonly",Janus.log("Setting audio transceiver to recvonly:",d)}catch(e){Janus.error(e)}else d=o.pc.addTransceiver("audio",{direction:"recvonly"}),Janus.log("Adding recvonly audio transceiver:",d)}else if(r.removeAudio&&d)try{d.setDirection?d.setDirection("inactive"):d.direction="inactive",Janus.log("Setting audio transceiver to inactive:",d)}catch(e){Janus.error(e)}var m=Q(r),b=Y(r);if(m||b){if(m&&b){if(u)try{u.setDirection?u.setDirection("sendrecv"):u.direction="sendrecv",Janus.log("Setting video transceiver to sendrecv:",u)}catch(e){Janus.error(e)}}else if(m&&!b){if(u)try{u.setDirection?u.setDirection("sendonly"):u.direction="sendonly",Janus.log("Setting video transceiver to sendonly:",u)}catch(e){Janus.error(e)}}else if(!m&&b)if(u)try{u.setDirection?u.setDirection("recvonly"):u.direction="recvonly",Janus.log("Setting video transceiver to recvonly:",u)}catch(e){Janus.error(e)}else u=o.pc.addTransceiver("video",{direction:"recvonly"}),Janus.log("Adding recvonly video transceiver:",u)}else if(r.removeVideo&&u)try{u.setDirection?u.setDirection("inactive"):u.direction="inactive",Janus.log("Setting video transceiver to inactive:",u)}catch(e){Janus.error(e)}}else i="firefox"===Janus.webRTCAdapter.browserDetails.browser||"edge"===Janus.webRTCAdapter.browserDetails.browser?{offerToReceiveAudio:H(r),offerToReceiveVideo:Y(r)}:{mandatory:{OfferToReceiveAudio:H(r),OfferToReceiveVideo:Y(r)}};Janus.debug(i);var J=Q(r);if(J&&s&&"firefox"===Janus.webRTCAdapter.browserDetails.browser){Janus.log("Enabling Simulcasting for Firefox (RID)");var h=o.pc.getSenders()[1];Janus.log(h);var S=h.getParameters();Janus.log(S);var y=w(a.simulcastMaxBitrates);h.setParameters({encodings:a.sendEncodings||[{rid:"h",active:!0,maxBitrate:y.high},{rid:"m",active:!0,maxBitrate:y.medium,scaleResolutionDownBy:2},{rid:"l",active:!0,maxBitrate:y.low,scaleResolutionDownBy:4}]})}o.pc.createAnswer(i).then((function(e){Janus.debug(e);var n={type:e.type,sdp:e.sdp};a.customizeSdp(n),e.sdp=n.sdp,Janus.log("Setting local description"),J&&s&&("chrome"===Janus.webRTCAdapter.browserDetails.browser?Janus.warn("simulcast=true, but this is an answer, and video breaks in Chrome if we enable it"):"firefox"!==Janus.webRTCAdapter.browserDetails.browser&&Janus.warn("simulcast=true, but this is not Chrome nor Firefox, ignoring")),o.mySdp={type:"answer",sdp:e.sdp},o.pc.setLocalDescription(e).catch(a.error),o.mediaConstraints=i,o.iceDone||o.trickle?((o.senderTransforms||o.receiverTransforms)&&(e.e2ee=!0),a.success(e)):Janus.log("Waiting for all candidates...")}),a.error)}(r,t,o)}),o.error):function(e,r,a){(a=a||{}).success="function"==typeof a.success?a.success:Janus.noop,a.error="function"==typeof a.error?a.error:Janus.noop,a.customizeSdp="function"==typeof a.customizeSdp?a.customizeSdp:Janus.noop;var t=k[e];if(!t||!t.webrtcStuff)return Janus.warn("Invalid handle"),void a.error("Invalid handle");var o=t.webrtcStuff,s=!0===a.simulcast;s?Janus.log("Creating offer (iceDone="+o.iceDone+", simulcast="+s+")"):Janus.log("Creating offer (iceDone="+o.iceDone+")");var i={};if(Janus.unifiedPlan){var d=null,u=null,c=o.pc.getTransceivers();if(c&&c.length>0){var l,f=n(c);try{for(f.s();!(l=f.n()).done;){var v=l.value;v.sender&&v.sender.track&&"audio"===v.sender.track.kind||v.receiver&&v.receiver.track&&"audio"===v.receiver.track.kind?d||(d=v):(v.sender&&v.sender.track&&"video"===v.sender.track.kind||v.receiver&&v.receiver.track&&"video"===v.receiver.track.kind)&&(u||(u=v))}}catch(e){f.e(e)}finally{f.f()}}var g=z(r),p=H(r);g||p?g&&p?d&&(d.setDirection?d.setDirection("sendrecv"):d.direction="sendrecv",Janus.log("Setting audio transceiver to sendrecv:",d)):g&&!p?d&&(d.setDirection?d.setDirection("sendonly"):d.direction="sendonly",Janus.log("Setting audio transceiver to sendonly:",d)):!g&&p&&(d?(d.setDirection?d.setDirection("recvonly"):d.direction="recvonly",Janus.log("Setting audio transceiver to recvonly:",d)):(d=o.pc.addTransceiver("audio",{direction:"recvonly"}),Janus.log("Adding recvonly audio transceiver:",d))):r.removeAudio&&d&&(d.setDirection?d.setDirection("inactive"):d.direction="inactive",Janus.log("Setting audio transceiver to inactive:",d));var m=Q(r),b=Y(r);m||b?m&&b?u&&(u.setDirection?u.setDirection("sendrecv"):u.direction="sendrecv",Janus.log("Setting video transceiver to sendrecv:",u)):m&&!b?u&&(u.setDirection?u.setDirection("sendonly"):u.direction="sendonly",Janus.log("Setting video transceiver to sendonly:",u)):!m&&b&&(u?(u.setDirection?u.setDirection("recvonly"):u.direction="recvonly",Janus.log("Setting video transceiver to recvonly:",u)):(u=o.pc.addTransceiver("video",{direction:"recvonly"}),Janus.log("Adding recvonly video transceiver:",u))):r.removeVideo&&u&&(u.setDirection?u.setDirection("inactive"):u.direction="inactive",Janus.log("Setting video transceiver to inactive:",u))}else i.offerToReceiveAudio=H(r),i.offerToReceiveVideo=Y(r);!0===a.iceRestart&&(i.iceRestart=!0);Janus.debug(i);var J=Q(r);if(J&&s&&"firefox"===Janus.webRTCAdapter.browserDetails.browser){Janus.log("Enabling Simulcasting for Firefox (RID)");var h=o.pc.getSenders().find((function(e){return e.track&&"video"===e.track.kind}));if(h){var S=h.getParameters();S||(S={});var y=w(a.simulcastMaxBitrates);S.encodings=a.sendEncodings||[{rid:"h",active:!0,maxBitrate:y.high},{rid:"m",active:!0,maxBitrate:y.medium,scaleResolutionDownBy:2},{rid:"l",active:!0,maxBitrate:y.low,scaleResolutionDownBy:4}],h.setParameters(S)}}o.pc.createOffer(i).then((function(e){Janus.debug(e);var n={type:e.type,sdp:e.sdp};a.customizeSdp(n),e.sdp=n.sdp,Janus.log("Setting local description"),J&&s&&("chrome"===Janus.webRTCAdapter.browserDetails.browser||"safari"===Janus.webRTCAdapter.browserDetails.browser?(Janus.log("Enabling Simulcasting for Chrome (SDP munging)"),e.sdp=function(e){for(var n=e.split("\r\n"),r=!1,a=[-1],t=[-1],o=null,s=null,i=null,d=null,u=-1,c=0;c<n.length;c++){if(f=n[c].match(/m=(\w+) */)){if("video"===f[1]){if(!(a[0]<0)){u=c;break}r=!0}else if(a[0]>-1){u=c;break}}else if(r){if(n[c].match(/a=ssrc-group:SIM (\d+) (\d+) (\d+)/))return Janus.warn("The SDP already contains a SIM attribute, munging will be skipped"),e;var l=n[c].match(/a=ssrc-group:FID (\d+) (\d+)/);if(l)a[0]=l[1],t[0]=l[2],n.splice(c,1),c--;else{if(a[0]){if((g=n[c].match("a=ssrc:"+a[0]+" cname:(.+)"))&&(o=g[1]),(g=n[c].match("a=ssrc:"+a[0]+" msid:(.+)"))&&(s=g[1]),(g=n[c].match("a=ssrc:"+a[0]+" mslabel:(.+)"))&&(i=g[1]),(g=n[c].match("a=ssrc:"+a[0]+" label:(.+)"))&&(d=g[1]),0===n[c].indexOf("a=ssrc:"+t[0])){n.splice(c,1),c--;continue}if(0===n[c].indexOf("a=ssrc:"+a[0])){n.splice(c,1),c--;continue}}0!=n[c].length||(n.splice(c,1),c--)}}}if(a[0]<0){u=-1,r=!1;for(c=0;c<n.length;c++){var f;if(f=n[c].match(/m=(\w+) */)){if("video"===f[1]){if(!(a[0]<0)){u=c;break}r=!0}else if(a[0]>-1){u=c;break}}else if(r){if(a[0]<0){var v=n[c].match(/a=ssrc:(\d+)/);if(v){a[0]=v[1],n.splice(c,1),c--;continue}}else{var g;if((g=n[c].match("a=ssrc:"+a[0]+" cname:(.+)"))&&(o=g[1]),(g=n[c].match("a=ssrc:"+a[0]+" msid:(.+)"))&&(s=g[1]),(g=n[c].match("a=ssrc:"+a[0]+" mslabel:(.+)"))&&(i=g[1]),(g=n[c].match("a=ssrc:"+a[0]+" label:(.+)"))&&(d=g[1]),0===n[c].indexOf("a=ssrc:"+t[0])){n.splice(c,1),c--;continue}if(0===n[c].indexOf("a=ssrc:"+a[0])){n.splice(c,1),c--;continue}}0!==n[c].length||(n.splice(c,1),c--)}}}if(a[0]<0)return Janus.warn("Couldn't find the video SSRC, simulcasting NOT enabled"),e;u<0&&(u=n.length);a[1]=Math.floor(4294967295*Math.random()),a[2]=Math.floor(4294967295*Math.random()),t[1]=Math.floor(4294967295*Math.random()),t[2]=Math.floor(4294967295*Math.random());for(c=0;c<a.length;c++)o&&(n.splice(u,0,"a=ssrc:"+a[c]+" cname:"+o),u++),s&&(n.splice(u,0,"a=ssrc:"+a[c]+" msid:"+s),u++),i&&(n.splice(u,0,"a=ssrc:"+a[c]+" mslabel:"+i),u++),d&&(n.splice(u,0,"a=ssrc:"+a[c]+" label:"+d),u++),o&&(n.splice(u,0,"a=ssrc:"+t[c]+" cname:"+o),u++),s&&(n.splice(u,0,"a=ssrc:"+t[c]+" msid:"+s),u++),i&&(n.splice(u,0,"a=ssrc:"+t[c]+" mslabel:"+i),u++),d&&(n.splice(u,0,"a=ssrc:"+t[c]+" label:"+d),u++);n.splice(u,0,"a=ssrc-group:FID "+a[2]+" "+t[2]),n.splice(u,0,"a=ssrc-group:FID "+a[1]+" "+t[1]),n.splice(u,0,"a=ssrc-group:FID "+a[0]+" "+t[0]),n.splice(u,0,"a=ssrc-group:SIM "+a[0]+" "+a[1]+" "+a[2]),(e=n.join("\r\n")).endsWith("\r\n")||(e+="\r\n");return e}(e.sdp)):"firefox"!==Janus.webRTCAdapter.browserDetails.browser&&Janus.warn("simulcast=true, but this is not Chrome nor Firefox, ignoring")),o.mySdp={type:"offer",sdp:e.sdp},o.pc.setLocalDescription(e).catch(a.error),o.mediaConstraints=i,o.iceDone||o.trickle?((o.senderTransforms||o.receiverTransforms)&&(e.e2ee=!0),a.success(e)):Janus.log("Waiting for all candidates...")}),a.error)}(r,t,o)}function N(r,a,t){(t=t||{}).success="function"==typeof t.success?t.success:Janus.noop,t.error="function"==typeof t.error?t.error:B;var o=t.jsep;if(a&&o)return Janus.error("Provided a JSEP to a createOffer"),void t.error("Provided a JSEP to a createOffer");if(!(a||o&&o.type&&o.sdp))return Janus.error("A valid JSEP is required for createAnswer"),void t.error("A valid JSEP is required for createAnswer");t.media="object"===e(t.media)&&t.media?t.media:{audio:!0,video:!0};var s=t.media,i=k[r];if(!i||!i.webrtcStuff)return Janus.warn("Invalid handle"),void t.error("Invalid handle");var d,u=i.webrtcStuff;if(u.trickle=(d=t.trickle,Janus.debug("isTrickleEnabled:",d),!1!==d),u.pc){if(Janus.log("Updating existing media session"),s.update=!0,t.stream)t.stream!==u.myStream&&Janus.log("Renegotiation involves a new external stream");else{if(s.addAudio){if(s.keepAudio=!1,s.replaceAudio=!1,s.removeAudio=!1,s.audioSend=!0,u.myStream&&u.myStream.getAudioTracks()&&u.myStream.getAudioTracks().length)return Janus.error("Can't add audio stream, there already is one"),void t.error("Can't add audio stream, there already is one")}else s.removeAudio?(s.keepAudio=!1,s.replaceAudio=!1,s.addAudio=!1,s.audioSend=!1):s.replaceAudio&&(s.keepAudio=!1,s.addAudio=!1,s.removeAudio=!1,s.audioSend=!0);if(u.myStream&&u.myStream.getAudioTracks()&&0!==u.myStream.getAudioTracks().length?!z(s)||s.removeAudio||s.replaceAudio||(s.keepAudio=!0):(s.replaceAudio&&(s.keepAudio=!1,s.replaceAudio=!1,s.addAudio=!0,s.audioSend=!0),z(s)&&(s.keepAudio=!1,s.addAudio=!0)),s.addVideo){if(s.keepVideo=!1,s.replaceVideo=!1,s.removeVideo=!1,s.videoSend=!0,u.myStream&&u.myStream.getVideoTracks()&&u.myStream.getVideoTracks().length)return Janus.error("Can't add video stream, there already is one"),void t.error("Can't add video stream, there already is one")}else s.removeVideo?(s.keepVideo=!1,s.replaceVideo=!1,s.addVideo=!1,s.videoSend=!1):s.replaceVideo&&(s.keepVideo=!1,s.addVideo=!1,s.removeVideo=!1,s.videoSend=!0);u.myStream&&u.myStream.getVideoTracks()&&0!==u.myStream.getVideoTracks().length?!Q(s)||s.removeVideo||s.replaceVideo||(s.keepVideo=!0):(s.replaceVideo&&(s.keepVideo=!1,s.replaceVideo=!1,s.addVideo=!0,s.videoSend=!0),Q(s)&&(s.keepVideo=!1,s.addVideo=!0)),s.addData&&(s.data=!0)}if(z(s)&&s.keepAudio&&Q(s)&&s.keepVideo)return i.consentDialog(!1),void L(r,o,s,t,u.myStream)}else s.update=!1,s.keepAudio=!1,s.keepVideo=!1;if(s.update&&(!u.streamExternal||u.streamExternal&&(s.replaceAudio||s.replaceVideo))){if(s.removeAudio||s.replaceAudio){if(u.myStream&&u.myStream.getAudioTracks()&&u.myStream.getAudioTracks().length){var c=u.myStream.getAudioTracks()[0];Janus.log("Removing audio track:",c),u.myStream.removeTrack(c);try{c.stop()}catch(e){}}if(u.pc.getSenders()&&u.pc.getSenders().length){var l=!0;if(s.replaceAudio&&Janus.unifiedPlan&&(l=!1),l){var f,v=n(u.pc.getSenders());try{for(v.s();!(f=v.n()).done;){var g=f.value;g&&g.track&&"audio"===g.track.kind&&(Janus.log("Removing audio sender:",g),u.pc.removeTrack(g))}}catch(e){v.e(e)}finally{v.f()}}}}if(s.removeVideo||s.replaceVideo){if(u.myStream&&u.myStream.getVideoTracks()&&u.myStream.getVideoTracks().length){var p=u.myStream.getVideoTracks()[0];Janus.log("Removing video track:",p),u.myStream.removeTrack(p);try{p.stop()}catch(e){}}if(u.pc.getSenders()&&u.pc.getSenders().length){var m=!0;if(s.replaceVideo&&Janus.unifiedPlan&&(m=!1),m){var b,J=n(u.pc.getSenders());try{for(J.s();!(b=J.n()).done;){var h=b.value;h&&h.track&&"video"===h.track.kind&&(Janus.log("Removing video sender:",h),u.pc.removeTrack(h))}}catch(e){J.e(e)}finally{J.f()}}}}}if(t.stream){var w=t.stream;return Janus.log("MediaStream provided by the application"),Janus.debug(w),!s.update||!u.myStream||u.myStream===t.stream||u.streamExternal||s.replaceAudio||s.replaceVideo||(Janus.stopAllTracks(u.myStream),u.myStream=null),u.streamExternal=!0,i.consentDialog(!1),void L(r,o,s,t,w)}if(z(s)||Q(s)){if(!Janus.isGetUserMediaAvailable())return void t.error("getUserMedia not available");var S={mandatory:{},optional:[]};i.consentDialog(!0);var y=z(s);y&&s&&"object"===e(s.audio)&&(y=s.audio);var T=Q(s);if(T&&s){var C=!0===t.simulcast,A=!0===t.simulcast2;if(!C&&!A||o||s.video||(s.video="hires"),s.video&&"screen"!=s.video&&"window"!=s.video)if("object"===e(s.video))T=s.video;else{var D=0,R=0;"lowres"===s.video?(R=240,240,D=320):"lowres-16:9"===s.video?(R=180,180,D=320):"hires"===s.video||"hires-16:9"===s.video||"hdres"===s.video?(R=720,720,D=1280):"fhdres"===s.video?(R=1080,1080,D=1920):"4kres"===s.video?(R=2160,2160,D=3840):"stdres"===s.video?(R=480,480,D=640):"stdres-16:9"===s.video?(R=360,360,D=640):(Janus.log("Default video setting is stdres 4:3"),R=480,480,D=640),Janus.log("Adding media constraint:",s.video),T={height:{ideal:R},width:{ideal:D}},Janus.log("Adding video constraint:",T)}else if("screen"===s.video||"window"===s.video){var I=function(e,n){i.consentDialog(!1),e?t.error(e):L(r,o,s,t,n)},P=function(e,n,r){Janus.log("Adding media constraint (screen capture)"),Janus.debug(e),navigator.mediaDevices.getUserMedia(e).then((function(e){r?navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then((function(r){e.addTrack(r.getAudioTracks()[0]),n(null,e)})):n(null,e)})).catch((function(e){i.consentDialog(!1),n(e)}))};if(navigator.mediaDevices&&navigator.mediaDevices.getDisplayMedia)return S.video={},s.screenshareFrameRate&&(S.video.frameRate=s.screenshareFrameRate),s.screenshareHeight&&(S.video.height=s.screenshareHeight),s.screenshareWidth&&(S.video.width=s.screenshareWidth),S.audio=s.captureDesktopAudio,void navigator.mediaDevices.getDisplayMedia(S).then((function(e){i.consentDialog(!1),z(s)&&!s.keepAudio?navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then((function(n){e.addTrack(n.getAudioTracks()[0]),L(r,o,s,t,e)})):L(r,o,s,t,e)}),(function(e){i.consentDialog(!1),t.error(e)}));if("chrome"===Janus.webRTCAdapter.browserDetails.browser){var V=Janus.webRTCAdapter.browserDetails.version,x=33;window.navigator.userAgent.match("Linux")&&(x=35),V>=26&&V<=x?(S={video:{mandatory:{googLeakyBucket:!0,maxWidth:window.screen.width,maxHeight:window.screen.height,minFrameRate:s.screenshareFrameRate,maxFrameRate:s.screenshareFrameRate,chromeMediaSource:"screen"}},audio:z(s)&&!s.keepAudio},P(S,I)):Janus.extension.getScreen((function(e,n){if(e)return i.consentDialog(!1),t.error(e);(S={audio:!1,video:{mandatory:{chromeMediaSource:"desktop",maxWidth:window.screen.width,maxHeight:window.screen.height,minFrameRate:s.screenshareFrameRate,maxFrameRate:s.screenshareFrameRate},optional:[{googLeakyBucket:!0},{googTemporalLayeredScreencast:!0}]}}).video.mandatory.chromeMediaSourceId=n,P(S,I,z(s)&&!s.keepAudio)}))}else if("firefox"===Janus.webRTCAdapter.browserDetails.browser){if(!(Janus.webRTCAdapter.browserDetails.version>=33)){var j=new Error("NavigatorUserMediaError");return j.name="Your version of Firefox does not support screen sharing, please install Firefox 33 (or more recent versions)",i.consentDialog(!1),void t.error(j)}S={video:{mozMediaSource:s.video,mediaSource:s.video},audio:z(s)&&!s.keepAudio},P(S,(function(e,n){if(I(e,n),!e)var r=n.currentTime,a=window.setInterval((function(){n||window.clearInterval(a),n.currentTime==r&&(window.clearInterval(a),n.onended&&n.onended()),r=n.currentTime}),500)}))}return}}s&&"screen"===s.video||navigator.mediaDevices.enumerateDevices().then((function(n){var a=n.some((function(e){return"audioinput"===e.kind})),d=function(n){if(Janus.debug("isScreenSendEnabled:",n),!n)return!1;if("object"!==e(n.video)||"object"!==e(n.video.mandatory))return!1;var r=n.video.mandatory;if(r.chromeMediaSource)return"desktop"===r.chromeMediaSource||"screen"===r.chromeMediaSource;if(r.mozMediaSource)return"window"===r.mozMediaSource||"screen"===r.mozMediaSource;if(r.mediaSource)return"window"===r.mediaSource||"screen"===r.mediaSource;return!1}(s)||n.some((function(e){return"videoinput"===e.kind})),u=z(s),c=Q(s),l=function(e){return Janus.debug("isAudioSendRequired:",e),!!e&&(!1!==e.audio&&!1!==e.audioSend&&(void 0!==e.failIfNoAudio&&null!==e.failIfNoAudio&&!0===e.failIfNoAudio))}(s),f=function(e){return Janus.debug("isVideoSendRequired:",e),!!e&&(!1!==e.video&&!1!==e.videoSend&&(void 0!==e.failIfNoVideo&&null!==e.failIfNoVideo&&!0===e.failIfNoVideo))}(s);if(u||c||l||f){var v=!!u&&a,g=!!c&&d;if(!v&&!g)return i.consentDialog(!1),t.error("No capture device found"),!1;if(!v&&l)return i.consentDialog(!1),t.error("Audio capture is required, but no capture device found"),!1;if(!g&&f)return i.consentDialog(!1),t.error("Video capture is required, but no capture device found"),!1}var p={audio:!(!a||s.keepAudio)&&y,video:!(!d||s.keepVideo)&&T};Janus.debug("getUserMedia constraints",p),p.audio||p.video?navigator.mediaDevices.getUserMedia(p).then((function(e){i.consentDialog(!1),L(r,o,s,t,e)})).catch((function(e){i.consentDialog(!1),t.error({code:e.code,name:e.name,message:e.message})})):(i.consentDialog(!1),L(r,o,s,t,w))})).catch((function(e){i.consentDialog(!1),t.error(e)}))}else L(r,o,s,t)}function F(e,n){(n=n||{}).success="function"==typeof n.success?n.success:Janus.noop,n.error="function"==typeof n.error?n.error:B,n.customizeSdp="function"==typeof n.customizeSdp?n.customizeSdp:Janus.noop;var r=n.jsep,a=k[e];if(!a||!a.webrtcStuff)return Janus.warn("Invalid handle"),void n.error("Invalid handle");var t=a.webrtcStuff;if(r){if(!t.pc)return Janus.warn("Wait, no PeerConnection?? if this is an answer, use createAnswer and not handleRemoteJsep"),void n.error("No PeerConnection: if this is an answer, use createAnswer and not handleRemoteJsep");n.customizeSdp(r),t.pc.setRemoteDescription(r).then((function(){if(Janus.log("Remote description accepted!"),t.remoteSdp=r.sdp,t.candidates&&t.candidates.length>0){for(var e=0;e<t.candidates.length;e++){var a=t.candidates[e];Janus.debug("Adding remote candidate:",a),a&&!0!==a.completed?t.pc.addIceCandidate(a):t.pc.addIceCandidate(Janus.endOfCandidates)}t.candidates=[]}n.success()}),n.error)}else n.error("Invalid JSEP")}function U(e,n){var r=k[e];if(!r||!r.webrtcStuff)return Janus.warn("Invalid handle"),0;var a=n?"remote":"local",t=r.webrtcStuff;return t.volume[a]||(t.volume[a]={value:0}),!t.pc.getStats||"chrome"!==Janus.webRTCAdapter.browserDetails.browser&&"safari"!==Janus.webRTCAdapter.browserDetails.browser?(Janus.warn("Getting the "+a+" volume unsupported by browser"),0):n&&!t.remoteStream?(Janus.warn("Remote stream unavailable"),0):n||t.myStream?t.volume[a].timer?t.volume[a].value:(Janus.log("Starting "+a+" volume monitor"),t.volume[a].timer=setInterval((function(){t.pc.getStats().then((function(e){e.forEach((function(e){e&&"audio"===e.kind&&(n&&!e.remoteSource||!n&&"media-source"!==e.type||(t.volume[a].value=e.audioLevel?e.audioLevel:0))}))}))}),200),0):(Janus.warn("Local stream unavailable"),0)}function W(e,n){var r=k[e];if(!r||!r.webrtcStuff)return Janus.warn("Invalid handle"),!0;var a=r.webrtcStuff;return a.pc?a.myStream?n?a.myStream.getVideoTracks()&&0!==a.myStream.getVideoTracks().length?!a.myStream.getVideoTracks()[0].enabled:(Janus.warn("No video track"),!0):a.myStream.getAudioTracks()&&0!==a.myStream.getAudioTracks().length?!a.myStream.getAudioTracks()[0].enabled:(Janus.warn("No audio track"),!0):(Janus.warn("Invalid local MediaStream"),!0):(Janus.warn("Invalid PeerConnection"),!0)}function _(e,n,r){var a=k[e];if(!a||!a.webrtcStuff)return Janus.warn("Invalid handle"),!1;var t=a.webrtcStuff;return t.pc?t.myStream?n?t.myStream.getVideoTracks()&&0!==t.myStream.getVideoTracks().length?(t.myStream.getVideoTracks()[0].enabled=!r,!0):(Janus.warn("No video track"),!1):t.myStream.getAudioTracks()&&0!==t.myStream.getAudioTracks().length?(t.myStream.getAudioTracks()[0].enabled=!r,!0):(Janus.warn("No audio track"),!1):(Janus.warn("Invalid local MediaStream"),!1):(Janus.warn("Invalid PeerConnection"),!1)}function G(e){var n=k[e];if(!n||!n.webrtcStuff)return Janus.warn("Invalid handle"),"Invalid handle";var r=n.webrtcStuff;return r.pc?r.pc.getStats?r.bitrate.timer?r.bitrate.value:(Janus.log("Starting bitrate timer (via getStats)"),r.bitrate.timer=setInterval((function(){r.pc.getStats().then((function(e){e.forEach((function(e){if(e){var n=!1;if(("video"===e.mediaType||e.id.toLowerCase().indexOf("video")>-1)&&"inbound-rtp"===e.type&&e.id.indexOf("rtcp")<0?n=!0:"ssrc"!=e.type||!e.bytesReceived||"VP8"!==e.googCodecName&&""!==e.googCodecName||(n=!0),n)if(r.bitrate.bsnow=e.bytesReceived,r.bitrate.tsnow=e.timestamp,null===r.bitrate.bsbefore||null===r.bitrate.tsbefore)r.bitrate.bsbefore=r.bitrate.bsnow,r.bitrate.tsbefore=r.bitrate.tsnow;else{var a=r.bitrate.tsnow-r.bitrate.tsbefore;"safari"===Janus.webRTCAdapter.browserDetails.browser&&(a/=1e3);var t=Math.round(8*(r.bitrate.bsnow-r.bitrate.bsbefore)/a);"safari"===Janus.webRTCAdapter.browserDetails.browser&&(t=parseInt(t/1e3)),r.bitrate.value=t+" kbits/sec",r.bitrate.bsbefore=r.bitrate.bsnow,r.bitrate.tsbefore=r.bitrate.tsnow}}}))}))}),1e3),"0 kbits/sec"):(Janus.warn("Getting the video bitrate unsupported by browser"),"Feature unsupported by browser"):"Invalid PeerConnection"}function B(e){Janus.error("WebRTC error:",e)}function q(e,n){Janus.log("Cleaning WebRTC stuff");var r=k[e];if(r){var o=r.webrtcStuff;if(o){if(!0===n){var s={janus:"hangup",transaction:Janus.randomString(12)};r.token&&(s.token=r.token),b&&(s.apisecret=b),Janus.debug("Sending hangup request (handle="+e+"):"),Janus.debug(s),a?(s.session_id=y,s.handle_id=e,t.send(JSON.stringify(s))):Janus.httpAPICall(u+"/"+y+"/"+e,{verb:"POST",withCredentials:g,body:s})}o.remoteStream=null,o.volume&&(o.volume.local&&o.volume.local.timer&&clearInterval(o.volume.local.timer),o.volume.remote&&o.volume.remote.timer&&clearInterval(o.volume.remote.timer)),o.volume={},o.bitrate.timer&&clearInterval(o.bitrate.timer),o.bitrate.timer=null,o.bitrate.bsnow=null,o.bitrate.bsbefore=null,o.bitrate.tsnow=null,o.bitrate.tsbefore=null,o.bitrate.value=null,!o.streamExternal&&o.myStream&&(Janus.log("Stopping local stream tracks"),Janus.stopAllTracks(o.myStream)),o.streamExternal=!1,o.myStream=null;try{o.pc.close()}catch(e){}o.pc=null,o.candidates=null,o.mySdp=null,o.remoteSdp=null,o.iceDone=!1,o.dataChannel={},o.dtmfSender=null,o.senderTransforms=null,o.receiverTransforms=null}r.oncleanup()}}function z(e){return Janus.debug("isAudioSendEnabled:",e),!e||!1!==e.audio&&(void 0===e.audioSend||null===e.audioSend||!0===e.audioSend)}function H(e){return Janus.debug("isAudioRecvEnabled:",e),!e||!1!==e.audio&&(void 0===e.audioRecv||null===e.audioRecv||!0===e.audioRecv)}function Q(e){return Janus.debug("isVideoSendEnabled:",e),!e||!1!==e.video&&(void 0===e.videoSend||null===e.videoSend||!0===e.videoSend)}function Y(e){return Janus.debug("isVideoRecvEnabled:",e),!e||!1!==e.video&&(void 0===e.videoRecv||null===e.videoRecv||!0===e.videoRecv)}P(r),this.getServer=function(){return u},this.isConnected=function(){return S},this.reconnect=function(e){(e=e||{}).success="function"==typeof e.success?e.success:Janus.noop,e.error="function"==typeof e.error?e.error:Janus.noop,e.reconnect=!0,P(e)},this.getSessionId=function(){return y},this.getInfo=function(e){!function(e){if((e=e||{}).success="function"==typeof e.success?e.success:Janus.noop,e.error="function"==typeof e.error?e.error:Janus.noop,Janus.log("Getting info on Janus instance"),!S)return Janus.warn("Is the server down? (connected=false)"),void e.error("Is the server down? (connected=false)");var n=Janus.randomString(12),r={janus:"info",transaction:n};m&&(r.token=m);b&&(r.apisecret=b);if(a)return A[n]=function(n){Janus.log("Server info:"),Janus.debug(n),"server_info"!==n.janus&&Janus.error("Ooops: "+n.error.code+" "+n.error.reason),e.success(n)},void t.send(JSON.stringify(r));Janus.httpAPICall(u,{verb:"POST",withCredentials:g,body:r,success:function(n){Janus.log("Server info:"),Janus.debug(n),"server_info"!==n.janus&&Janus.error("Ooops: "+n.error.code+" "+n.error.reason),e.success(n)},error:function(n,r){Janus.error(n+":",r),""===r?e.error(n+": Is the server down?"):e.error(n+": "+r)}})}(e)},this.destroy=function(e){!function(e){(e=e||{}).success="function"==typeof e.success?e.success:Janus.noop,e.error="function"==typeof e.error?e.error:Janus.noop;var n=!0===e.unload,i=!0;void 0!==e.notifyDestroyed&&null!==e.notifyDestroyed&&(i=!0===e.notifyDestroyed);var d=!0===e.cleanupHandles;if(Janus.log("Destroying session "+y+" (unload="+n+")"),!y)return Janus.warn("No session to destroy"),e.success(),void(i&&r.destroyed());if(d)for(var c in k)O(c,{noRequest:!0});if(!S)return Janus.warn("Is the server down? (connected=false)"),y=null,void e.success();var l={janus:"destroy",transaction:Janus.randomString(12)};m&&(l.token=m);b&&(l.apisecret=b);if(n)return a?(t.onclose=null,t.close(),t=null):navigator.sendBeacon(u+"/"+y,JSON.stringify(l)),Janus.log("Destroyed session:"),y=null,S=!1,e.success(),void(i&&r.destroyed());if(a){l.session_id=y;var f=function(){for(var e in o)t.removeEventListener(e,o[e]);t.removeEventListener("message",v),t.removeEventListener("error",p),s&&clearTimeout(s),t.close()},v=function(n){var a=JSON.parse(n.data);a.session_id==l.session_id&&a.transaction==l.transaction&&(f(),e.success(),i&&r.destroyed())},p=function(n){f(),e.error("Failed to destroy the server: Is the server down?"),i&&r.destroyed()};return t.addEventListener("message",v),t.addEventListener("error",p),void(1===t.readyState?t.send(JSON.stringify(l)):p())}Janus.httpAPICall(u+"/"+y,{verb:"POST",withCredentials:g,body:l,success:function(n){Janus.log("Destroyed session:"),Janus.debug(n),y=null,S=!1,"success"!==n.janus&&Janus.error("Ooops: "+n.error.code+" "+n.error.reason),e.success(),i&&r.destroyed()},error:function(n,a){Janus.error(n+":",a),y=null,S=!1,e.success(),i&&r.destroyed()}})}(e)},this.attach=function(e){!function(e){if((e=e||{}).success="function"==typeof e.success?e.success:Janus.noop,e.error="function"==typeof e.error?e.error:Janus.noop,e.consentDialog="function"==typeof e.consentDialog?e.consentDialog:Janus.noop,e.iceState="function"==typeof e.iceState?e.iceState:Janus.noop,e.mediaState="function"==typeof e.mediaState?e.mediaState:Janus.noop,e.webrtcState="function"==typeof e.webrtcState?e.webrtcState:Janus.noop,e.slowLink="function"==typeof e.slowLink?e.slowLink:Janus.noop,e.onmessage="function"==typeof e.onmessage?e.onmessage:Janus.noop,e.onlocalstream="function"==typeof e.onlocalstream?e.onlocalstream:Janus.noop,e.onremotestream="function"==typeof e.onremotestream?e.onremotestream:Janus.noop,e.ondata="function"==typeof e.ondata?e.ondata:Janus.noop,e.ondataopen="function"==typeof e.ondataopen?e.ondataopen:Janus.noop,e.oncleanup="function"==typeof e.oncleanup?e.oncleanup:Janus.noop,e.ondetached="function"==typeof e.ondetached?e.ondetached:Janus.noop,!S)return Janus.warn("Is the server down? (connected=false)"),void e.error("Is the server down? (connected=false)");var n=e.plugin;if(!n)return Janus.error("Invalid plugin"),void e.error("Invalid plugin");var r=e.opaqueId,o=e.loopIndex,s=e.token?e.token:m,i=Janus.randomString(12),d={janus:"attach",plugin:n,opaque_id:r,loop_index:o,transaction:i};s&&(d.token=s);b&&(d.apisecret=b);if(a)return A[i]=function(r){if(Janus.debug(r),"success"!==r.janus)return Janus.error("Ooops: "+r.error.code+" "+r.error.reason),void e.error("Ooops: "+r.error.code+" "+r.error.reason);var a=r.data.id;Janus.log("Created handle: "+a);var t={session:T,plugin:n,id:a,token:s,detached:!1,webrtcStuff:{started:!1,myStream:null,streamExternal:!1,remoteStream:null,mySdp:null,mediaConstraints:null,pc:null,dataChannel:{},dtmfSender:null,trickle:!0,iceDone:!1,volume:{value:null,timer:null},bitrate:{value:null,bsnow:null,bsbefore:null,tsnow:null,tsbefore:null,timer:null}},getId:function(){return a},getPlugin:function(){return n},getVolume:function(){return U(a,!0)},getRemoteVolume:function(){return U(a,!0)},getLocalVolume:function(){return U(a,!1)},isAudioMuted:function(){return W(a,!1)},muteAudio:function(){return _(a,!1,!0)},unmuteAudio:function(){return _(a,!1,!1)},isVideoMuted:function(){return W(a,!0)},muteVideo:function(){return _(a,!0,!0)},unmuteVideo:function(){return _(a,!0,!1)},getBitrate:function(){return G(a)},send:function(e){V(a,e)},data:function(e){E(a,e)},dtmf:function(e){M(a,e)},consentDialog:e.consentDialog,iceState:e.iceState,mediaState:e.mediaState,webrtcState:e.webrtcState,slowLink:e.slowLink,onmessage:e.onmessage,createOffer:function(e){N(a,!0,e)},createAnswer:function(e){N(a,!1,e)},handleRemoteJsep:function(e){F(a,e)},onlocalstream:e.onlocalstream,onremotestream:e.onremotestream,ondata:e.ondata,ondataopen:e.ondataopen,oncleanup:e.oncleanup,ondetached:e.ondetached,hangup:function(e){q(a,!0===e)},detach:function(e){O(a,e)}};k[a]=t,e.success(t)},d.session_id=y,void t.send(JSON.stringify(d));Janus.httpAPICall(u+"/"+y,{verb:"POST",withCredentials:g,body:d,success:function(r){if(Janus.debug(r),"success"!==r.janus)return Janus.error("Ooops: "+r.error.code+" "+r.error.reason),void e.error("Ooops: "+r.error.code+" "+r.error.reason);var a=r.data.id;Janus.log("Created handle: "+a);var t={session:T,plugin:n,id:a,token:s,detached:!1,webrtcStuff:{started:!1,myStream:null,streamExternal:!1,remoteStream:null,mySdp:null,mediaConstraints:null,pc:null,dataChannel:{},dtmfSender:null,trickle:!0,iceDone:!1,volume:{value:null,timer:null},bitrate:{value:null,bsnow:null,bsbefore:null,tsnow:null,tsbefore:null,timer:null}},getId:function(){return a},getPlugin:function(){return n},getVolume:function(){return U(a,!0)},getRemoteVolume:function(){return U(a,!0)},getLocalVolume:function(){return U(a,!1)},isAudioMuted:function(){return W(a,!1)},muteAudio:function(){return _(a,!1,!0)},unmuteAudio:function(){return _(a,!1,!1)},isVideoMuted:function(){return W(a,!0)},muteVideo:function(){return _(a,!0,!0)},unmuteVideo:function(){return _(a,!0,!1)},getBitrate:function(){return G(a)},send:function(e){V(a,e)},data:function(e){E(a,e)},dtmf:function(e){M(a,e)},consentDialog:e.consentDialog,iceState:e.iceState,mediaState:e.mediaState,webrtcState:e.webrtcState,slowLink:e.slowLink,onmessage:e.onmessage,createOffer:function(e){N(a,!0,e)},createAnswer:function(e){N(a,!1,e)},handleRemoteJsep:function(e){F(a,e)},onlocalstream:e.onlocalstream,onremotestream:e.onremotestream,ondata:e.ondata,ondataopen:e.ondataopen,oncleanup:e.oncleanup,ondetached:e.ondetached,hangup:function(e){q(a,!0===e)},detach:function(e){O(a,e)}};k[a]=t,e.success(t)},error:function(n,r){Janus.error(n+":",r),""===r?e.error(n+": Is the server down?"):e.error(n+": "+r)}})}(e)}},window.Janus.sessions={},window.Janus.isExtensionEnabled=function(){if(navigator.mediaDevices&&navigator.mediaDevices.getDisplayMedia)return!0;if(window.navigator.userAgent.match("Chrome")){var e=parseInt(window.navigator.userAgent.match(/Chrome\/(.*) /)[1],10),n=33;return window.navigator.userAgent.match("Linux")&&(n=35),e>=26&&e<=n||Janus.extension.isInstalled()}return!0};var a={extensionId:"hapfgfdkleiggjjpfpenajgdnfckjpaj",isInstalled:function(){return null!==document.querySelector("#janus-extension-installed")},getScreen:function(e){var n=window.setTimeout((function(){var n=new Error("NavigatorUserMediaError");return n.name='The required Chrome extension is not installed: click <a href="#">here</a> to install it. (NOTE: this will need you to refresh the page)',e(n)}),1e3);this.cache[n]=e,window.postMessage({type:"janusGetScreen",id:n},"*")},init:function(){var e={};this.cache=e,window.addEventListener("message",(function(n){if(n.origin==window.location.origin)if("janusGotScreen"==n.data.type&&e[n.data.id]){var r=e[n.data.id];if(delete e[n.data.id],""===n.data.sourceId){var a=new Error("NavigatorUserMediaError");a.name="You cancelled the request for permission, giving up...",r(a)}else r(null,n.data.sourceId)}else"janusGetScreenPending"==n.data.type&&(console.log("clearing ",n.data.id),window.clearTimeout(n.data.id))}))}};window.Janus.useDefaultDependencies=function(n){var r=n&&n.fetch||fetch,t=n&&n.Promise||Promise,o=n&&n.WebSocket||WebSocket;return{newWebSocket:function(e,n){return new o(e,n)},extension:n&&n.extension||a,isArray:function(e){return Array.isArray(e)},webRTCAdapter:n&&n.adapter||adapter,httpAPICall:function(n,a){var o={method:a.verb,headers:{Accept:"application/json, text/plain, */*"},cache:"no-cache"};"POST"===a.verb&&(o.headers["Content-Type"]="application/json"),void 0!==a.withCredentials&&(o.credentials=!0===a.withCredentials?"include":a.withCredentials?a.withCredentials:"omit"),a.body&&(o.body=JSON.stringify(a.body));var s=r(n,o).catch((function(e){return t.reject({message:"Probably a network error, is the server down?",error:e})}));if(a.timeout){var i=new t((function(e,n){var r=setTimeout((function(){return clearTimeout(r),n({message:"Request timed out",timeout:a.timeout})}),a.timeout)}));s=t.race([s,i])}return s.then((function(n){return n.ok?e(a.success)===e(Janus.noop)?n.json().then((function(e){try{a.success(e)}catch(e){Janus.error("Unhandled httpAPICall success callback error",e)}}),(function(e){return t.reject({message:"Failed to parse response body",error:e,response:n})})):void 0:t.reject({message:"API call failed",response:n})})).catch((function(n){e(a.error)===e(Janus.noop)&&a.error(n.message||"<< internal error >>",n)})),s}}},window.Janus.useOldDependencies=function(n){var r=n&&n.jQuery||jQuery,t=n&&n.WebSocket||WebSocket;return{newWebSocket:function(e,n){return new t(e,n)},isArray:function(e){return r.isArray(e)},extension:n&&n.extension||a,webRTCAdapter:n&&n.adapter||adapter,httpAPICall:function(n,a){var t=void 0!==a.body?{contentType:"application/json",data:JSON.stringify(a.body)}:{},o=void 0!==a.withCredentials?{xhrFields:{withCredentials:a.withCredentials}}:{};return r.ajax(r.extend(t,o,{url:n,type:a.verb,cache:!1,dataType:"json",async:a.async,timeout:a.timeout,success:function(n){e(a.success)===e(Janus.noop)&&a.success(n)},error:function(n,r,t){e(a.error)===e(Janus.noop)&&a.error(r,t)}}))}}},window.Janus.noop=function(){},window.Janus.dataChanDefaultLabel="JanusDataChannel",window.Janus.endOfCandidates=null,window.Janus.stopAllTracks=function(e){try{var r,a=n(e.getTracks());try{for(a.s();!(r=a.n()).done;){var t=r.value;Janus.log(t),t&&t.stop()}}catch(e){a.e(e)}finally{a.f()}}catch(e){}},window.Janus.init=function(e){if((e=e||{}).callback="function"==typeof e.callback?e.callback:Janus.noop,Janus.initDone)e.callback();else{if("undefined"!=typeof console&&void 0!==console.log||(console={log:function(){}}),Janus.trace=Janus.noop,Janus.debug=Janus.noop,Janus.vdebug=Janus.noop,Janus.log=Janus.noop,Janus.warn=Janus.noop,Janus.error=Janus.noop,!0===e.debug||"all"===e.debug)Janus.trace=console.trace.bind(console),Janus.debug=console.debug.bind(console),Janus.vdebug=console.debug.bind(console),Janus.log=console.log.bind(console),Janus.warn=console.warn.bind(console),Janus.error=console.error.bind(console);else if(Array.isArray(e.debug)){var r,a=n(e.debug);try{for(a.s();!(r=a.n()).done;){var t=r.value;switch(t){case"trace":Janus.trace=console.trace.bind(console);break;case"debug":Janus.debug=console.debug.bind(console);break;case"vdebug":Janus.vdebug=console.debug.bind(console);break;case"log":Janus.log=console.log.bind(console);break;case"warn":Janus.warn=console.warn.bind(console);break;case"error":Janus.error=console.error.bind(console);break;default:console.error("Unknown debugging option '"+t+"' (supported: 'trace', 'debug', 'vdebug', 'log', warn', 'error')")}}}catch(e){a.e(e)}finally{a.f()}}Janus.log("Initializing library");var o=e.dependencies||Janus.useDefaultDependencies();Janus.isArray=o.isArray,Janus.webRTCAdapter=o.webRTCAdapter,Janus.httpAPICall=o.httpAPICall,Janus.newWebSocket=o.newWebSocket,Janus.extension=o.extension,Janus.extension.init(),Janus.listDevices=function(e,n){e="function"==typeof e?e:Janus.noop,null==n&&(n={audio:!0,video:!0}),Janus.isGetUserMediaAvailable()?navigator.mediaDevices.getUserMedia(n).then((function(n){navigator.mediaDevices.enumerateDevices().then((function(r){Janus.debug(r),e(r),Janus.stopAllTracks(n)}))})).catch((function(n){Janus.error(n),e([])})):(Janus.warn("navigator.mediaDevices unavailable"),e([]))},Janus.attachMediaStream=function(e,n){try{e.srcObject=n}catch(r){try{e.src=URL.createObjectURL(n)}catch(e){Janus.error("Error attaching stream to element")}}},Janus.reattachMediaStream=function(e,n){try{e.srcObject=n.srcObject}catch(r){try{e.src=n.src}catch(e){Janus.error("Error reattaching stream to element")}}};var s=["iPad","iPhone","iPod"].indexOf(navigator.platform)>=0?"pagehide":"beforeunload",i=window["on"+s];if(window.addEventListener(s,(function(e){for(var n in Janus.log("Closing window"),Janus.sessions)Janus.sessions[n]&&Janus.sessions[n].destroyOnUnload&&(Janus.log("Destroying session "+n),Janus.sessions[n].destroy({unload:!0,notifyDestroyed:!1}));i&&"function"==typeof i&&i()})),Janus.safariVp8=!1,"safari"===Janus.webRTCAdapter.browserDetails.browser&&Janus.webRTCAdapter.browserDetails.version>=605)if(RTCRtpSender&&RTCRtpSender.getCapabilities&&RTCRtpSender.getCapabilities("video")&&RTCRtpSender.getCapabilities("video").codecs&&RTCRtpSender.getCapabilities("video").codecs.length){var d,u=n(RTCRtpSender.getCapabilities("video").codecs);try{for(u.s();!(d=u.n()).done;){var c=d.value;if(c&&c.mimeType&&"video/vp8"===c.mimeType.toLowerCase()){Janus.safariVp8=!0;break}}}catch(e){u.e(e)}finally{u.f()}Janus.safariVp8?Janus.log("This version of Safari supports VP8"):Janus.warn("This version of Safari does NOT support VP8: if you're using a Technology Preview, try enabling the 'WebRTC VP8 codec' setting in the 'Experimental Features' Develop menu")}else{var l=new RTCPeerConnection({});l.createOffer({offerToReceiveVideo:!0}).then((function(e){Janus.safariVp8=-1!==e.sdp.indexOf("VP8"),Janus.safariVp8?Janus.log("This version of Safari supports VP8"):Janus.warn("This version of Safari does NOT support VP8: if you're using a Technology Preview, try enabling the 'WebRTC VP8 codec' setting in the 'Experimental Features' Develop menu"),l.close(),l=null}))}if(Janus.unifiedPlan=!1,"firefox"===Janus.webRTCAdapter.browserDetails.browser&&Janus.webRTCAdapter.browserDetails.version>=59)Janus.unifiedPlan=!0;else if("chrome"===Janus.webRTCAdapter.browserDetails.browser&&Janus.webRTCAdapter.browserDetails.version>=72)Janus.unifiedPlan=!0;else if(window.RTCRtpTransceiver&&"currentDirection"in RTCRtpTransceiver.prototype){var f=new RTCPeerConnection;try{f.addTransceiver("audio"),Janus.unifiedPlan=!0}catch(e){}f.close()}else Janus.unifiedPlan=!1;Janus.initDone=!0,e.callback()}},window.Janus.isWebrtcSupported=function(){return!!window.RTCPeerConnection},window.Janus.isGetUserMediaAvailable=function(){return navigator.mediaDevices&&navigator.mediaDevices.getUserMedia},window.Janus.randomString=function(e){for(var n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",r="",a=0;a<e;a++){var t=Math.floor(Math.random()*n.length);r+=n.substring(t,t+1)}return r}}},n={};function r(a){var t=n[a];if(void 0!==t)return t.exports;var o=n[a]={exports:{}};return e[a](o,o.exports,r),o.exports}r(69),r(329)})();