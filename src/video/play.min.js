var Skylynx=function(){this.debug=false;this.init=function(opts){this.errorCallback=opts.errorCallback;var debug=this.debug=opts.debug;var stopStream=this.stopStream;var logger=this.log;var error=this.error;var skyObject=this;var videoObj=$("#"+opts.videoObject);Janus.init({debug:debug?"all":false,callback:function(){if(!Janus.isWebrtcSupported()){error("No WebRTC support... ",opts.errorCallback);return}skyObject.janus=new Janus({server:opts.server,success:function(){skyObject.janus.attach({plugin:"janus.plugin.streaming",opaqueId:"streaming-"+Janus.randomString(12),success:function(pluginHandle){skyObject.streaming=pluginHandle;logger("Plugin attached! ("+skyObject.streaming.getPlugin()+", id="+skyObject.streaming.getId()+")");opts.successCallback()},error:function(error){error("  -- Error attaching plugin... ",opts.errorCallback)},iceState:function(state){logger("ICE state changed to "+state)},webrtcState:function(on){logger("Janus says our WebRTC PeerConnection is "+(on?"up":"down")+" now")},onmessage:function(msg,jsep){logger(" ::: Got a message :::",msg);var result=msg["result"];if(result){if(result["status"]){var status=result["status"];if(status==="starting"){logger("starting")}else if(status==="started"){logger("started")}else if(status==="stopped"){logger("stopped");stopStream(skyObject)}}else if(msg["streaming"]==="event"){var substream=result["substream"];var temporal=result["temporal"];var spatial=result["spatial_layer"];temporal=result["temporal_layer"];if(spatial!==null&&spatial!==undefined||temporal!==null&&temporal!==undefined){if(!svcStarted){svcStarted=true}}}}else if(msg["error"]){error(msg["error"],opts.errorCallback);stopStream(skyObject);return}if(jsep){logger("Handling SDP as well...",jsep);var stereo=jsep.sdp.indexOf("stereo=1")!==-1;skyObject.streaming.createAnswer({jsep:jsep,media:{audioSend:false,videoSend:false,data:true},customizeSdp:function(jsep){if(stereo&&jsep.sdp.indexOf("stereo=1")==-1){jsep.sdp=jsep.sdp.replace("useinbandfec=1","useinbandfec=1;stereo=1")}},success:function(jsep){logger("Got SDP!",jsep);var body={request:"start"};skyObject.streaming.send({message:body,jsep:jsep})},error:function(error){Janus.error("WebRTC error:",error);error("WebRTC error:"+error,opts.errorCallback)}})}},onremotestream:function(stream,stream_type){if(videoObj.length===0){error("HTML video object not found!",opts.errorCallback);return}if(stream_type){opts.startedCallback(stream_type)}Janus.attachMediaStream(videoObj.get(0),stream);var videoTracks=stream.getVideoTracks();if(!videoTracks||videoTracks.length===0){setTimeout(function(){var videoTracks=stream.getVideoTracks();if(!videoTracks||videoTracks.length===0){error("No remote video available!",opts.errorCallback)}},1e4)}},ondataopen:function(data){Janus.log("The DataChannel is available!")},ondata:function(data){logger("We got data from the DataChannel!",data)},oncleanup:function(){logger("oncleanup")}})},error:function(error){console.error(error)},destroyed:function(){logger("destroyed")}})}})};this.start=function(mountPointId,pin){this.startStream(mountPointId,pin,this)};this.startStream=function(mountPointId,pin,skyObject){if(!mountPointId)return false;var body={request:"watch",id:mountPointId,pin:pin};skyObject.streaming.send({message:body})};this.play=function(video){var playPromise=video.play();playPromise.then(_=>{this.log("Stream started!")}).catch(error=>{this.error("Error: "+error,this.errorCallback)})};this.stopStream=function(skyObject){skyObject.streaming.send({message:{request:"stop"}});skyObject.streaming.hangup()};this.stop=function(){this.stopStream(this)};this.log=function(msg){if(this.debug){console.log(msg)}};this.error=function(msg,errorCallback){console.error(msg);if(errorCallback){errorCallback(msg)}}};