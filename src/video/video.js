Janus.sessions={},Janus.isExtensionEnabled=function(){if(navigator.mediaDevices&&navigator.mediaDevices.getDisplayMedia)return!0;if(window.navigator.userAgent.match("Chrome")){var e=parseInt(window.navigator.userAgent.match(/Chrome\/(.*) /)[1],10),n=33;return window.navigator.userAgent.match("Linux")&&(n=35),e>=26&&e<=n||Janus.extension.isInstalled()}return!0};var defaultExtension={extensionId:"hapfgfdkleiggjjpfpenajgdnfckjpaj",isInstalled:function(){return null!==document.querySelector("#janus-extension-installed")},getScreen:function(e){var n=window.setTimeout(function(){var n=new Error("NavigatorUserMediaError");return n.name='The required Chrome extension is not installed: click <a href="#">here</a> to install it. (NOTE: this will need you to refresh the page)',e(n)},1e3);this.cache[n]=e,window.postMessage({type:"janusGetScreen",id:n},"*")},init:function(){var e={};this.cache=e,window.addEventListener("message",function(n){if(n.origin==window.location.origin)if("janusGotScreen"==n.data.type&&e[n.data.id]){var r=e[n.data.id];if(delete e[n.data.id],""===n.data.sourceId){var a=new Error("NavigatorUserMediaError");a.name="You cancelled the request for permission, giving up...",r(a)}else r(null,n.data.sourceId)}else"janusGetScreenPending"==n.data.type&&(console.log("clearing ",n.data.id),window.clearTimeout(n.data.id))})}};function Janus(e){if((e=e||{}).success="function"==typeof e.success?e.success:Janus.noop,e.error="function"==typeof e.error?e.error:Janus.noop,e.destroyed="function"==typeof e.destroyed?e.destroyed:Janus.noop,!Janus.initDone)return e.error("Library not initialized"),{};if(!Janus.isWebrtcSupported())return e.error("WebRTC not supported by this browser"),{};if(Janus.log("Library initialized: "+Janus.initDone),!e.server)return e.error("Invalid server url"),{};var n=!1,r=null,a={},o=null,t=null,s=0,i=e.server;Janus.isArray(i)?(Janus.log("Multiple servers provided ("+i.length+"), will use the first that works"),i=null,t=e.server,Janus.debug(t)):0===i.indexOf("ws")?(n=!0,Janus.log("Using WebSockets to contact Janus: "+i)):(n=!1,Janus.log("Using REST API to contact Janus: "+i));var d=e.iceServers||[{urls:["stun:stun.hermetix.io:3478?transport=udp"]},{urls:"turn:turn.hermetix.io:3478?transport=tcp",username:"sassyn",credential:"manager11"}],u=(e.iceTransportPolicy,e.bundlePolicy),c=!0===e.ipv6,l=!1;void 0!==e.withCredentials&&null!==e.withCredentials&&(l=!0===e.withCredentials);var f=10;void 0!==e.max_poll_events&&null!==e.max_poll_events&&(f=e.max_poll_events),f<1&&(f=1);var v=null;void 0!==e.token&&null!==e.token&&(v=e.token);var g=null;void 0!==e.apisecret&&null!==e.apisecret&&(g=e.apisecret),this.destroyOnUnload=!0,void 0!==e.destroyOnUnload&&null!==e.destroyOnUnload&&(this.destroyOnUnload=!0===e.destroyOnUnload);var p=25e3;void 0!==e.keepAlivePeriod&&null!==e.keepAlivePeriod&&(p=e.keepAlivePeriod),isNaN(p)&&(p=25e3);var m=6e4;function J(e){var n={high:9e5,medium:3e5,low:1e5};return null!=e&&(e.high&&(n.high=e.high),e.medium&&(n.medium=e.medium),e.low&&(n.low=e.low)),n}void 0!==e.longPollTimeout&&null!==e.longPollTimeout&&(m=e.longPollTimeout),isNaN(m)&&(m=6e4);var b=!1,h=null,w={},S=this,y=0,k={};function T(){if(null!=h)if(Janus.debug("Long poll..."),b){var n=i+"/"+h+"?rid="+(new Date).getTime();f&&(n=n+"&maxev="+f),v&&(n=n+"&token="+encodeURIComponent(v)),g&&(n=n+"&apisecret="+encodeURIComponent(g)),Janus.httpAPICall(n,{verb:"GET",withCredentials:l,success:C,timeout:m,error:function(n,r){if(Janus.error(n+":",r),++y>3)return b=!1,void e.error("Lost connection to the server (is it down?)");T()}})}else Janus.warn("Is the server down? (connected=false)")}function C(e,a){if(y=0,n||null==h||!0===a||T(),n||!Janus.isArray(e))if("keepalive"!==e.janus)if("server_info"!==e.janus)if("ack"!==e.janus)if("success"!==e.janus)if("trickle"===e.janus){if(!(d=e.sender))return void Janus.warn("Missing sender...");if(!(c=w[d]))return void Janus.debug("This handle is not attached to this session");var o=e.candidate;Janus.debug("Got a trickled candidate on session "+h),Janus.debug(o);var t=c.webrtcStuff;t.pc&&t.remoteSdp?(Janus.debug("Adding remote candidate:",o),o&&!0!==o.completed?t.pc.addIceCandidate(o):t.pc.addIceCandidate(Janus.endOfCandidates)):(Janus.debug("We didn't do setRemoteDescription (trickle got here before the offer?), caching candidate"),t.candidates||(t.candidates=[]),t.candidates.push(o),Janus.debug(t.candidates))}else{if("webrtcup"===e.janus)return Janus.debug("Got a webrtcup event on session "+h),Janus.debug(e),(d=e.sender)?(c=w[d])?void c.webrtcState(!0):void Janus.debug("This handle is not attached to this session"):void Janus.warn("Missing sender...");if("hangup"===e.janus){if(Janus.debug("Got a hangup event on session "+h),Janus.debug(e),!(d=e.sender))return void Janus.warn("Missing sender...");if(!(c=w[d]))return void Janus.debug("This handle is not attached to this session");c.webrtcState(!1,e.reason),c.hangup()}else if("detached"===e.janus){if(Janus.debug("Got a detached event on session "+h),Janus.debug(e),!(d=e.sender))return void Janus.warn("Missing sender...");if(!(c=w[d]))return;c.detached=!0,c.ondetached(),c.detach()}else if("media"===e.janus){if(Janus.debug("Got a media event on session "+h),Janus.debug(e),!(d=e.sender))return void Janus.warn("Missing sender...");if(!(c=w[d]))return void Janus.debug("This handle is not attached to this session");c.mediaState(e.type,e.receiving)}else if("slowlink"===e.janus){if(Janus.debug("Got a slowlink event on session "+h),Janus.debug(e),!(d=e.sender))return void Janus.warn("Missing sender...");if(!(c=w[d]))return void Janus.debug("This handle is not attached to this session");c.slowLink(e.uplink,e.lost)}else{if("error"===e.janus){var s,i;if(Janus.error("Ooops: "+e.error.code+" "+e.error.reason),Janus.debug(e),s=e.transaction)(i=k[s])&&i(e),delete k[s];return}if("event"===e.janus){var d;if(Janus.debug("Got a plugin event on session "+h),Janus.debug(e),!(d=e.sender))return void Janus.warn("Missing sender...");var u=e.plugindata;if(!u)return void Janus.warn("Missing plugindata...");Janus.debug("  -- Event is coming from "+d+" ("+u.plugin+")");var c,l=u.data;if(Janus.debug(l),!(c=w[d]))return void Janus.warn("This handle is not attached to this session");var f=e.jsep;f&&(Janus.debug("Handling SDP as well..."),Janus.debug(f));var v=c.onmessage;v?(Janus.debug("Notifying application..."),v(l,f)):Janus.debug("No provided notification callback")}else{if("timeout"===e.janus)return Janus.error("Timeout on session "+h),Janus.debug(e),void(n&&r.close(3504,"Gateway timeout"));Janus.warn("Unknown message/event  '"+e.janus+"' on session "+h),Janus.debug(e)}}}else Janus.debug("Got a success on session "+h),Janus.debug(e),(s=e.transaction)&&((i=k[s])&&i(e),delete k[s]);else Janus.debug("Got an ack on session "+h),Janus.debug(e),(s=e.transaction)&&((i=k[s])&&i(e),delete k[s]);else Janus.debug("Got info on the Janus instance"),Janus.debug(e),(s=e.transaction)&&((i=k[s])&&i(e),delete k[s]);else Janus.vdebug("Got a keepalive on session "+h);else for(var g=0;g<e.length;g++)C(e[g],!0)}function A(){if(i&&n&&b){o=setTimeout(A,p);var e={janus:"keepalive",session_id:h,transaction:Janus.randomString(12)};v&&(e.token=v),g&&(e.apisecret=g),r.send(JSON.stringify(e))}}function D(d){var u=Janus.randomString(12),c={janus:"create",transaction:u};if(d.reconnect&&(b=!1,c.janus="claim",c.session_id=h,r&&(r.onopen=null,r.onerror=null,r.onclose=null,o&&(clearTimeout(o),o=null))),v&&(c.token=v),g&&(c.apisecret=g),!i&&Janus.isArray(t)&&(0===(i=t[s]).indexOf("ws")?(n=!0,Janus.log("Server #"+(s+1)+": trying WebSockets to contact Janus ("+i+")")):(n=!1,Janus.log("Server #"+(s+1)+": trying REST API to contact Janus ("+i+")"))),n)for(var f in r=Janus.newWebSocket(i,"janus-protocol"),a={error:function(){if(Janus.error("Error connecting to the Janus WebSockets server... "+i),Janus.isArray(t)&&!d.reconnect)return++s===t.length?void d.error("Error connecting to any of the provided Janus servers: Is the server down?"):(i=null,void setTimeout(function(){D(d)},200));d.error("Error connecting to the WebSockets server: Is the server down?")},open:function(){k[u]=function(e){if(Janus.debug(e),"success"!==e.janus)return Janus.error("Ooops: "+e.error.code+" "+e.error.reason),void d.error(e.error.reason);o=setTimeout(A,p),b=!0,h=e.session_id?e.session_id:e.data.id,d.reconnect?Janus.log("Claimed session: "+h):Janus.log("Created session: "+h),Janus.sessions[h]=S,d.success()},r.send(JSON.stringify(c))},message:function(e){C(JSON.parse(e.data))},close:function(){i&&b&&(b=!1,e.error("Lost connection to the server (is it down?)"))}})r.addEventListener(f,a[f]);else Janus.httpAPICall(i,{verb:"POST",withCredentials:l,body:c,success:function(e){if(Janus.debug(e),"success"!==e.janus)return Janus.error("Ooops: "+e.error.code+" "+e.error.reason),void d.error(e.error.reason);b=!0,h=e.session_id?e.session_id:e.data.id,d.reconnect?Janus.log("Claimed session: "+h):Janus.log("Created session: "+h),Janus.sessions[h]=S,T(),d.success()},error:function(e,n){if(Janus.error(e+":",n),Janus.isArray(t)&&!d.reconnect)return++s===t.length?void d.error("Error connecting to any of the provided servers: Is the server down?"):(i=null,void setTimeout(function(){D(d)},200));""===n?d.error(e+": Is the server down?"):d.error(e+": "+n)}})}function R(e,a){if((a=a||{}).success="function"==typeof a.success?a.success:Janus.noop,a.error="function"==typeof a.error?a.error:Janus.noop,!b)return Janus.warn("Is the server down? (connected=false)"),void a.error("Is the server down? (connected=false)");var o=w[e];if(!o||!o.webrtcStuff)return Janus.warn("Invalid handle"),void a.error("Invalid handle");var t=a.message,s=a.jsep,d=Janus.randomString(12),u={janus:"message",body:t,transaction:d};if(o.token&&(u.token=o.token),g&&(u.apisecret=g),s&&(u.jsep={type:s.type,sdp:s.sdp},s.e2ee&&(u.jsep.e2ee=!0),"hml"!==s.rid_order&&"lmh"!==s.rid_order||(u.jsep.rid_order=s.rid_order)),Janus.debug("Sending message to plugin (handle="+e+"):"),Janus.debug(u),n)return u.session_id=h,u.handle_id=e,k[d]=function(e){if(Janus.debug("Message sent!"),Janus.debug(e),"success"===e.janus){var n=e.plugindata;if(!n)return Janus.warn("Request succeeded, but missing plugindata..."),void a.success();Janus.log("Synchronous transaction successful ("+n.plugin+")");var r=n.data;return Janus.debug(r),void a.success(r)}"ack"===e.janus?a.success():e.error?(Janus.error("Ooops: "+e.error.code+" "+e.error.reason),a.error(e.error.code+" "+e.error.reason)):(Janus.error("Unknown error"),a.error("Unknown error"))},void r.send(JSON.stringify(u));Janus.httpAPICall(i+"/"+h+"/"+e,{verb:"POST",withCredentials:l,body:u,success:function(e){if(Janus.debug("Message sent!"),Janus.debug(e),"success"===e.janus){var n=e.plugindata;if(!n)return Janus.warn("Request succeeded, but missing plugindata..."),void a.success();Janus.log("Synchronous transaction successful ("+n.plugin+")");var r=n.data;return Janus.debug(r),void a.success(r)}"ack"===e.janus?a.success():e.error?(Janus.error("Ooops: "+e.error.code+" "+e.error.reason),a.error(e.error.code+" "+e.error.reason)):(Janus.error("Unknown error"),a.error("Unknown error"))},error:function(e,n){Janus.error(e+":",n),a.error(e+": "+n)}})}function I(e,a){if(b){var o=w[e];if(o&&o.webrtcStuff){var t={janus:"trickle",candidate:a,transaction:Janus.randomString(12)};if(o.token&&(t.token=o.token),g&&(t.apisecret=g),Janus.vdebug("Sending trickle candidate (handle="+e+"):"),Janus.vdebug(t),n)return t.session_id=h,t.handle_id=e,void r.send(JSON.stringify(t));Janus.httpAPICall(i+"/"+h+"/"+e,{verb:"POST",withCredentials:l,body:t,success:function(e){Janus.vdebug("Candidate sent!"),Janus.vdebug(e),"ack"===e.janus||Janus.error("Ooops: "+e.error.code+" "+e.error.reason)},error:function(e,n){Janus.error(e+":",n)}})}else Janus.warn("Invalid handle")}else Janus.warn("Is the server down? (connected=false)")}function V(e,n,r,a,o){var t=w[e];if(t&&t.webrtcStuff){var s=t.webrtcStuff;if(s.pc){var i=function(e){Janus.log("Received state change on data channel:",e);var n=e.target.label,r=e.target.protocol,a=s.dataChannel[n]?s.dataChannel[n].readyState:"null";if(Janus.log("State change on <"+n+"> data channel: "+a),"open"===a){if(s.dataChannel[n].pending&&s.dataChannel[n].pending.length>0){for(var o of(Janus.log("Sending pending messages on <"+n+">:",s.dataChannel[n].pending.length),s.dataChannel[n].pending))Janus.log("Sending data on data channel <"+n+">"),Janus.debug(o),s.dataChannel[n].send(o);s.dataChannel[n].pending=[]}t.ondataopen(n,r)}};if(a)s.dataChannel[n]=a;else{var d={ordered:!0};r&&(d.protocol=r),s.dataChannel[n]=s.pc.createDataChannel(n,d)}s.dataChannel[n].onmessage=function(e){Janus.log("Received message on data channel:",e);var n=e.target.label;t.ondata(e.data,n)},s.dataChannel[n].onopen=i,s.dataChannel[n].onclose=i,s.dataChannel[n].onerror=function(e){Janus.error("Got error on data channel:",e)},s.dataChannel[n].pending=[],o&&s.dataChannel[n].pending.push(o)}else Janus.warn("Invalid PeerConnection")}else Janus.warn("Invalid handle")}function P(e,n){(n=n||{}).success="function"==typeof n.success?n.success:Janus.noop,n.error="function"==typeof n.error?n.error:Janus.noop;var r=w[e];if(!r||!r.webrtcStuff)return Janus.warn("Invalid handle"),void n.error("Invalid handle");var a=r.webrtcStuff,o=n.text||n.data;if(!o)return Janus.warn("Invalid data"),void n.error("Invalid data");var t=n.label?n.label:Janus.dataChanDefaultLabel;return a.dataChannel[t]?"open"!==a.dataChannel[t].readyState?(a.dataChannel[t].pending.push(o),void n.success()):(Janus.log("Sending data on data channel <"+t+">"),Janus.debug(o),a.dataChannel[t].send(o),void n.success()):(V(e,t,n.protocol,!1,o,n.protocol),void n.success())}function x(e,n){(n=n||{}).success="function"==typeof n.success?n.success:Janus.noop,n.error="function"==typeof n.error?n.error:Janus.noop;var r=w[e];if(!r||!r.webrtcStuff)return Janus.warn("Invalid handle"),void n.error("Invalid handle");var a=r.webrtcStuff;if(!a.dtmfSender){if(a.pc){var o=a.pc.getSenders().find(function(e){return e.track&&"audio"===e.track.kind});if(!o)return Janus.warn("Invalid DTMF configuration (no audio track)"),void n.error("Invalid DTMF configuration (no audio track)");a.dtmfSender=o.dtmf,a.dtmfSender&&(Janus.log("Created DTMF Sender"),a.dtmfSender.ontonechange=function(e){Janus.debug("Sent DTMF tone: "+e.tone)})}if(!a.dtmfSender)return Janus.warn("Invalid DTMF configuration"),void n.error("Invalid DTMF configuration")}var t=n.dtmf;if(!t)return Janus.warn("Invalid DTMF parameters"),void n.error("Invalid DTMF parameters");var s=t.tones;if(!s)return Janus.warn("Invalid DTMF string"),void n.error("Invalid DTMF string");var i="number"==typeof t.duration?t.duration:500,d="number"==typeof t.gap?t.gap:50;Janus.debug("Sending DTMF string "+s+" (duration "+i+"ms, gap "+d+"ms)"),a.dtmfSender.insertDTMF(s,i,d),n.success()}function E(e,a){(a=a||{}).success="function"==typeof a.success?a.success:Janus.noop,a.error="function"==typeof a.error?a.error:Janus.noop;var o=!0===a.noRequest;Janus.log("Destroying handle "+e+" (only-locally="+o+")"),W(e);var t=w[e];if(!t||t.detached)return delete w[e],void a.success();if(o)return delete w[e],void a.success();if(!b)return Janus.warn("Is the server down? (connected=false)"),void a.error("Is the server down? (connected=false)");var s={janus:"detach",transaction:Janus.randomString(12)};if(t.token&&(s.token=t.token),g&&(s.apisecret=g),n)return s.session_id=h,s.handle_id=e,r.send(JSON.stringify(s)),delete w[e],void a.success();Janus.httpAPICall(i+"/"+h+"/"+e,{verb:"POST",withCredentials:l,body:s,success:function(n){Janus.log("Destroyed handle:"),Janus.debug(n),"success"!==n.janus&&Janus.error("Ooops: "+n.error.code+" "+n.error.reason),delete w[e],a.success()},error:function(n,r){Janus.error(n+":",r),delete w[e],a.success()}})}function M(e,n,r,a,o){var t=w[e];if(!t||!t.webrtcStuff)return Janus.warn("Invalid handle"),a.stream||Janus.stopAllTracks(o),void a.error("Invalid handle");var s=t.webrtcStuff;Janus.debug("streamsDone:",o),o&&(Janus.debug("  -- Audio tracks:",o.getAudioTracks()),Janus.debug("  -- Video tracks:",o.getVideoTracks()));var i=!1;if(s.myStream&&r.update&&!s.streamExternal){if((!r.update&&B(r)||r.update&&(r.addAudio||r.replaceAudio))&&o.getAudioTracks()&&o.getAudioTracks().length)if(s.myStream.addTrack(o.getAudioTracks()[0]),Janus.unifiedPlan){Janus.log((r.replaceAudio?"Replacing":"Adding")+" audio track:",o.getAudioTracks()[0]);var l=null;if((v=s.pc.getTransceivers())&&v.length>0)for(var f of v)if(f.sender&&f.sender.track&&"audio"===f.sender.track.kind||f.receiver&&f.receiver.track&&"audio"===f.receiver.track.kind){l=f;break}l&&l.sender?l.sender.replaceTrack(o.getAudioTracks()[0]):s.pc.addTrack(o.getAudioTracks()[0],o)}else Janus.log((r.replaceAudio?"Replacing":"Adding")+" audio track:",o.getAudioTracks()[0]),s.pc.addTrack(o.getAudioTracks()[0],o);if((!r.update&&q(r)||r.update&&(r.addVideo||r.replaceVideo))&&o.getVideoTracks()&&o.getVideoTracks().length)if(s.myStream.addTrack(o.getVideoTracks()[0]),Janus.unifiedPlan){Janus.log((r.replaceVideo?"Replacing":"Adding")+" video track:",o.getVideoTracks()[0]);var v,g=null;if((v=s.pc.getTransceivers())&&v.length>0)for(var f of v)if(f.sender&&f.sender.track&&"video"===f.sender.track.kind||f.receiver&&f.receiver.track&&"video"===f.receiver.track.kind){g=f;break}g&&g.sender?g.sender.replaceTrack(o.getVideoTracks()[0]):s.pc.addTrack(o.getVideoTracks()[0],o)}else Janus.log((r.replaceVideo?"Replacing":"Adding")+" video track:",o.getVideoTracks()[0]),s.pc.addTrack(o.getVideoTracks()[0],o)}else s.myStream=o,i=!0;if(!s.pc){var p={iceServers:d,iceTransportPolicy:"all",bundlePolicy:u};"chrome"===Janus.webRTCAdapter.browserDetails.browser&&(p.sdpSemantics=Janus.webRTCAdapter.browserDetails.version<72?"plan-b":"unified-plan");var m={optional:[{DtlsSrtpKeyAgreement:!0}]};if(c&&m.optional.push({googIPv6:!0}),a.rtcConstraints&&"object"==typeof a.rtcConstraints)for(var b in Janus.debug("Adding custom PeerConnection constraints:",a.rtcConstraints),a.rtcConstraints)m.optional.push(a.rtcConstraints[b]);"edge"===Janus.webRTCAdapter.browserDetails.browser&&(p.bundlePolicy="max-bundle"),RTCRtpSender&&(RTCRtpSender.prototype.createEncodedStreams||RTCRtpSender.prototype.createEncodedAudioStreams&&RTCRtpSender.prototype.createEncodedVideoStreams)&&(a.senderTransforms||a.receiverTransforms)&&(s.senderTransforms=a.senderTransforms,s.receiverTransforms=a.receiverTransforms,p.forceEncodedAudioInsertableStreams=!0,p.forceEncodedVideoInsertableStreams=!0,p.encodedInsertableStreams=!0),Janus.log("Creating PeerConnection"),Janus.debug(m),s.pc=new RTCPeerConnection(p,m),Janus.debug(s.pc),s.pc.getStats&&(s.volume={},s.bitrate.value="0 kbits/sec"),Janus.log("Preparing local SDP and gathering candidates (trickle="+s.trickle+")"),s.pc.oniceconnectionstatechange=function(e){s.pc&&t.iceState(s.pc.iceConnectionState)},s.pc.onicecandidate=function(n){if(!n.candidate||"edge"===Janus.webRTCAdapter.browserDetails.browser&&n.candidate.candidate.indexOf("endOfCandidates")>0)Janus.log("End of candidates."),s.iceDone=!0,!0===s.trickle?I(e,{completed:!0}):function(e,n){(n=n||{}).success="function"==typeof n.success?n.success:Janus.noop,n.error="function"==typeof n.error?n.error:Janus.noop;var r=w[e];if(!r||!r.webrtcStuff)return void Janus.warn("Invalid handle, not sending anything");var a=r.webrtcStuff;if(Janus.log("Sending offer/answer SDP..."),!a.mySdp)return void Janus.warn("Local SDP instance is invalid, not sending anything...");a.mySdp={type:a.pc.localDescription.type,sdp:a.pc.localDescription.sdp},!1===a.trickle&&(a.mySdp.trickle=!1);Janus.debug(n),a.sdpSent=!0,n.success(a.mySdp)}(e,a);else{var r={candidate:n.candidate.candidate,sdpMid:n.candidate.sdpMid,sdpMLineIndex:n.candidate.sdpMLineIndex};!0===s.trickle&&I(e,r)}},s.pc.ontrack=function(e){if(Janus.log("Handling Remote Track"),Janus.debug(e),e.streams&&(s.remoteStream=e.streams[0],t.onremotestream(s.remoteStream),!e.track.onended)){if(s.receiverTransforms){var n=null;RTCRtpSender.prototype.createEncodedStreams?n=e.receiver.createEncodedStreams():(RTCRtpSender.prototype.createAudioEncodedStreams||RTCRtpSender.prototype.createEncodedVideoStreams)&&("audio"===e.track.kind&&s.receiverTransforms.audio?n=e.receiver.createEncodedAudioStreams():"video"===e.track.kind&&s.receiverTransforms.video&&(n=e.receiver.createEncodedVideoStreams())),n&&(console.log(n),n.readableStream&&n.writableStream?n.readableStream.pipeThrough(s.receiverTransforms[e.track.kind]).pipeTo(n.writableStream):n.readable&&n.writable&&n.readable.pipeThrough(s.receiverTransforms[e.track.kind]).pipeTo(n.writable))}var r=null;Janus.log("Adding onended callback to track:",e.track),e.track.onended=function(e){Janus.log("Remote track removed:",e),s.remoteStream&&(clearTimeout(r),s.remoteStream.removeTrack(e.target),t.onremotestream(s.remoteStream))},e.track.onmute=function(e){Janus.log("Remote track muted:",e),s.remoteStream&&null==r&&(r=setTimeout(function(){Janus.log("Removing remote track"),s.remoteStream&&(s.remoteStream.removeTrack(e.target),t.onremotestream(s.remoteStream)),r=null},2520))},e.track.onunmute=function(e){if(Janus.log("Remote track flowing again:",e),null!=r)clearTimeout(r),r=null;else try{s.remoteStream.addTrack(e.target),t.onremotestream(s.remoteStream)}catch(e){Janus.error(e)}}}}}if(i&&o){Janus.log("Adding local stream");var h=!0===a.simulcast2;o.getTracks().forEach(function(e){Janus.log("Adding local track:",e);var n=null;if(h&&"audio"!==e.kind){Janus.log("Enabling rid-based simulcasting:",e);var r=J(a.simulcastMaxBitrates),t=s.pc.addTransceiver(e,{direction:"sendrecv",streams:[o],sendEncodings:a.sendEncodings||[{rid:"h",active:!0,maxBitrate:r.high},{rid:"m",active:!0,maxBitrate:r.medium,scaleResolutionDownBy:2},{rid:"l",active:!0,maxBitrate:r.low,scaleResolutionDownBy:4}]});t&&(n=t.sender)}else n=s.pc.addTrack(e,o);if(n&&s.senderTransforms){var i=null;RTCRtpSender.prototype.createEncodedStreams?i=n.createEncodedStreams():(RTCRtpSender.prototype.createAudioEncodedStreams||RTCRtpSender.prototype.createEncodedVideoStreams)&&("audio"===n.track.kind&&s.senderTransforms.audio?i=n.createEncodedAudioStreams():"video"===n.track.kind&&s.senderTransforms.video&&(i=n.createEncodedVideoStreams())),i&&(console.log(i),i.readableStream&&i.writableStream?i.readableStream.pipeThrough(s.senderTransforms[n.track.kind]).pipeTo(i.writableStream):i.readable&&i.writable&&i.readable.pipeThrough(s.senderTransforms[n.track.kind]).pipeTo(i.writable))}})}(function(e){if(Janus.debug("isDataEnabled:",e),"edge"===Janus.webRTCAdapter.browserDetails.browser)return Janus.warn("Edge doesn't support data channels yet"),!1;return null!=e&&!0===e.data})(r)&&!s.dataChannel[Janus.dataChanDefaultLabel]&&(Janus.log("Creating default data channel"),V(e,Janus.dataChanDefaultLabel,null,!1),s.pc.ondatachannel=function(n){Janus.log("Data channel created:",n),V(e,n.channel.label,n.channel.protocol,n.channel)}),s.myStream&&t.onlocalstream(s.myStream),n?s.pc.setRemoteDescription(n).then(function(){if(Janus.log("Remote description accepted!"),s.remoteSdp=n.sdp,s.candidates&&s.candidates.length>0){for(var o=0;o<s.candidates.length;o++){var t=s.candidates[o];Janus.debug("Adding remote candidate:",t),t&&!0!==t.completed?s.pc.addIceCandidate(t):s.pc.addIceCandidate(Janus.endOfCandidates)}s.candidates=[]}!function(e,n,r){(r=r||{}).success="function"==typeof r.success?r.success:Janus.noop,r.error="function"==typeof r.error?r.error:Janus.noop,r.customizeSdp="function"==typeof r.customizeSdp?r.customizeSdp:Janus.noop;var a=w[e];if(!a||!a.webrtcStuff)return Janus.warn("Invalid handle"),void r.error("Invalid handle");var o=a.webrtcStuff,t=!0===r.simulcast;t?Janus.log("Creating answer (iceDone="+o.iceDone+", simulcast="+t+")"):Janus.log("Creating answer (iceDone="+o.iceDone+")");var s=null;if(Janus.unifiedPlan){s={};var i=null,d=null,u=o.pc.getTransceivers();if(u&&u.length>0)for(var c of u)c.sender&&c.sender.track&&"audio"===c.sender.track.kind||c.receiver&&c.receiver.track&&"audio"===c.receiver.track.kind?i||(i=c):(c.sender&&c.sender.track&&"video"===c.sender.track.kind||c.receiver&&c.receiver.track&&"video"===c.receiver.track.kind)&&(d||(d=c));var l=B(n),f=G(n);if(l||f){if(l&&f){if(i)try{i.setDirection?i.setDirection("sendrecv"):i.direction="sendrecv",Janus.log("Setting audio transceiver to sendrecv:",i)}catch(e){Janus.error(e)}}else if(l&&!f)try{i&&(i.setDirection?i.setDirection("sendonly"):i.direction="sendonly",Janus.log("Setting audio transceiver to sendonly:",i))}catch(e){Janus.error(e)}else if(!l&&f)if(i)try{i.setDirection?i.setDirection("recvonly"):i.direction="recvonly",Janus.log("Setting audio transceiver to recvonly:",i)}catch(e){Janus.error(e)}else i=o.pc.addTransceiver("audio",{direction:"recvonly"}),Janus.log("Adding recvonly audio transceiver:",i)}else if(n.removeAudio&&i)try{i.setDirection?i.setDirection("inactive"):i.direction="inactive",Janus.log("Setting audio transceiver to inactive:",i)}catch(e){Janus.error(e)}var v=q(n),g=z(n);if(v||g){if(v&&g){if(d)try{d.setDirection?d.setDirection("sendrecv"):d.direction="sendrecv",Janus.log("Setting video transceiver to sendrecv:",d)}catch(e){Janus.error(e)}}else if(v&&!g){if(d)try{d.setDirection?d.setDirection("sendonly"):d.direction="sendonly",Janus.log("Setting video transceiver to sendonly:",d)}catch(e){Janus.error(e)}}else if(!v&&g)if(d)try{d.setDirection?d.setDirection("recvonly"):d.direction="recvonly",Janus.log("Setting video transceiver to recvonly:",d)}catch(e){Janus.error(e)}else d=o.pc.addTransceiver("video",{direction:"recvonly"}),Janus.log("Adding recvonly video transceiver:",d)}else if(n.removeVideo&&d)try{d.setDirection?d.setDirection("inactive"):d.direction="inactive",Janus.log("Setting video transceiver to inactive:",d)}catch(e){Janus.error(e)}}else s="firefox"===Janus.webRTCAdapter.browserDetails.browser||"edge"===Janus.webRTCAdapter.browserDetails.browser?{offerToReceiveAudio:G(n),offerToReceiveVideo:z(n)}:{mandatory:{OfferToReceiveAudio:G(n),OfferToReceiveVideo:z(n)}};Janus.debug(s);var p=q(n);if(p&&t&&"firefox"===Janus.webRTCAdapter.browserDetails.browser){Janus.log("Enabling Simulcasting for Firefox (RID)");var m=o.pc.getSenders()[1];Janus.log(m);var b=m.getParameters();Janus.log(b);var h=J(r.simulcastMaxBitrates);m.setParameters({encodings:r.sendEncodings||[{rid:"h",active:!0,maxBitrate:h.high},{rid:"m",active:!0,maxBitrate:h.medium,scaleResolutionDownBy:2},{rid:"l",active:!0,maxBitrate:h.low,scaleResolutionDownBy:4}]})}o.pc.createAnswer(s).then(function(e){Janus.debug(e);var n={type:e.type,sdp:e.sdp};r.customizeSdp(n),e.sdp=n.sdp,Janus.log("Setting local description"),p&&t&&("chrome"===Janus.webRTCAdapter.browserDetails.browser?Janus.warn("simulcast=true, but this is an answer, and video breaks in Chrome if we enable it"):"firefox"!==Janus.webRTCAdapter.browserDetails.browser&&Janus.warn("simulcast=true, but this is not Chrome nor Firefox, ignoring")),o.mySdp={type:"answer",sdp:e.sdp},o.pc.setLocalDescription(e).catch(r.error),o.mediaConstraints=s,o.iceDone||o.trickle?((o.senderTransforms||o.receiverTransforms)&&(e.e2ee=!0),r.success(e)):Janus.log("Waiting for all candidates...")},r.error)}(e,r,a)},a.error):function(e,n,r){(r=r||{}).success="function"==typeof r.success?r.success:Janus.noop,r.error="function"==typeof r.error?r.error:Janus.noop,r.customizeSdp="function"==typeof r.customizeSdp?r.customizeSdp:Janus.noop;var a=w[e];if(!a||!a.webrtcStuff)return Janus.warn("Invalid handle"),void r.error("Invalid handle");var o=a.webrtcStuff,t=!0===r.simulcast;t?Janus.log("Creating offer (iceDone="+o.iceDone+", simulcast="+t+")"):Janus.log("Creating offer (iceDone="+o.iceDone+")");var s={};if(Janus.unifiedPlan){var i=null,d=null,u=o.pc.getTransceivers();if(u&&u.length>0)for(var c of u)c.sender&&c.sender.track&&"audio"===c.sender.track.kind||c.receiver&&c.receiver.track&&"audio"===c.receiver.track.kind?i||(i=c):(c.sender&&c.sender.track&&"video"===c.sender.track.kind||c.receiver&&c.receiver.track&&"video"===c.receiver.track.kind)&&(d||(d=c));var l=B(n),f=G(n);l||f?l&&f?i&&(i.setDirection?i.setDirection("sendrecv"):i.direction="sendrecv",Janus.log("Setting audio transceiver to sendrecv:",i)):l&&!f?i&&(i.setDirection?i.setDirection("sendonly"):i.direction="sendonly",Janus.log("Setting audio transceiver to sendonly:",i)):!l&&f&&(i?(i.setDirection?i.setDirection("recvonly"):i.direction="recvonly",Janus.log("Setting audio transceiver to recvonly:",i)):(i=o.pc.addTransceiver("audio",{direction:"recvonly"}),Janus.log("Adding recvonly audio transceiver:",i))):n.removeAudio&&i&&(i.setDirection?i.setDirection("inactive"):i.direction="inactive",Janus.log("Setting audio transceiver to inactive:",i));var v=q(n),g=z(n);v||g?v&&g?d&&(d.setDirection?d.setDirection("sendrecv"):d.direction="sendrecv",Janus.log("Setting video transceiver to sendrecv:",d)):v&&!g?d&&(d.setDirection?d.setDirection("sendonly"):d.direction="sendonly",Janus.log("Setting video transceiver to sendonly:",d)):!v&&g&&(d?(d.setDirection?d.setDirection("recvonly"):d.direction="recvonly",Janus.log("Setting video transceiver to recvonly:",d)):(d=o.pc.addTransceiver("video",{direction:"recvonly"}),Janus.log("Adding recvonly video transceiver:",d))):n.removeVideo&&d&&(d.setDirection?d.setDirection("inactive"):d.direction="inactive",Janus.log("Setting video transceiver to inactive:",d))}else s.offerToReceiveAudio=G(n),s.offerToReceiveVideo=z(n);!0===r.iceRestart&&(s.iceRestart=!0);Janus.debug(s);var p=q(n);if(p&&t&&"firefox"===Janus.webRTCAdapter.browserDetails.browser){Janus.log("Enabling Simulcasting for Firefox (RID)");var m=o.pc.getSenders().find(function(e){return"video"===e.track.kind});if(m){var b=m.getParameters();b||(b={});var h=J(r.simulcastMaxBitrates);b.encodings=r.sendEncodings||[{rid:"h",active:!0,maxBitrate:h.high},{rid:"m",active:!0,maxBitrate:h.medium,scaleResolutionDownBy:2},{rid:"l",active:!0,maxBitrate:h.low,scaleResolutionDownBy:4}],m.setParameters(b)}}o.pc.createOffer(s).then(function(e){Janus.debug(e);var n={type:e.type,sdp:e.sdp};r.customizeSdp(n),e.sdp=n.sdp,Janus.log("Setting local description"),p&&t&&("chrome"===Janus.webRTCAdapter.browserDetails.browser||"safari"===Janus.webRTCAdapter.browserDetails.browser?(Janus.log("Enabling Simulcasting for Chrome (SDP munging)"),e.sdp=function(e){for(var n=e.split("\r\n"),r=!1,a=[-1],o=[-1],t=null,s=null,i=null,d=null,u=-1,c=0;c<n.length;c++){var l=n[c].match(/m=(\w+) */);if(l){var f=l[1];if("video"===f){if(!(a[0]<0)){u=c;break}r=!0}else if(a[0]>-1){u=c;break}}else if(r){var v=n[c].match(/a=ssrc-group:SIM (\d+) (\d+) (\d+)/);if(v)return Janus.warn("The SDP already contains a SIM attribute, munging will be skipped"),e;var g=n[c].match(/a=ssrc-group:FID (\d+) (\d+)/);if(g)a[0]=g[1],o[0]=g[2],n.splice(c,1),c--;else{if(a[0]){var p=n[c].match("a=ssrc:"+a[0]+" cname:(.+)");if(p&&(t=p[1]),(p=n[c].match("a=ssrc:"+a[0]+" msid:(.+)"))&&(s=p[1]),(p=n[c].match("a=ssrc:"+a[0]+" mslabel:(.+)"))&&(i=p[1]),(p=n[c].match("a=ssrc:"+a[0]+" label:(.+)"))&&(d=p[1]),0===n[c].indexOf("a=ssrc:"+o[0])){n.splice(c,1),c--;continue}if(0===n[c].indexOf("a=ssrc:"+a[0])){n.splice(c,1),c--;continue}}0!=n[c].length||(n.splice(c,1),c--)}}}if(a[0]<0){u=-1,r=!1;for(var c=0;c<n.length;c++){var l=n[c].match(/m=(\w+) */);if(l){var f=l[1];if("video"===f){if(!(a[0]<0)){u=c;break}r=!0}else if(a[0]>-1){u=c;break}}else if(r){if(a[0]<0){var m=n[c].match(/a=ssrc:(\d+)/);if(m){a[0]=m[1],n.splice(c,1),c--;continue}}else{var p=n[c].match("a=ssrc:"+a[0]+" cname:(.+)");if(p&&(t=p[1]),(p=n[c].match("a=ssrc:"+a[0]+" msid:(.+)"))&&(s=p[1]),(p=n[c].match("a=ssrc:"+a[0]+" mslabel:(.+)"))&&(i=p[1]),(p=n[c].match("a=ssrc:"+a[0]+" label:(.+)"))&&(d=p[1]),0===n[c].indexOf("a=ssrc:"+o[0])){n.splice(c,1),c--;continue}if(0===n[c].indexOf("a=ssrc:"+a[0])){n.splice(c,1),c--;continue}}0!==n[c].length||(n.splice(c,1),c--)}}}if(a[0]<0)return Janus.warn("Couldn't find the video SSRC, simulcasting NOT enabled"),e;u<0&&(u=n.length);a[1]=Math.floor(4294967295*Math.random()),a[2]=Math.floor(4294967295*Math.random()),o[1]=Math.floor(4294967295*Math.random()),o[2]=Math.floor(4294967295*Math.random());for(var c=0;c<a.length;c++)t&&(n.splice(u,0,"a=ssrc:"+a[c]+" cname:"+t),u++),s&&(n.splice(u,0,"a=ssrc:"+a[c]+" msid:"+s),u++),i&&(n.splice(u,0,"a=ssrc:"+a[c]+" mslabel:"+i),u++),d&&(n.splice(u,0,"a=ssrc:"+a[c]+" label:"+d),u++),t&&(n.splice(u,0,"a=ssrc:"+o[c]+" cname:"+t),u++),s&&(n.splice(u,0,"a=ssrc:"+o[c]+" msid:"+s),u++),i&&(n.splice(u,0,"a=ssrc:"+o[c]+" mslabel:"+i),u++),d&&(n.splice(u,0,"a=ssrc:"+o[c]+" label:"+d),u++);n.splice(u,0,"a=ssrc-group:FID "+a[2]+" "+o[2]),n.splice(u,0,"a=ssrc-group:FID "+a[1]+" "+o[1]),n.splice(u,0,"a=ssrc-group:FID "+a[0]+" "+o[0]),n.splice(u,0,"a=ssrc-group:SIM "+a[0]+" "+a[1]+" "+a[2]),(e=n.join("\r\n")).endsWith("\r\n")||(e+="\r\n");return e}(e.sdp)):"firefox"!==Janus.webRTCAdapter.browserDetails.browser&&Janus.warn("simulcast=true, but this is not Chrome nor Firefox, ignoring")),o.mySdp={type:"offer",sdp:e.sdp},o.pc.setLocalDescription(e).catch(r.error),o.mediaConstraints=s,o.iceDone||o.trickle?((o.senderTransforms||o.receiverTransforms)&&(e.e2ee=!0),r.success(e)):Janus.log("Waiting for all candidates...")},r.error)}(e,r,a)}function j(e,n,r){(r=r||{}).success="function"==typeof r.success?r.success:Janus.noop,r.error="function"==typeof r.error?r.error:_;var a=r.jsep;if(n&&a)return Janus.error("Provided a JSEP to a createOffer"),void r.error("Provided a JSEP to a createOffer");if(!(n||a&&a.type&&a.sdp))return Janus.error("A valid JSEP is required for createAnswer"),void r.error("A valid JSEP is required for createAnswer");r.media="object"==typeof r.media&&r.media?r.media:{audio:!0,video:!0};var o=r.media,t=w[e];if(!t||!t.webrtcStuff)return Janus.warn("Invalid handle"),void r.error("Invalid handle");var s,i=t.webrtcStuff;if(i.trickle=(s=r.trickle,Janus.debug("isTrickleEnabled:",s),!1!==s),i.pc){if(Janus.log("Updating existing media session"),o.update=!0,r.stream)r.stream!==i.myStream&&Janus.log("Renegotiation involves a new external stream");else{if(o.addAudio){if(o.keepAudio=!1,o.replaceAudio=!1,o.removeAudio=!1,o.audioSend=!0,i.myStream&&i.myStream.getAudioTracks()&&i.myStream.getAudioTracks().length)return Janus.error("Can't add audio stream, there already is one"),void r.error("Can't add audio stream, there already is one")}else o.removeAudio?(o.keepAudio=!1,o.replaceAudio=!1,o.addAudio=!1,o.audioSend=!1):o.replaceAudio&&(o.keepAudio=!1,o.addAudio=!1,o.removeAudio=!1,o.audioSend=!0);if(i.myStream&&i.myStream.getAudioTracks()&&0!==i.myStream.getAudioTracks().length?!B(o)||o.removeAudio||o.replaceAudio||(o.keepAudio=!0):(o.replaceAudio&&(o.keepAudio=!1,o.replaceAudio=!1,o.addAudio=!0,o.audioSend=!0),B(o)&&(o.keepAudio=!1,o.addAudio=!0)),o.addVideo){if(o.keepVideo=!1,o.replaceVideo=!1,o.removeVideo=!1,o.videoSend=!0,i.myStream&&i.myStream.getVideoTracks()&&i.myStream.getVideoTracks().length)return Janus.error("Can't add video stream, there already is one"),void r.error("Can't add video stream, there already is one")}else o.removeVideo?(o.keepVideo=!1,o.replaceVideo=!1,o.addVideo=!1,o.videoSend=!1):o.replaceVideo&&(o.keepVideo=!1,o.addVideo=!1,o.removeVideo=!1,o.videoSend=!0);i.myStream&&i.myStream.getVideoTracks()&&0!==i.myStream.getVideoTracks().length?!q(o)||o.removeVideo||o.replaceVideo||(o.keepVideo=!0):(o.replaceVideo&&(o.keepVideo=!1,o.replaceVideo=!1,o.addVideo=!0,o.videoSend=!0),q(o)&&(o.keepVideo=!1,o.addVideo=!0)),o.addData&&(o.data=!0)}if(B(o)&&o.keepAudio&&q(o)&&o.keepVideo)return t.consentDialog(!1),void M(e,a,o,r,i.myStream)}else o.update=!1,o.keepAudio=!1,o.keepVideo=!1;if(o.update&&!i.streamExternal){if(o.removeAudio||o.replaceAudio){if(i.myStream&&i.myStream.getAudioTracks()&&i.myStream.getAudioTracks().length){var d=i.myStream.getAudioTracks()[0];Janus.log("Removing audio track:",d),i.myStream.removeTrack(d);try{d.stop()}catch(e){}}if(i.pc.getSenders()&&i.pc.getSenders().length){var u=!0;if(o.replaceAudio&&Janus.unifiedPlan&&(u=!1),u)for(var c of i.pc.getSenders())c&&c.track&&"audio"===c.track.kind&&(Janus.log("Removing audio sender:",c),i.pc.removeTrack(c))}}if(o.removeVideo||o.replaceVideo){if(i.myStream&&i.myStream.getVideoTracks()&&i.myStream.getVideoTracks().length){var l=i.myStream.getVideoTracks()[0];Janus.log("Removing video track:",l),i.myStream.removeTrack(l);try{l.stop()}catch(e){}}if(i.pc.getSenders()&&i.pc.getSenders().length){var f=!0;if(o.replaceVideo&&Janus.unifiedPlan&&(f=!1),f)for(var v of i.pc.getSenders())v&&v.track&&"video"===v.track.kind&&(Janus.log("Removing video sender:",v),i.pc.removeTrack(v))}}}if(r.stream){var g=r.stream;return Janus.log("MediaStream provided by the application"),Janus.debug(g),o.update&&i.myStream&&i.myStream!==r.stream&&!i.streamExternal&&(Janus.stopAllTracks(i.myStream),i.myStream=null),i.streamExternal=!0,t.consentDialog(!1),void M(e,a,o,r,g)}if(B(o)||q(o)){if(!Janus.isGetUserMediaAvailable())return void r.error("getUserMedia not available");var p={mandatory:{},optional:[]};t.consentDialog(!0);var m=B(o);m&&o&&"object"==typeof o.audio&&(m=o.audio);var J=q(o);if(J&&o){var b=!0===r.simulcast,h=!0===r.simulcast2;if(!b&&!h||a||o.video||(o.video="hires"),o.video&&"screen"!=o.video&&"window"!=o.video)if("object"==typeof o.video)J=o.video;else{var S=0,y=0;"lowres"===o.video?(y=240,240,S=320):"lowres-16:9"===o.video?(y=180,180,S=320):"hires"===o.video||"hires-16:9"===o.video||"hdres"===o.video?(y=720,720,S=1280):"fhdres"===o.video?(y=1080,1080,S=1920):"4kres"===o.video?(y=2160,2160,S=3840):"stdres"===o.video?(y=480,480,S=640):"stdres-16:9"===o.video?(y=360,360,S=640):(Janus.log("Default video setting is stdres 4:3"),y=480,480,S=640),Janus.log("Adding media constraint:",o.video),J={height:{ideal:y},width:{ideal:S}},Janus.log("Adding video constraint:",J)}else if("screen"===o.video||"window"===o.video){if(navigator.mediaDevices&&navigator.mediaDevices.getDisplayMedia)return p.video={},o.screenshareFrameRate&&(p.video.frameRate=o.screenshareFrameRate),o.screenshareHeight&&(p.video.height=o.screenshareHeight),o.screenshareWidth&&(p.video.width=o.screenshareWidth),p.audio=o.captureDesktopAudio,void navigator.mediaDevices.getDisplayMedia(p).then(function(n){t.consentDialog(!1),B(o)&&!o.keepAudio?navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then(function(t){n.addTrack(t.getAudioTracks()[0]),M(e,a,o,r,n)}):M(e,a,o,r,n)},function(e){t.consentDialog(!1),r.error(e)});function k(n,s){t.consentDialog(!1),n?r.error(n):M(e,a,o,r,s)}function T(e,n,r){Janus.log("Adding media constraint (screen capture)"),Janus.debug(e),navigator.mediaDevices.getUserMedia(e).then(function(e){r?navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then(function(r){e.addTrack(r.getAudioTracks()[0]),n(null,e)}):n(null,e)}).catch(function(e){t.consentDialog(!1),n(e)})}if("chrome"===Janus.webRTCAdapter.browserDetails.browser){var C=Janus.webRTCAdapter.browserDetails.version,A=33;window.navigator.userAgent.match("Linux")&&(A=35),C>=26&&C<=A?T(p={video:{mandatory:{googLeakyBucket:!0,maxWidth:window.screen.width,maxHeight:window.screen.height,minFrameRate:o.screenshareFrameRate,maxFrameRate:o.screenshareFrameRate,chromeMediaSource:"screen"}},audio:B(o)&&!o.keepAudio},k):Janus.extension.getScreen(function(e,n){if(e)return t.consentDialog(!1),r.error(e);(p={audio:!1,video:{mandatory:{chromeMediaSource:"desktop",maxWidth:window.screen.width,maxHeight:window.screen.height,minFrameRate:o.screenshareFrameRate,maxFrameRate:o.screenshareFrameRate},optional:[{googLeakyBucket:!0},{googTemporalLayeredScreencast:!0}]}}).video.mandatory.chromeMediaSourceId=n,T(p,k,B(o)&&!o.keepAudio)})}else if("firefox"===Janus.webRTCAdapter.browserDetails.browser){if(!(Janus.webRTCAdapter.browserDetails.version>=33)){var D=new Error("NavigatorUserMediaError");return D.name="Your version of Firefox does not support screen sharing, please install Firefox 33 (or more recent versions)",t.consentDialog(!1),void r.error(D)}T(p={video:{mozMediaSource:o.video,mediaSource:o.video},audio:B(o)&&!o.keepAudio},function(e,n){if(k(e,n),!e)var r=n.currentTime,a=window.setInterval(function(){n||window.clearInterval(a),n.currentTime==r&&(window.clearInterval(a),n.onended&&n.onended()),r=n.currentTime},500)})}return}}o&&"screen"===o.video||navigator.mediaDevices.enumerateDevices().then(function(n){var s=n.some(function(e){return"audioinput"===e.kind}),i=function(e){if(Janus.debug("isScreenSendEnabled:",e),!e)return!1;if("object"!=typeof e.video||"object"!=typeof e.video.mandatory)return!1;var n=e.video.mandatory;if(n.chromeMediaSource)return"desktop"===n.chromeMediaSource||"screen"===n.chromeMediaSource;if(n.mozMediaSource)return"window"===n.mozMediaSource||"screen"===n.mozMediaSource;if(n.mediaSource)return"window"===n.mediaSource||"screen"===n.mediaSource;return!1}(o)||n.some(function(e){return"videoinput"===e.kind}),d=B(o),u=q(o),c=function(e){return Janus.debug("isAudioSendRequired:",e),!!e&&!1!==e.audio&&!1!==e.audioSend&&void 0!==e.failIfNoAudio&&null!==e.failIfNoAudio&&!0===e.failIfNoAudio}(o),l=function(e){return Janus.debug("isVideoSendRequired:",e),!!e&&!1!==e.video&&!1!==e.videoSend&&void 0!==e.failIfNoVideo&&null!==e.failIfNoVideo&&!0===e.failIfNoVideo}(o);if(d||u||c||l){var f=!!d&&s,v=!!u&&i;if(!f&&!v)return t.consentDialog(!1),r.error("No capture device found"),!1;if(!f&&c)return t.consentDialog(!1),r.error("Audio capture is required, but no capture device found"),!1;if(!v&&l)return t.consentDialog(!1),r.error("Video capture is required, but no capture device found"),!1}var p={audio:!(!s||o.keepAudio)&&m,video:!(!i||o.keepVideo)&&J};Janus.debug("getUserMedia constraints",p),p.audio||p.video?navigator.mediaDevices.getUserMedia(p).then(function(n){t.consentDialog(!1),M(e,a,o,r,n)}).catch(function(e){t.consentDialog(!1),r.error({code:e.code,name:e.name,message:e.message})}):(t.consentDialog(!1),M(e,a,o,r,g))}).catch(function(e){t.consentDialog(!1),r.error(e)})}else M(e,a,o,r)}function O(e,n){(n=n||{}).success="function"==typeof n.success?n.success:Janus.noop,n.error="function"==typeof n.error?n.error:_;var r=n.jsep,a=w[e];if(!a||!a.webrtcStuff)return Janus.warn("Invalid handle"),void n.error("Invalid handle");var o=a.webrtcStuff;if(r){if(!o.pc)return Janus.warn("Wait, no PeerConnection?? if this is an answer, use createAnswer and not handleRemoteJsep"),void n.error("No PeerConnection: if this is an answer, use createAnswer and not handleRemoteJsep");o.pc.setRemoteDescription(r).then(function(){if(Janus.log("Remote description accepted!"),o.remoteSdp=r.sdp,o.candidates&&o.candidates.length>0){for(var e=0;e<o.candidates.length;e++){var a=o.candidates[e];Janus.debug("Adding remote candidate:",a),a&&!0!==a.completed?o.pc.addIceCandidate(a):o.pc.addIceCandidate(Janus.endOfCandidates)}o.candidates=[]}n.success()},n.error)}else n.error("Invalid JSEP")}function L(e,n){var r=w[e];if(!r||!r.webrtcStuff)return Janus.warn("Invalid handle"),0;var a=n?"remote":"local",o=r.webrtcStuff;return o.volume[a]||(o.volume[a]={value:0}),!o.pc.getStats||"chrome"!==Janus.webRTCAdapter.browserDetails.browser&&"safari"!==Janus.webRTCAdapter.browserDetails.browser?(Janus.warn("Getting the "+a+" volume unsupported by browser"),0):n&&!o.remoteStream?(Janus.warn("Remote stream unavailable"),0):n||o.myStream?o.volume[a].timer?o.volume[a].value:(Janus.log("Starting "+a+" volume monitor"),o.volume[a].timer=setInterval(function(){o.pc.getStats().then(function(e){e.forEach(function(e){e&&"audio"===e.kind&&(n&&!e.remoteSource||!n&&"media-source"!==e.type||(o.volume[a].value=e.audioLevel?e.audioLevel:0))})})},200),0):(Janus.warn("Local stream unavailable"),0)}function N(e,n){var r=w[e];if(!r||!r.webrtcStuff)return Janus.warn("Invalid handle"),!0;var a=r.webrtcStuff;return a.pc?a.myStream?n?a.myStream.getVideoTracks()&&0!==a.myStream.getVideoTracks().length?!a.myStream.getVideoTracks()[0].enabled:(Janus.warn("No video track"),!0):a.myStream.getAudioTracks()&&0!==a.myStream.getAudioTracks().length?!a.myStream.getAudioTracks()[0].enabled:(Janus.warn("No audio track"),!0):(Janus.warn("Invalid local MediaStream"),!0):(Janus.warn("Invalid PeerConnection"),!0)}function F(e,n,r){var a=w[e];if(!a||!a.webrtcStuff)return Janus.warn("Invalid handle"),!1;var o=a.webrtcStuff;return o.pc?o.myStream?n?o.myStream.getVideoTracks()&&0!==o.myStream.getVideoTracks().length?(o.myStream.getVideoTracks()[0].enabled=!r,!0):(Janus.warn("No video track"),!1):o.myStream.getAudioTracks()&&0!==o.myStream.getAudioTracks().length?(o.myStream.getAudioTracks()[0].enabled=!r,!0):(Janus.warn("No audio track"),!1):(Janus.warn("Invalid local MediaStream"),!1):(Janus.warn("Invalid PeerConnection"),!1)}function U(e){var n=w[e];if(!n||!n.webrtcStuff)return Janus.warn("Invalid handle"),"Invalid handle";var r=n.webrtcStuff;return r.pc?r.pc.getStats?r.bitrate.timer?r.bitrate.value:(Janus.log("Starting bitrate timer (via getStats)"),r.bitrate.timer=setInterval(function(){r.pc.getStats().then(function(e){e.forEach(function(e){if(e){var n=!1;if(("video"===e.mediaType||e.id.toLowerCase().indexOf("video")>-1)&&"inbound-rtp"===e.type&&e.id.indexOf("rtcp")<0?n=!0:"ssrc"!=e.type||!e.bytesReceived||"VP8"!==e.googCodecName&&""!==e.googCodecName||(n=!0),n)if(r.bitrate.bsnow=e.bytesReceived,r.bitrate.tsnow=e.timestamp,null===r.bitrate.bsbefore||null===r.bitrate.tsbefore)r.bitrate.bsbefore=r.bitrate.bsnow,r.bitrate.tsbefore=r.bitrate.tsnow;else{var a=r.bitrate.tsnow-r.bitrate.tsbefore;"safari"===Janus.webRTCAdapter.browserDetails.browser&&(a/=1e3);var o=Math.round(8*(r.bitrate.bsnow-r.bitrate.bsbefore)/a);"safari"===Janus.webRTCAdapter.browserDetails.browser&&(o=parseInt(o/1e3)),r.bitrate.value=o+" kbits/sec",r.bitrate.bsbefore=r.bitrate.bsnow,r.bitrate.tsbefore=r.bitrate.tsnow}}})})},1e3),"0 kbits/sec"):(Janus.warn("Getting the video bitrate unsupported by browser"),"Feature unsupported by browser"):"Invalid PeerConnection"}function _(e){Janus.error("WebRTC error:",e)}function W(e,a){Janus.log("Cleaning WebRTC stuff");var o=w[e];if(o){var t=o.webrtcStuff;if(t){if(!0===a){var s={janus:"hangup",transaction:Janus.randomString(12)};o.token&&(s.token=o.token),g&&(s.apisecret=g),Janus.debug("Sending hangup request (handle="+e+"):"),Janus.debug(s),n?(s.session_id=h,s.handle_id=e,r.send(JSON.stringify(s))):Janus.httpAPICall(i+"/"+h+"/"+e,{verb:"POST",withCredentials:l,body:s})}t.remoteStream=null,t.volume&&(t.volume.local&&t.volume.local.timer&&clearInterval(t.volume.local.timer),t.volume.remote&&t.volume.remote.timer&&clearInterval(t.volume.remote.timer)),t.volume={},t.bitrate.timer&&clearInterval(t.bitrate.timer),t.bitrate.timer=null,t.bitrate.bsnow=null,t.bitrate.bsbefore=null,t.bitrate.tsnow=null,t.bitrate.tsbefore=null,t.bitrate.value=null,!t.streamExternal&&t.myStream&&(Janus.log("Stopping local stream tracks"),Janus.stopAllTracks(t.myStream)),t.streamExternal=!1,t.myStream=null;try{t.pc.close()}catch(e){}t.pc=null,t.candidates=null,t.mySdp=null,t.remoteSdp=null,t.iceDone=!1,t.dataChannel={},t.dtmfSender=null,t.senderTransforms=null,t.receiverTransforms=null}o.oncleanup()}}function B(e){return Janus.debug("isAudioSendEnabled:",e),!e||!1!==e.audio&&(void 0===e.audioSend||null===e.audioSend||!0===e.audioSend)}function G(e){return Janus.debug("isAudioRecvEnabled:",e),!e||!1!==e.audio&&(void 0===e.audioRecv||null===e.audioRecv||!0===e.audioRecv)}function q(e){return Janus.debug("isVideoSendEnabled:",e),!e||!1!==e.video&&(void 0===e.videoSend||null===e.videoSend||!0===e.videoSend)}function z(e){return Janus.debug("isVideoRecvEnabled:",e),!e||!1!==e.video&&(void 0===e.videoRecv||null===e.videoRecv||!0===e.videoRecv)}D(e),this.getServer=function(){return i},this.isConnected=function(){return b},this.reconnect=function(e){(e=e||{}).success="function"==typeof e.success?e.success:Janus.noop,e.error="function"==typeof e.error?e.error:Janus.noop,e.reconnect=!0,D(e)},this.getSessionId=function(){return h},this.getInfo=function(e){!function(e){if((e=e||{}).success="function"==typeof e.success?e.success:Janus.noop,e.error="function"==typeof e.error?e.error:Janus.noop,Janus.log("Getting info on  instance"),!b)return Janus.warn("Is the server down? (connected=false)"),void e.error("Is the server down? (connected=false)");var a=Janus.randomString(12),o={janus:"info",transaction:a};v&&(o.token=v);g&&(o.apisecret=g);if(n)return k[a]=function(n){Janus.log("Server info:"),Janus.debug(n),"server_info"!==n.janus&&Janus.error("Ooops: "+n.error.code+" "+n.error.reason),e.success(n)},void r.send(JSON.stringify(o));Janus.httpAPICall(i,{verb:"POST",withCredentials:l,body:o,success:function(n){Janus.log("Server info:"),Janus.debug(n),"server_info"!==n.janus&&Janus.error("Ooops: "+n.error.code+" "+n.error.reason),e.success(n)},error:function(n,r){Janus.error(n+":",r),""===r?e.error(n+": Is the server down?"):e.error(n+": "+r)}})}(e)},this.destroy=function(t){!function(t){(t=t||{}).success="function"==typeof t.success?t.success:Janus.noop,t.error="function"==typeof t.error?t.error:Janus.noop;var s=!0===t.unload,d=!0;void 0!==t.notifyDestroyed&&null!==t.notifyDestroyed&&(d=!0===t.notifyDestroyed);var u=!0===t.cleanupHandles;if(Janus.log("Destroying session "+h+" (unload="+s+")"),!h)return Janus.warn("No session to destroy"),t.success(),void(d&&e.destroyed());if(u)for(var c in w)E(c,{noRequest:!0});if(!b)return Janus.warn("Is the server down? (connected=false)"),h=null,void t.success();var f={janus:"destroy",transaction:Janus.randomString(12)};v&&(f.token=v);g&&(f.apisecret=g);if(s)return n?(r.onclose=null,r.close(),r=null):navigator.sendBeacon(i+"/"+h,JSON.stringify(f)),Janus.log("Destroyed session:"),h=null,b=!1,t.success(),void(d&&e.destroyed());if(n){f.session_id=h;var p=function(){for(var e in a)r.removeEventListener(e,a[e]);r.removeEventListener("message",m),r.removeEventListener("error",J),o&&clearTimeout(o),r.close()},m=function(n){var r=JSON.parse(n.data);r.session_id==f.session_id&&r.transaction==f.transaction&&(p(),t.success(),d&&e.destroyed())},J=function(n){p(),t.error("Failed to destroy the server: Is the server down?"),d&&e.destroyed()};return r.addEventListener("message",m),r.addEventListener("error",J),void(1===r.readyState?r.send(JSON.stringify(f)):J())}Janus.httpAPICall(i+"/"+h,{verb:"POST",withCredentials:l,body:f,success:function(n){Janus.log("Destroyed session:"),Janus.debug(n),h=null,b=!1,"success"!==n.janus&&Janus.error("Ooops: "+n.error.code+" "+n.error.reason),t.success(),d&&e.destroyed()},error:function(n,r){Janus.error(n+":",r),h=null,b=!1,t.success(),d&&e.destroyed()}})}(t)},this.attach=function(e){!function(e){if((e=e||{}).success="function"==typeof e.success?e.success:Janus.noop,e.error="function"==typeof e.error?e.error:Janus.noop,e.consentDialog="function"==typeof e.consentDialog?e.consentDialog:Janus.noop,e.iceState="function"==typeof e.iceState?e.iceState:Janus.noop,e.mediaState="function"==typeof e.mediaState?e.mediaState:Janus.noop,e.webrtcState="function"==typeof e.webrtcState?e.webrtcState:Janus.noop,e.slowLink="function"==typeof e.slowLink?e.slowLink:Janus.noop,e.onmessage="function"==typeof e.onmessage?e.onmessage:Janus.noop,e.onlocalstream="function"==typeof e.onlocalstream?e.onlocalstream:Janus.noop,e.onremotestream="function"==typeof e.onremotestream?e.onremotestream:Janus.noop,e.ondata="function"==typeof e.ondata?e.ondata:Janus.noop,e.ondataopen="function"==typeof e.ondataopen?e.ondataopen:Janus.noop,e.oncleanup="function"==typeof e.oncleanup?e.oncleanup:Janus.noop,e.ondetached="function"==typeof e.ondetached?e.ondetached:Janus.noop,!b)return Janus.warn("Is the server down? (connected=false)"),void e.error("Is the server down? (connected=false)");var a=e.plugin;if(!a)return Janus.error("Invalid plugin"),void e.error("Invalid plugin");var o=e.opaqueId,t=e.token?e.token:v,s=Janus.randomString(12),d={janus:"attach",plugin:a,opaque_id:o,transaction:s};t&&(d.token=t);g&&(d.apisecret=g);if(n)return k[s]=function(n){if(Janus.debug(n),"success"!==n.janus)return Janus.error("Ooops: "+n.error.code+" "+n.error.reason),void e.error("Ooops: "+n.error.code+" "+n.error.reason);var r=n.data.id;Janus.log("Created handle: "+r);var o={session:S,plugin:a,id:r,token:t,detached:!1,webrtcStuff:{started:!1,myStream:null,streamExternal:!1,remoteStream:null,mySdp:null,mediaConstraints:null,pc:null,dataChannel:{},dtmfSender:null,trickle:!0,iceDone:!1,volume:{value:null,timer:null},bitrate:{value:null,bsnow:null,bsbefore:null,tsnow:null,tsbefore:null,timer:null}},getId:function(){return r},getPlugin:function(){return a},getVolume:function(){return L(r,!0)},getRemoteVolume:function(){return L(r,!0)},getLocalVolume:function(){return L(r,!1)},isAudioMuted:function(){return N(r,!1)},muteAudio:function(){return F(r,!1,!0)},unmuteAudio:function(){return F(r,!1,!1)},isVideoMuted:function(){return N(r,!0)},muteVideo:function(){return F(r,!0,!0)},unmuteVideo:function(){return F(r,!0,!1)},getBitrate:function(){return U(r)},send:function(e){R(r,e)},data:function(e){P(r,e)},dtmf:function(e){x(r,e)},consentDialog:e.consentDialog,iceState:e.iceState,mediaState:e.mediaState,webrtcState:e.webrtcState,slowLink:e.slowLink,onmessage:e.onmessage,createOffer:function(e){j(r,!0,e)},createAnswer:function(e){j(r,!1,e)},handleRemoteJsep:function(e){O(r,e)},onlocalstream:e.onlocalstream,onremotestream:e.onremotestream,ondata:e.ondata,ondataopen:e.ondataopen,oncleanup:e.oncleanup,ondetached:e.ondetached,hangup:function(e){W(r,!0===e)},detach:function(e){E(r,e)}};w[r]=o,e.success(o)},d.session_id=h,void r.send(JSON.stringify(d));Janus.httpAPICall(i+"/"+h,{verb:"POST",withCredentials:l,body:d,success:function(n){if(Janus.debug(n),"success"!==n.janus)return Janus.error("Ooops: "+n.error.code+" "+n.error.reason),void e.error("Ooops: "+n.error.code+" "+n.error.reason);var r=n.data.id;Janus.log("Created handle: "+r);var o={session:S,plugin:a,id:r,token:t,detached:!1,webrtcStuff:{started:!1,myStream:null,streamExternal:!1,remoteStream:null,mySdp:null,mediaConstraints:null,pc:null,dataChannel:{},dtmfSender:null,trickle:!0,iceDone:!1,volume:{value:null,timer:null},bitrate:{value:null,bsnow:null,bsbefore:null,tsnow:null,tsbefore:null,timer:null}},getId:function(){return r},getPlugin:function(){return a},getVolume:function(){return L(r,!0)},getRemoteVolume:function(){return L(r,!0)},getLocalVolume:function(){return L(r,!1)},isAudioMuted:function(){return N(r,!1)},muteAudio:function(){return F(r,!1,!0)},unmuteAudio:function(){return F(r,!1,!1)},isVideoMuted:function(){return N(r,!0)},muteVideo:function(){return F(r,!0,!0)},unmuteVideo:function(){return F(r,!0,!1)},getBitrate:function(){return U(r)},send:function(e){R(r,e)},data:function(e){P(r,e)},dtmf:function(e){x(r,e)},consentDialog:e.consentDialog,iceState:e.iceState,mediaState:e.mediaState,webrtcState:e.webrtcState,slowLink:e.slowLink,onmessage:e.onmessage,createOffer:function(e){j(r,!0,e)},createAnswer:function(e){j(r,!1,e)},handleRemoteJsep:function(e){O(r,e)},onlocalstream:e.onlocalstream,onremotestream:e.onremotestream,ondata:e.ondata,ondataopen:e.ondataopen,oncleanup:e.oncleanup,ondetached:e.ondetached,hangup:function(e){W(r,!0===e)},detach:function(e){E(r,e)}};w[r]=o,e.success(o)},error:function(n,r){Janus.error(n+":",r),""===r?e.error(n+": Is the server down?"):e.error(n+": "+r)}})}(e)}}Janus.useDefaultDependencies=function(e){var n=e&&e.fetch||fetch,r=e&&e.Promise||Promise,a=e&&e.WebSocket||WebSocket;return{newWebSocket:function(e,n){return new a(e,n)},extension:e&&e.extension||defaultExtension,isArray:function(e){return Array.isArray(e)},webRTCAdapter:e&&e.adapter||adapter,httpAPICall:function(e,a){var o={method:a.verb,headers:{Accept:"application/json, text/plain, */*"},cache:"no-cache"};"POST"===a.verb&&(o.headers["Content-Type"]="application/json"),void 0!==a.withCredentials&&(o.credentials=!0===a.withCredentials?"include":a.withCredentials?a.withCredentials:"omit"),a.body&&(o.body=JSON.stringify(a.body));var t=n(e,o).catch(function(e){return r.reject({message:"Probably a network error, is the server down?",error:e})});if(a.timeout){var s=new r(function(e,n){var r=setTimeout(function(){return clearTimeout(r),n({message:"Request timed out",timeout:a.timeout})},a.timeout)});t=r.race([t,s])}return t.then(function(e){return e.ok?typeof a.success==typeof Janus.noop?e.json().then(function(e){a.success(e)}).catch(function(n){return r.reject({message:"Failed to parse response body",error:n,response:e})}):void 0:r.reject({message:"API call failed",response:e})}).catch(function(e){typeof a.error==typeof Janus.noop&&a.error(e.message||"<< internal error >>",e)}),t}}},Janus.useOldDependencies=function(e){var n=e&&e.jQuery||jQuery,r=e&&e.WebSocket||WebSocket;return{newWebSocket:function(e,n){return new r(e,n)},isArray:function(e){return n.isArray(e)},extension:e&&e.extension||defaultExtension,webRTCAdapter:e&&e.adapter||adapter,httpAPICall:function(e,r){var a=void 0!==r.body?{contentType:"application/json",data:JSON.stringify(r.body)}:{},o=void 0!==r.withCredentials?{xhrFields:{withCredentials:r.withCredentials}}:{};return n.ajax(n.extend(a,o,{url:e,type:r.verb,cache:!1,dataType:"json",async:r.async,timeout:r.timeout,success:function(e){typeof r.success==typeof Janus.noop&&r.success(e)},error:function(e,n,a){typeof r.error==typeof Janus.noop&&r.error(n,a)}}))}}},Janus.noop=function(){},Janus.dataChanDefaultLabel="JanusDataChannel",Janus.endOfCandidates=null,Janus.stopAllTracks=function(e){try{var n=e.getTracks();for(var r of n)Janus.log(r),r&&r.stop()}catch(e){}},Janus.init=function(e){if((e=e||{}).callback="function"==typeof e.callback?e.callback:Janus.noop,Janus.initDone)e.callback();else{if("undefined"!=typeof console&&void 0!==console.log||(console={log:function(){}}),Janus.trace=Janus.noop,Janus.debug=Janus.noop,Janus.vdebug=Janus.noop,Janus.log=Janus.noop,Janus.warn=Janus.noop,Janus.error=Janus.noop,!0===e.debug||"all"===e.debug)Janus.trace=console.trace.bind(console),Janus.debug=console.debug.bind(console),Janus.vdebug=console.debug.bind(console),Janus.log=console.log.bind(console),Janus.warn=console.warn.bind(console),Janus.error=console.error.bind(console);else if(Array.isArray(e.debug))for(var n of e.debug)switch(n){case"trace":Janus.trace=console.trace.bind(console);break;case"debug":Janus.debug=console.debug.bind(console);break;case"vdebug":Janus.vdebug=console.debug.bind(console);break;case"log":Janus.log=console.log.bind(console);break;case"warn":Janus.warn=console.warn.bind(console);break;case"error":Janus.error=console.error.bind(console);break;default:console.error("Unknown debugging option '"+n+"' (supported: 'trace', 'debug', 'vdebug', 'log', warn', 'error')")}Janus.log("Initializing library");var r=e.dependencies||Janus.useDefaultDependencies();Janus.isArray=r.isArray,Janus.webRTCAdapter=r.webRTCAdapter,Janus.httpAPICall=r.httpAPICall,Janus.newWebSocket=r.newWebSocket,Janus.extension=r.extension,Janus.extension.init(),Janus.listDevices=function(e,n){e="function"==typeof e?e:Janus.noop,null==n&&(n={audio:!0,video:!0}),Janus.isGetUserMediaAvailable()?navigator.mediaDevices.getUserMedia(n).then(function(n){navigator.mediaDevices.enumerateDevices().then(function(r){Janus.debug(r),e(r),Janus.stopAllTracks(n)})}).catch(function(n){Janus.error(n),e([])}):(Janus.warn("navigator.mediaDevices unavailable"),e([]))},Janus.attachMediaStream=function(e,n){try{e.srcObject=n}catch(r){try{e.src=URL.createObjectURL(n)}catch(e){Janus.error("Error attaching stream to element")}}},Janus.reattachMediaStream=function(e,n){try{e.srcObject=n.srcObject}catch(r){try{e.src=n.src}catch(e){Janus.error("Error reattaching stream to element")}}};var a=["iPad","iPhone","iPod"].indexOf(navigator.platform)>=0?"pagehide":"beforeunload",o=window["on"+a];if(window.addEventListener(a,function(e){for(var n in Janus.log("Closing window"),Janus.sessions)Janus.sessions[n]&&Janus.sessions[n].destroyOnUnload&&(Janus.log("Destroying session "+n),Janus.sessions[n].destroy({unload:!0,notifyDestroyed:!1}));o&&"function"==typeof o&&o()}),Janus.safariVp8=!1,"safari"===Janus.webRTCAdapter.browserDetails.browser&&Janus.webRTCAdapter.browserDetails.version>=605)if(RTCRtpSender&&RTCRtpSender.getCapabilities&&RTCRtpSender.getCapabilities("video")&&RTCRtpSender.getCapabilities("video").codecs&&RTCRtpSender.getCapabilities("video").codecs.length){for(var t of RTCRtpSender.getCapabilities("video").codecs)if(t&&t.mimeType&&"video/vp8"===t.mimeType.toLowerCase()){Janus.safariVp8=!0;break}Janus.safariVp8?Janus.log("This version of Safari supports VP8"):Janus.warn("This version of Safari does NOT support VP8: if you're using a Technology Preview, try enabling the 'WebRTC VP8 codec' setting in the 'Experimental Features' Develop menu")}else{var s=new RTCPeerConnection({});s.createOffer({offerToReceiveVideo:!0}).then(function(e){Janus.safariVp8=-1!==e.sdp.indexOf("VP8"),Janus.safariVp8?Janus.log("This version of Safari supports VP8"):Janus.warn("This version of Safari does NOT support VP8: if you're using a Technology Preview, try enabling the 'WebRTC VP8 codec' setting in the 'Experimental Features' Develop menu"),s.close(),s=null})}if(Janus.unifiedPlan=!1,"firefox"===Janus.webRTCAdapter.browserDetails.browser&&Janus.webRTCAdapter.browserDetails.version>=59)Janus.unifiedPlan=!0;else if("chrome"===Janus.webRTCAdapter.browserDetails.browser&&Janus.webRTCAdapter.browserDetails.version>=72)Janus.unifiedPlan=!0;else if(window.RTCRtpTransceiver&&"currentDirection"in RTCRtpTransceiver.prototype){var i=new RTCPeerConnection;try{i.addTransceiver("audio"),Janus.unifiedPlan=!0}catch(e){}i.close()}else Janus.unifiedPlan=!1;Janus.initDone=!0,e.callback()}},Janus.isWebrtcSupported=function(){return!!window.RTCPeerConnection},Janus.isGetUserMediaAvailable=function(){return navigator.mediaDevices&&navigator.mediaDevices.getUserMedia},Janus.randomString=function(e){for(var n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",r="",a=0;a<e;a++){var o=Math.floor(Math.random()*n.length);r+=n.substring(o,o+1)}return r};