Janus.sessions={};Janus.isExtensionEnabled=function(){if(navigator.mediaDevices&&navigator.mediaDevices.getDisplayMedia){return true}if(window.navigator.userAgent.match("Chrome")){var chromever=parseInt(window.navigator.userAgent.match(/Chrome\/(.*) /)[1],10);var maxver=33;if(window.navigator.userAgent.match("Linux"))maxver=35;if(chromever>=26&&chromever<=maxver){return true}return Janus.extension.isInstalled()}else{return true}};var defaultExtension={extensionId:"hapfgfdkleiggjjpfpenajgdnfckjpaj",isInstalled:function(){return document.querySelector("#janus-extension-installed")!==null},getScreen:function(callback){var pending=window.setTimeout(function(){var error=new Error("NavigatorUserMediaError");error.name='The required Chrome extension is not installed: click <a href="#">here</a> to install it. (NOTE: this will need you to refresh the page)';return callback(error)},1e3);this.cache[pending]=callback;window.postMessage({type:"janusGetScreen",id:pending},"*")},init:function(){var cache={};this.cache=cache;window.addEventListener("message",function(event){if(event.origin!=window.location.origin)return;if(event.data.type=="janusGotScreen"&&cache[event.data.id]){var callback=cache[event.data.id];delete cache[event.data.id];if(event.data.sourceId===""){var error=new Error("NavigatorUserMediaError");error.name="You cancelled the request for permission, giving up...";callback(error)}else{callback(null,event.data.sourceId)}}else if(event.data.type=="janusGetScreenPending"){console.log("clearing ",event.data.id);window.clearTimeout(event.data.id)}})}};Janus.useDefaultDependencies=function(deps){var f=deps&&deps.fetch||fetch;var p=deps&&deps.Promise||Promise;var socketCls=deps&&deps.WebSocket||WebSocket;return{newWebSocket:function(server,proto){return new socketCls(server,proto)},extension:deps&&deps.extension||defaultExtension,isArray:function(arr){return Array.isArray(arr)},webRTCAdapter:deps&&deps.adapter||adapter,httpAPICall:function(url,options){var fetchOptions={method:options.verb,headers:{Accept:"application/json, text/plain, */*"},cache:"no-cache"};if(options.verb==="POST"){fetchOptions.headers["Content-Type"]="application/json"}if(options.withCredentials!==undefined){fetchOptions.credentials=options.withCredentials===true?"include":options.withCredentials?options.withCredentials:"omit"}if(options.body){fetchOptions.body=JSON.stringify(options.body)}var fetching=f(url,fetchOptions).catch(function(error){return p.reject({message:"Probably a network error, is the server down?",error:error})});if(options.timeout){var timeout=new p(function(resolve,reject){var timerId=setTimeout(function(){clearTimeout(timerId);return reject({message:"Request timed out",timeout:options.timeout})},options.timeout)});fetching=p.race([fetching,timeout])}fetching.then(function(response){if(response.ok){if(typeof options.success===typeof Janus.noop){return response.json().then(function(parsed){options.success(parsed)}).catch(function(error){return p.reject({message:"Failed to parse response body",error:error,response:response})})}}else{return p.reject({message:"API call failed",response:response})}}).catch(function(error){if(typeof options.error===typeof Janus.noop){options.error(error.message||"<< internal error >>",error)}});return fetching}}};Janus.useOldDependencies=function(deps){var jq=deps&&deps.jQuery||jQuery;var socketCls=deps&&deps.WebSocket||WebSocket;return{newWebSocket:function(server,proto){return new socketCls(server,proto)},isArray:function(arr){return jq.isArray(arr)},extension:deps&&deps.extension||defaultExtension,webRTCAdapter:deps&&deps.adapter||adapter,httpAPICall:function(url,options){var payload=options.body!==undefined?{contentType:"application/json",data:JSON.stringify(options.body)}:{};var credentials=options.withCredentials!==undefined?{xhrFields:{withCredentials:options.withCredentials}}:{};return jq.ajax(jq.extend(payload,credentials,{url:url,type:options.verb,cache:false,dataType:"json",async:options.async,timeout:options.timeout,success:function(result){if(typeof options.success===typeof Janus.noop){options.success(result)}},error:function(xhr,status,err){if(typeof options.error===typeof Janus.noop){options.error(status,err)}}}))}}};Janus.noop=function(){};Janus.dataChanDefaultLabel="JanusDataChannel";Janus.endOfCandidates=null;Janus.stopAllTracks=function(stream){try{var tracks=stream.getTracks();for(var mst of tracks){Janus.log(mst);if(mst){mst.stop()}}}catch(e){}};Janus.init=function(options){options=options||{};options.callback=typeof options.callback=="function"?options.callback:Janus.noop;if(Janus.initDone){options.callback()}else{if(typeof console=="undefined"||typeof console.log=="undefined"){console={log:function(){}}}Janus.trace=Janus.noop;Janus.debug=Janus.noop;Janus.vdebug=Janus.noop;Janus.log=Janus.noop;Janus.warn=Janus.noop;Janus.error=Janus.noop;if(options.debug===true||options.debug==="all"){Janus.trace=console.trace.bind(console);Janus.debug=console.debug.bind(console);Janus.vdebug=console.debug.bind(console);Janus.log=console.log.bind(console);Janus.warn=console.warn.bind(console);Janus.error=console.error.bind(console)}else if(Array.isArray(options.debug)){for(var d of options.debug){switch(d){case"trace":Janus.trace=console.trace.bind(console);break;case"debug":Janus.debug=console.debug.bind(console);break;case"vdebug":Janus.vdebug=console.debug.bind(console);break;case"log":Janus.log=console.log.bind(console);break;case"warn":Janus.warn=console.warn.bind(console);break;case"error":Janus.error=console.error.bind(console);break;default:console.error("Unknown debugging option '"+d+"' (supported: 'trace', 'debug', 'vdebug', 'log', warn', 'error')");break}}}Janus.log("Initializing library");var usedDependencies=options.dependencies||Janus.useDefaultDependencies();Janus.isArray=usedDependencies.isArray;Janus.webRTCAdapter=usedDependencies.webRTCAdapter;Janus.httpAPICall=usedDependencies.httpAPICall;Janus.newWebSocket=usedDependencies.newWebSocket;Janus.extension=usedDependencies.extension;Janus.extension.init();Janus.listDevices=function(callback,config){callback=typeof callback=="function"?callback:Janus.noop;if(config==null)config={audio:true,video:true};if(Janus.isGetUserMediaAvailable()){navigator.mediaDevices.getUserMedia(config).then(function(stream){navigator.mediaDevices.enumerateDevices().then(function(devices){Janus.debug(devices);callback(devices);Janus.stopAllTracks(stream)})}).catch(function(err){Janus.error(err);callback([])})}else{Janus.warn("navigator.mediaDevices unavailable");callback([])}};Janus.attachMediaStream=function(element,stream){try{element.srcObject=stream}catch(e){try{element.src=URL.createObjectURL(stream)}catch(e){Janus.error("Error attaching stream to element")}}};Janus.reattachMediaStream=function(to,from){try{to.srcObject=from.srcObject}catch(e){try{to.src=from.src}catch(e){Janus.error("Error reattaching stream to element")}}};var iOS=["iPad","iPhone","iPod"].indexOf(navigator.platform)>=0;var eventName=iOS?"pagehide":"beforeunload";var oldOBF=window["on"+eventName];window.addEventListener(eventName,function(event){Janus.log("Closing window");for(var s in Janus.sessions){if(Janus.sessions[s]&&Janus.sessions[s].destroyOnUnload){Janus.log("Destroying session "+s);Janus.sessions[s].destroy({unload:true,notifyDestroyed:false})}}if(oldOBF&&typeof oldOBF=="function"){oldOBF()}});Janus.safariVp8=false;if(Janus.webRTCAdapter.browserDetails.browser==="safari"&&Janus.webRTCAdapter.browserDetails.version>=605){if(RTCRtpSender&&RTCRtpSender.getCapabilities&&RTCRtpSender.getCapabilities("video")&&RTCRtpSender.getCapabilities("video").codecs&&RTCRtpSender.getCapabilities("video").codecs.length){for(var codec of RTCRtpSender.getCapabilities("video").codecs){if(codec&&codec.mimeType&&codec.mimeType.toLowerCase()==="video/vp8"){Janus.safariVp8=true;break}}if(Janus.safariVp8){Janus.log("This version of Safari supports VP8")}else{Janus.warn("This version of Safari does NOT support VP8: if you're using a Technology Preview, "+"try enabling the 'WebRTC VP8 codec' setting in the 'Experimental Features' Develop menu")}}else{var testpc=new RTCPeerConnection({});testpc.createOffer({offerToReceiveVideo:true}).then(function(offer){Janus.safariVp8=offer.sdp.indexOf("VP8")!==-1;if(Janus.safariVp8){Janus.log("This version of Safari supports VP8")}else{Janus.warn("This version of Safari does NOT support VP8: if you're using a Technology Preview, "+"try enabling the 'WebRTC VP8 codec' setting in the 'Experimental Features' Develop menu")}testpc.close();testpc=null})}}Janus.unifiedPlan=false;if(Janus.webRTCAdapter.browserDetails.browser==="firefox"&&Janus.webRTCAdapter.browserDetails.version>=59){Janus.unifiedPlan=true}else if(Janus.webRTCAdapter.browserDetails.browser==="chrome"&&Janus.webRTCAdapter.browserDetails.version>=72){Janus.unifiedPlan=true}else if(!window.RTCRtpTransceiver||!("currentDirection"in RTCRtpTransceiver.prototype)){Janus.unifiedPlan=false}else{var tempPc=new RTCPeerConnection;try{tempPc.addTransceiver("audio");Janus.unifiedPlan=true}catch(e){}tempPc.close()}Janus.initDone=true;options.callback()}};Janus.isWebrtcSupported=function(){return!!window.RTCPeerConnection};Janus.isGetUserMediaAvailable=function(){return navigator.mediaDevices&&navigator.mediaDevices.getUserMedia};Janus.randomString=function(len){var charSet="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";var randomString="";for(var i=0;i<len;i++){var randomPoz=Math.floor(Math.random()*charSet.length);randomString+=charSet.substring(randomPoz,randomPoz+1)}return randomString};function Janus(gatewayCallbacks){gatewayCallbacks=gatewayCallbacks||{};gatewayCallbacks.success=typeof gatewayCallbacks.success=="function"?gatewayCallbacks.success:Janus.noop;gatewayCallbacks.error=typeof gatewayCallbacks.error=="function"?gatewayCallbacks.error:Janus.noop;gatewayCallbacks.destroyed=typeof gatewayCallbacks.destroyed=="function"?gatewayCallbacks.destroyed:Janus.noop;if(!Janus.initDone){gatewayCallbacks.error("Library not initialized");return{}}if(!Janus.isWebrtcSupported()){gatewayCallbacks.error("WebRTC not supported by this browser");return{}}Janus.log("Library initialized: "+Janus.initDone);if(!gatewayCallbacks.server){gatewayCallbacks.error("Invalid server url");return{}}var websockets=false;var ws=null;var wsHandlers={};var wsKeepaliveTimeoutId=null;var servers=null;var serversIndex=0;var server=gatewayCallbacks.server;if(Janus.isArray(server)){Janus.log("Multiple servers provided ("+server.length+"), will use the first that works");server=null;servers=gatewayCallbacks.server;Janus.debug(servers)}else{if(server.indexOf("ws")===0){websockets=true;Janus.log("Using WebSockets to contact Janus: "+server)}else{websockets=false;Janus.log("Using REST API to contact Janus: "+server)}}var iceServers=gatewayCallbacks.iceServers||[{urls:["stun:stun.hermetix.io:3478?transport=udp"]},{urls:"turn:turn.hermetix.io:3478?transport=tcp",username:"sassyn",credential:"manager11"}];var iceTransportPolicy=gatewayCallbacks.iceTransportPolicy;var bundlePolicy=gatewayCallbacks.bundlePolicy;var ipv6Support=gatewayCallbacks.ipv6===true;var withCredentials=false;if(gatewayCallbacks.withCredentials!==undefined&&gatewayCallbacks.withCredentials!==null)withCredentials=gatewayCallbacks.withCredentials===true;var maxev=10;if(gatewayCallbacks.max_poll_events!==undefined&&gatewayCallbacks.max_poll_events!==null)maxev=gatewayCallbacks.max_poll_events;if(maxev<1)maxev=1;var token=null;if(gatewayCallbacks.token!==undefined&&gatewayCallbacks.token!==null)token=gatewayCallbacks.token;var apisecret=null;if(gatewayCallbacks.apisecret!==undefined&&gatewayCallbacks.apisecret!==null)apisecret=gatewayCallbacks.apisecret;this.destroyOnUnload=true;if(gatewayCallbacks.destroyOnUnload!==undefined&&gatewayCallbacks.destroyOnUnload!==null)this.destroyOnUnload=gatewayCallbacks.destroyOnUnload===true;var keepAlivePeriod=25e3;if(gatewayCallbacks.keepAlivePeriod!==undefined&&gatewayCallbacks.keepAlivePeriod!==null)keepAlivePeriod=gatewayCallbacks.keepAlivePeriod;if(isNaN(keepAlivePeriod))keepAlivePeriod=25e3;var longPollTimeout=6e4;if(gatewayCallbacks.longPollTimeout!==undefined&&gatewayCallbacks.longPollTimeout!==null)longPollTimeout=gatewayCallbacks.longPollTimeout;if(isNaN(longPollTimeout))longPollTimeout=6e4;function getMaxBitrates(simulcastMaxBitrates){var maxBitrates={high:9e5,medium:3e5,low:1e5};if(simulcastMaxBitrates!==undefined&&simulcastMaxBitrates!==null){if(simulcastMaxBitrates.high)maxBitrates.high=simulcastMaxBitrates.high;if(simulcastMaxBitrates.medium)maxBitrates.medium=simulcastMaxBitrates.medium;if(simulcastMaxBitrates.low)maxBitrates.low=simulcastMaxBitrates.low}return maxBitrates}var connected=false;var sessionId=null;var pluginHandles={};var that=this;var retries=0;var transactions={};createSession(gatewayCallbacks);this.getServer=function(){return server};this.isConnected=function(){return connected};this.reconnect=function(callbacks){callbacks=callbacks||{};callbacks.success=typeof callbacks.success=="function"?callbacks.success:Janus.noop;callbacks.error=typeof callbacks.error=="function"?callbacks.error:Janus.noop;callbacks["reconnect"]=true;createSession(callbacks)};this.getSessionId=function(){return sessionId};this.getInfo=function(callbacks){getInfo(callbacks)};this.destroy=function(callbacks){destroySession(callbacks)};this.attach=function(callbacks){createHandle(callbacks)};function eventHandler(){if(sessionId==null)return;Janus.debug("Long poll...");if(!connected){Janus.warn("Is the server down? (connected=false)");return}var longpoll=server+"/"+sessionId+"?rid="+(new Date).getTime();if(maxev)longpoll=longpoll+"&maxev="+maxev;if(token)longpoll=longpoll+"&token="+encodeURIComponent(token);if(apisecret)longpoll=longpoll+"&apisecret="+encodeURIComponent(apisecret);Janus.httpAPICall(longpoll,{verb:"GET",withCredentials:withCredentials,success:handleEvent,timeout:longPollTimeout,error:function(textStatus,errorThrown){Janus.error(textStatus+":",errorThrown);retries++;if(retries>3){connected=false;gatewayCallbacks.error("Lost connection to the server (is it down?)");return}eventHandler()}})}function handleEvent(json,skipTimeout){retries=0;if(!websockets&&sessionId!==undefined&&sessionId!==null&&skipTimeout!==true)eventHandler();if(!websockets&&Janus.isArray(json)){for(var i=0;i<json.length;i++){handleEvent(json[i],true)}return}if(json["janus"]==="keepalive"){Janus.vdebug("Got a keepalive on session "+sessionId);return}else if(json["janus"]==="server_info"){Janus.debug("Got info on the Janus instance");Janus.debug(json);var transaction=json["transaction"];if(transaction){var reportSuccess=transactions[transaction];if(reportSuccess)reportSuccess(json);delete transactions[transaction]}return}else if(json["janus"]==="ack"){Janus.debug("Got an ack on session "+sessionId);Janus.debug(json);var transaction=json["transaction"];if(transaction){var reportSuccess=transactions[transaction];if(reportSuccess)reportSuccess(json);delete transactions[transaction]}return}else if(json["janus"]==="success"){Janus.debug("Got a success on session "+sessionId);Janus.debug(json);var transaction=json["transaction"];if(transaction){var reportSuccess=transactions[transaction];if(reportSuccess)reportSuccess(json);delete transactions[transaction]}return}else if(json["janus"]==="trickle"){var sender=json["sender"];if(!sender){Janus.warn("Missing sender...");return}var pluginHandle=pluginHandles[sender];if(!pluginHandle){Janus.debug("This handle is not attached to this session");return}var candidate=json["candidate"];Janus.debug("Got a trickled candidate on session "+sessionId);Janus.debug(candidate);var config=pluginHandle.webrtcStuff;if(config.pc&&config.remoteSdp){Janus.debug("Adding remote candidate:",candidate);if(!candidate||candidate.completed===true){config.pc.addIceCandidate(Janus.endOfCandidates)}else{config.pc.addIceCandidate(candidate)}}else{Janus.debug("We didn't do setRemoteDescription (trickle got here before the offer?), caching candidate");if(!config.candidates)config.candidates=[];config.candidates.push(candidate);Janus.debug(config.candidates)}}else if(json["janus"]==="webrtcup"){Janus.debug("Got a webrtcup event on session "+sessionId);Janus.debug(json);var sender=json["sender"];if(!sender){Janus.warn("Missing sender...");return}var pluginHandle=pluginHandles[sender];if(!pluginHandle){Janus.debug("This handle is not attached to this session");return}pluginHandle.webrtcState(true);return}else if(json["janus"]==="hangup"){Janus.debug("Got a hangup event on session "+sessionId);Janus.debug(json);var sender=json["sender"];if(!sender){Janus.warn("Missing sender...");return}var pluginHandle=pluginHandles[sender];if(!pluginHandle){Janus.debug("This handle is not attached to this session");return}pluginHandle.webrtcState(false,json["reason"]);pluginHandle.hangup()}else if(json["janus"]==="detached"){Janus.debug("Got a detached event on session "+sessionId);Janus.debug(json);var sender=json["sender"];if(!sender){Janus.warn("Missing sender...");return}var pluginHandle=pluginHandles[sender];if(!pluginHandle){return}pluginHandle.detached=true;pluginHandle.ondetached();pluginHandle.detach()}else if(json["janus"]==="media"){Janus.debug("Got a media event on session "+sessionId);Janus.debug(json);var sender=json["sender"];if(!sender){Janus.warn("Missing sender...");return}var pluginHandle=pluginHandles[sender];if(!pluginHandle){Janus.debug("This handle is not attached to this session");return}pluginHandle.mediaState(json["type"],json["receiving"])}else if(json["janus"]==="slowlink"){Janus.debug("Got a slowlink event on session "+sessionId);Janus.debug(json);var sender=json["sender"];if(!sender){Janus.warn("Missing sender...");return}var pluginHandle=pluginHandles[sender];if(!pluginHandle){Janus.debug("This handle is not attached to this session");return}pluginHandle.slowLink(json["uplink"],json["lost"])}else if(json["janus"]==="error"){Janus.error("Ooops: "+json["error"].code+" "+json["error"].reason);Janus.debug(json);var transaction=json["transaction"];if(transaction){var reportSuccess=transactions[transaction];if(reportSuccess){reportSuccess(json)}delete transactions[transaction]}return}else if(json["janus"]==="event"){Janus.debug("Got a plugin event on session "+sessionId);Janus.debug(json);var sender=json["sender"];if(!sender){Janus.warn("Missing sender...");return}var plugindata=json["plugindata"];if(!plugindata){Janus.warn("Missing plugindata...");return}Janus.debug("  -- Event is coming from "+sender+" ("+plugindata["plugin"]+")");var data=plugindata["data"];Janus.debug(data);var pluginHandle=pluginHandles[sender];if(!pluginHandle){Janus.warn("This handle is not attached to this session");return}var jsep=json["jsep"];if(jsep){Janus.debug("Handling SDP as well...");Janus.debug(jsep)}var callback=pluginHandle.onmessage;if(callback){Janus.debug("Notifying application...");callback(data,jsep)}else{Janus.debug("No provided notification callback")}}else if(json["janus"]==="timeout"){Janus.error("Timeout on session "+sessionId);Janus.debug(json);if(websockets){ws.close(3504,"Gateway timeout")}return}else{Janus.warn("Unknown message/event  '"+json["janus"]+"' on session "+sessionId);Janus.debug(json)}}function keepAlive(){if(!server||!websockets||!connected)return;wsKeepaliveTimeoutId=setTimeout(keepAlive,keepAlivePeriod);var request={janus:"keepalive",session_id:sessionId,transaction:Janus.randomString(12)};if(token)request["token"]=token;if(apisecret)request["apisecret"]=apisecret;ws.send(JSON.stringify(request))}function createSession(callbacks){var transaction=Janus.randomString(12);var request={janus:"create",transaction:transaction};if(callbacks["reconnect"]){connected=false;request["janus"]="claim";request["session_id"]=sessionId;if(ws){ws.onopen=null;ws.onerror=null;ws.onclose=null;if(wsKeepaliveTimeoutId){clearTimeout(wsKeepaliveTimeoutId);wsKeepaliveTimeoutId=null}}}if(token)request["token"]=token;if(apisecret)request["apisecret"]=apisecret;if(!server&&Janus.isArray(servers)){server=servers[serversIndex];if(server.indexOf("ws")===0){websockets=true;Janus.log("Server #"+(serversIndex+1)+": trying WebSockets to contact Janus ("+server+")")}else{websockets=false;Janus.log("Server #"+(serversIndex+1)+": trying REST API to contact Janus ("+server+")")}}if(websockets){ws=Janus.newWebSocket(server,"janus-protocol");wsHandlers={error:function(){Janus.error("Error connecting to the Janus WebSockets server... "+server);if(Janus.isArray(servers)&&!callbacks["reconnect"]){serversIndex++;if(serversIndex===servers.length){callbacks.error("Error connecting to any of the provided Janus servers: Is the server down?");return}server=null;setTimeout(function(){createSession(callbacks)},200);return}callbacks.error("Error connecting to the WebSockets server: Is the server down?")},open:function(){transactions[transaction]=function(json){Janus.debug(json);if(json["janus"]!=="success"){Janus.error("Ooops: "+json["error"].code+" "+json["error"].reason);callbacks.error(json["error"].reason);return}wsKeepaliveTimeoutId=setTimeout(keepAlive,keepAlivePeriod);connected=true;sessionId=json["session_id"]?json["session_id"]:json.data["id"];if(callbacks["reconnect"]){Janus.log("Claimed session: "+sessionId)}else{Janus.log("Created session: "+sessionId)}Janus.sessions[sessionId]=that;callbacks.success()};ws.send(JSON.stringify(request))},message:function(event){handleEvent(JSON.parse(event.data))},close:function(){if(!server||!connected){return}connected=false;gatewayCallbacks.error("Lost connection to the server (is it down?)")}};for(var eventName in wsHandlers){ws.addEventListener(eventName,wsHandlers[eventName])}return}Janus.httpAPICall(server,{verb:"POST",withCredentials:withCredentials,body:request,success:function(json){Janus.debug(json);if(json["janus"]!=="success"){Janus.error("Ooops: "+json["error"].code+" "+json["error"].reason);callbacks.error(json["error"].reason);return}connected=true;sessionId=json["session_id"]?json["session_id"]:json.data["id"];if(callbacks["reconnect"]){Janus.log("Claimed session: "+sessionId)}else{Janus.log("Created session: "+sessionId)}Janus.sessions[sessionId]=that;eventHandler();callbacks.success()},error:function(textStatus,errorThrown){Janus.error(textStatus+":",errorThrown);if(Janus.isArray(servers)&&!callbacks["reconnect"]){serversIndex++;if(serversIndex===servers.length){callbacks.error("Error connecting to any of the provided servers: Is the server down?");return}server=null;setTimeout(function(){createSession(callbacks)},200);return}if(errorThrown==="")callbacks.error(textStatus+": Is the server down?");else callbacks.error(textStatus+": "+errorThrown)}})}function getInfo(callbacks){callbacks=callbacks||{};callbacks.success=typeof callbacks.success=="function"?callbacks.success:Janus.noop;callbacks.error=typeof callbacks.error=="function"?callbacks.error:Janus.noop;Janus.log("Getting info on  instance");if(!connected){Janus.warn("Is the server down? (connected=false)");callbacks.error("Is the server down? (connected=false)");return}var transaction=Janus.randomString(12);var request={janus:"info",transaction:transaction};if(token)request["token"]=token;if(apisecret)request["apisecret"]=apisecret;if(websockets){transactions[transaction]=function(json){Janus.log("Server info:");Janus.debug(json);if(json["janus"]!=="server_info"){Janus.error("Ooops: "+json["error"].code+" "+json["error"].reason)}callbacks.success(json)};ws.send(JSON.stringify(request));return}Janus.httpAPICall(server,{verb:"POST",withCredentials:withCredentials,body:request,success:function(json){Janus.log("Server info:");Janus.debug(json);if(json["janus"]!=="server_info"){Janus.error("Ooops: "+json["error"].code+" "+json["error"].reason)}callbacks.success(json)},error:function(textStatus,errorThrown){Janus.error(textStatus+":",errorThrown);if(errorThrown==="")callbacks.error(textStatus+": Is the server down?");else callbacks.error(textStatus+": "+errorThrown)}})}function destroySession(callbacks){callbacks=callbacks||{};callbacks.success=typeof callbacks.success=="function"?callbacks.success:Janus.noop;callbacks.error=typeof callbacks.error=="function"?callbacks.error:Janus.noop;var unload=callbacks.unload===true;var notifyDestroyed=true;if(callbacks.notifyDestroyed!==undefined&&callbacks.notifyDestroyed!==null)notifyDestroyed=callbacks.notifyDestroyed===true;var cleanupHandles=callbacks.cleanupHandles===true;Janus.log("Destroying session "+sessionId+" (unload="+unload+")");if(!sessionId){Janus.warn("No session to destroy");callbacks.success();if(notifyDestroyed)gatewayCallbacks.destroyed();return}if(cleanupHandles){for(var handleId in pluginHandles)destroyHandle(handleId,{noRequest:true})}if(!connected){Janus.warn("Is the server down? (connected=false)");sessionId=null;callbacks.success();return}var request={janus:"destroy",transaction:Janus.randomString(12)};if(token)request["token"]=token;if(apisecret)request["apisecret"]=apisecret;if(unload){if(websockets){ws.onclose=null;ws.close();ws=null}else{navigator.sendBeacon(server+"/"+sessionId,JSON.stringify(request))}Janus.log("Destroyed session:");sessionId=null;connected=false;callbacks.success();if(notifyDestroyed)gatewayCallbacks.destroyed();return}if(websockets){request["session_id"]=sessionId;var unbindWebSocket=function(){for(var eventName in wsHandlers){ws.removeEventListener(eventName,wsHandlers[eventName])}ws.removeEventListener("message",onUnbindMessage);ws.removeEventListener("error",onUnbindError);if(wsKeepaliveTimeoutId){clearTimeout(wsKeepaliveTimeoutId)}ws.close()};var onUnbindMessage=function(event){var data=JSON.parse(event.data);if(data.session_id==request.session_id&&data.transaction==request.transaction){unbindWebSocket();callbacks.success();if(notifyDestroyed)gatewayCallbacks.destroyed()}};var onUnbindError=function(event){unbindWebSocket();callbacks.error("Failed to destroy the server: Is the server down?");if(notifyDestroyed)gatewayCallbacks.destroyed()};ws.addEventListener("message",onUnbindMessage);ws.addEventListener("error",onUnbindError);if(ws.readyState===1){ws.send(JSON.stringify(request))}else{onUnbindError()}return}Janus.httpAPICall(server+"/"+sessionId,{verb:"POST",withCredentials:withCredentials,body:request,success:function(json){Janus.log("Destroyed session:");Janus.debug(json);sessionId=null;connected=false;if(json["janus"]!=="success"){Janus.error("Ooops: "+json["error"].code+" "+json["error"].reason)}callbacks.success();if(notifyDestroyed)gatewayCallbacks.destroyed()},error:function(textStatus,errorThrown){Janus.error(textStatus+":",errorThrown);sessionId=null;connected=false;callbacks.success();if(notifyDestroyed)gatewayCallbacks.destroyed()}})}function createHandle(callbacks){callbacks=callbacks||{};callbacks.success=typeof callbacks.success=="function"?callbacks.success:Janus.noop;callbacks.error=typeof callbacks.error=="function"?callbacks.error:Janus.noop;callbacks.consentDialog=typeof callbacks.consentDialog=="function"?callbacks.consentDialog:Janus.noop;callbacks.iceState=typeof callbacks.iceState=="function"?callbacks.iceState:Janus.noop;callbacks.mediaState=typeof callbacks.mediaState=="function"?callbacks.mediaState:Janus.noop;callbacks.webrtcState=typeof callbacks.webrtcState=="function"?callbacks.webrtcState:Janus.noop;callbacks.slowLink=typeof callbacks.slowLink=="function"?callbacks.slowLink:Janus.noop;callbacks.onmessage=typeof callbacks.onmessage=="function"?callbacks.onmessage:Janus.noop;callbacks.onlocalstream=typeof callbacks.onlocalstream=="function"?callbacks.onlocalstream:Janus.noop;callbacks.onremotestream=typeof callbacks.onremotestream=="function"?callbacks.onremotestream:Janus.noop;callbacks.ondata=typeof callbacks.ondata=="function"?callbacks.ondata:Janus.noop;callbacks.ondataopen=typeof callbacks.ondataopen=="function"?callbacks.ondataopen:Janus.noop;callbacks.oncleanup=typeof callbacks.oncleanup=="function"?callbacks.oncleanup:Janus.noop;callbacks.ondetached=typeof callbacks.ondetached=="function"?callbacks.ondetached:Janus.noop;if(!connected){Janus.warn("Is the server down? (connected=false)");callbacks.error("Is the server down? (connected=false)");return}var plugin=callbacks.plugin;if(!plugin){Janus.error("Invalid plugin");callbacks.error("Invalid plugin");return}var opaqueId=callbacks.opaqueId;var handleToken=callbacks.token?callbacks.token:token;var transaction=Janus.randomString(12);var request={janus:"attach",plugin:plugin,opaque_id:opaqueId,transaction:transaction};if(handleToken)request["token"]=handleToken;if(apisecret)request["apisecret"]=apisecret;if(websockets){transactions[transaction]=function(json){Janus.debug(json);if(json["janus"]!=="success"){Janus.error("Ooops: "+json["error"].code+" "+json["error"].reason);callbacks.error("Ooops: "+json["error"].code+" "+json["error"].reason);return}var handleId=json.data["id"];Janus.log("Created handle: "+handleId);var pluginHandle={session:that,plugin:plugin,id:handleId,token:handleToken,detached:false,webrtcStuff:{started:false,myStream:null,streamExternal:false,remoteStream:null,mySdp:null,mediaConstraints:null,pc:null,dataChannel:{},dtmfSender:null,trickle:true,iceDone:false,volume:{value:null,timer:null},bitrate:{value:null,bsnow:null,bsbefore:null,tsnow:null,tsbefore:null,timer:null}},getId:function(){return handleId},getPlugin:function(){return plugin},getVolume:function(){return getVolume(handleId,true)},getRemoteVolume:function(){return getVolume(handleId,true)},getLocalVolume:function(){return getVolume(handleId,false)},isAudioMuted:function(){return isMuted(handleId,false)},muteAudio:function(){return mute(handleId,false,true)},unmuteAudio:function(){return mute(handleId,false,false)},isVideoMuted:function(){return isMuted(handleId,true)},muteVideo:function(){return mute(handleId,true,true)},unmuteVideo:function(){return mute(handleId,true,false)},getBitrate:function(){return getBitrate(handleId)},send:function(callbacks){sendMessage(handleId,callbacks)},data:function(callbacks){sendData(handleId,callbacks)},dtmf:function(callbacks){sendDtmf(handleId,callbacks)},consentDialog:callbacks.consentDialog,iceState:callbacks.iceState,mediaState:callbacks.mediaState,webrtcState:callbacks.webrtcState,slowLink:callbacks.slowLink,onmessage:callbacks.onmessage,createOffer:function(callbacks){prepareWebrtc(handleId,true,callbacks)},createAnswer:function(callbacks){prepareWebrtc(handleId,false,callbacks)},handleRemoteJsep:function(callbacks){prepareWebrtcPeer(handleId,callbacks)},onlocalstream:callbacks.onlocalstream,onremotestream:callbacks.onremotestream,ondata:callbacks.ondata,ondataopen:callbacks.ondataopen,oncleanup:callbacks.oncleanup,ondetached:callbacks.ondetached,hangup:function(sendRequest){cleanupWebrtc(handleId,sendRequest===true)},detach:function(callbacks){destroyHandle(handleId,callbacks)}};pluginHandles[handleId]=pluginHandle;callbacks.success(pluginHandle)};request["session_id"]=sessionId;ws.send(JSON.stringify(request));return}Janus.httpAPICall(server+"/"+sessionId,{verb:"POST",withCredentials:withCredentials,body:request,success:function(json){Janus.debug(json);if(json["janus"]!=="success"){Janus.error("Ooops: "+json["error"].code+" "+json["error"].reason);callbacks.error("Ooops: "+json["error"].code+" "+json["error"].reason);return}var handleId=json.data["id"];Janus.log("Created handle: "+handleId);var pluginHandle={session:that,plugin:plugin,id:handleId,token:handleToken,detached:false,webrtcStuff:{started:false,myStream:null,streamExternal:false,remoteStream:null,mySdp:null,mediaConstraints:null,pc:null,dataChannel:{},dtmfSender:null,trickle:true,iceDone:false,volume:{value:null,timer:null},bitrate:{value:null,bsnow:null,bsbefore:null,tsnow:null,tsbefore:null,timer:null}},getId:function(){return handleId},getPlugin:function(){return plugin},getVolume:function(){return getVolume(handleId,true)},getRemoteVolume:function(){return getVolume(handleId,true)},getLocalVolume:function(){return getVolume(handleId,false)},isAudioMuted:function(){return isMuted(handleId,false)},muteAudio:function(){return mute(handleId,false,true)},unmuteAudio:function(){return mute(handleId,false,false)},isVideoMuted:function(){return isMuted(handleId,true)},muteVideo:function(){return mute(handleId,true,true)},unmuteVideo:function(){return mute(handleId,true,false)},getBitrate:function(){return getBitrate(handleId)},send:function(callbacks){sendMessage(handleId,callbacks)},data:function(callbacks){sendData(handleId,callbacks)},dtmf:function(callbacks){sendDtmf(handleId,callbacks)},consentDialog:callbacks.consentDialog,iceState:callbacks.iceState,mediaState:callbacks.mediaState,webrtcState:callbacks.webrtcState,slowLink:callbacks.slowLink,onmessage:callbacks.onmessage,createOffer:function(callbacks){prepareWebrtc(handleId,true,callbacks)},createAnswer:function(callbacks){prepareWebrtc(handleId,false,callbacks)},handleRemoteJsep:function(callbacks){prepareWebrtcPeer(handleId,callbacks)},onlocalstream:callbacks.onlocalstream,onremotestream:callbacks.onremotestream,ondata:callbacks.ondata,ondataopen:callbacks.ondataopen,oncleanup:callbacks.oncleanup,ondetached:callbacks.ondetached,hangup:function(sendRequest){cleanupWebrtc(handleId,sendRequest===true)},detach:function(callbacks){destroyHandle(handleId,callbacks)}};pluginHandles[handleId]=pluginHandle;callbacks.success(pluginHandle)},error:function(textStatus,errorThrown){Janus.error(textStatus+":",errorThrown);if(errorThrown==="")callbacks.error(textStatus+": Is the server down?");else callbacks.error(textStatus+": "+errorThrown)}})}function sendMessage(handleId,callbacks){callbacks=callbacks||{};callbacks.success=typeof callbacks.success=="function"?callbacks.success:Janus.noop;callbacks.error=typeof callbacks.error=="function"?callbacks.error:Janus.noop;if(!connected){Janus.warn("Is the server down? (connected=false)");callbacks.error("Is the server down? (connected=false)");return}var pluginHandle=pluginHandles[handleId];if(!pluginHandle||!pluginHandle.webrtcStuff){Janus.warn("Invalid handle");callbacks.error("Invalid handle");return}var message=callbacks.message;var jsep=callbacks.jsep;var transaction=Janus.randomString(12);var request={janus:"message",body:message,transaction:transaction};if(pluginHandle.token)request["token"]=pluginHandle.token;if(apisecret)request["apisecret"]=apisecret;if(jsep){request.jsep={type:jsep.type,sdp:jsep.sdp};if(jsep.e2ee)request.jsep.e2ee=true;if(jsep.rid_order==="hml"||jsep.rid_order==="lmh")request.jsep.rid_order=jsep.rid_order}Janus.debug("Sending message to plugin (handle="+handleId+"):");Janus.debug(request);if(websockets){request["session_id"]=sessionId;request["handle_id"]=handleId;transactions[transaction]=function(json){Janus.debug("Message sent!");Janus.debug(json);if(json["janus"]==="success"){var plugindata=json["plugindata"];if(!plugindata){Janus.warn("Request succeeded, but missing plugindata...");callbacks.success();return}Janus.log("Synchronous transaction successful ("+plugindata["plugin"]+")");var data=plugindata["data"];Janus.debug(data);callbacks.success(data);return}else if(json["janus"]!=="ack"){if(json["error"]){Janus.error("Ooops: "+json["error"].code+" "+json["error"].reason);callbacks.error(json["error"].code+" "+json["error"].reason)}else{Janus.error("Unknown error");callbacks.error("Unknown error")}return}callbacks.success()};ws.send(JSON.stringify(request));return}Janus.httpAPICall(server+"/"+sessionId+"/"+handleId,{verb:"POST",withCredentials:withCredentials,body:request,success:function(json){Janus.debug("Message sent!");Janus.debug(json);if(json["janus"]==="success"){var plugindata=json["plugindata"];if(!plugindata){Janus.warn("Request succeeded, but missing plugindata...");callbacks.success();return}Janus.log("Synchronous transaction successful ("+plugindata["plugin"]+")");var data=plugindata["data"];Janus.debug(data);callbacks.success(data);return}else if(json["janus"]!=="ack"){if(json["error"]){Janus.error("Ooops: "+json["error"].code+" "+json["error"].reason);callbacks.error(json["error"].code+" "+json["error"].reason)}else{Janus.error("Unknown error");callbacks.error("Unknown error")}return}callbacks.success()},error:function(textStatus,errorThrown){Janus.error(textStatus+":",errorThrown);callbacks.error(textStatus+": "+errorThrown)}})}function sendTrickleCandidate(handleId,candidate){if(!connected){Janus.warn("Is the server down? (connected=false)");return}var pluginHandle=pluginHandles[handleId];if(!pluginHandle||!pluginHandle.webrtcStuff){Janus.warn("Invalid handle");return}var request={janus:"trickle",candidate:candidate,transaction:Janus.randomString(12)};if(pluginHandle.token)request["token"]=pluginHandle.token;if(apisecret)request["apisecret"]=apisecret;Janus.vdebug("Sending trickle candidate (handle="+handleId+"):");Janus.vdebug(request);if(websockets){request["session_id"]=sessionId;request["handle_id"]=handleId;ws.send(JSON.stringify(request));return}Janus.httpAPICall(server+"/"+sessionId+"/"+handleId,{verb:"POST",withCredentials:withCredentials,body:request,success:function(json){Janus.vdebug("Candidate sent!");Janus.vdebug(json);if(json["janus"]!=="ack"){Janus.error("Ooops: "+json["error"].code+" "+json["error"].reason);return}},error:function(textStatus,errorThrown){Janus.error(textStatus+":",errorThrown)}})}function createDataChannel(handleId,dclabel,dcprotocol,incoming,pendingData){var pluginHandle=pluginHandles[handleId];if(!pluginHandle||!pluginHandle.webrtcStuff){Janus.warn("Invalid handle");return}var config=pluginHandle.webrtcStuff;if(!config.pc){Janus.warn("Invalid PeerConnection");return}var onDataChannelMessage=function(event){Janus.log("Received message on data channel:",event);var label=event.target.label;pluginHandle.ondata(event.data,label)};var onDataChannelStateChange=function(event){Janus.log("Received state change on data channel:",event);var label=event.target.label;var protocol=event.target.protocol;var dcState=config.dataChannel[label]?config.dataChannel[label].readyState:"null";Janus.log("State change on <"+label+"> data channel: "+dcState);if(dcState==="open"){if(config.dataChannel[label].pending&&config.dataChannel[label].pending.length>0){Janus.log("Sending pending messages on <"+label+">:",config.dataChannel[label].pending.length);for(var data of config.dataChannel[label].pending){Janus.log("Sending data on data channel <"+label+">");Janus.debug(data);config.dataChannel[label].send(data)}config.dataChannel[label].pending=[]}pluginHandle.ondataopen(label,protocol)}};var onDataChannelError=function(error){Janus.error("Got error on data channel:",error)};if(!incoming){var dcoptions={ordered:true};if(dcprotocol)dcoptions.protocol=dcprotocol;config.dataChannel[dclabel]=config.pc.createDataChannel(dclabel,dcoptions)}else{config.dataChannel[dclabel]=incoming}config.dataChannel[dclabel].onmessage=onDataChannelMessage;config.dataChannel[dclabel].onopen=onDataChannelStateChange;config.dataChannel[dclabel].onclose=onDataChannelStateChange;config.dataChannel[dclabel].onerror=onDataChannelError;config.dataChannel[dclabel].pending=[];if(pendingData)config.dataChannel[dclabel].pending.push(pendingData)}function sendData(handleId,callbacks){callbacks=callbacks||{};callbacks.success=typeof callbacks.success=="function"?callbacks.success:Janus.noop;callbacks.error=typeof callbacks.error=="function"?callbacks.error:Janus.noop;var pluginHandle=pluginHandles[handleId];if(!pluginHandle||!pluginHandle.webrtcStuff){Janus.warn("Invalid handle");callbacks.error("Invalid handle");return}var config=pluginHandle.webrtcStuff;var data=callbacks.text||callbacks.data;if(!data){Janus.warn("Invalid data");callbacks.error("Invalid data");return}var label=callbacks.label?callbacks.label:Janus.dataChanDefaultLabel;if(!config.dataChannel[label]){createDataChannel(handleId,label,callbacks.protocol,false,data,callbacks.protocol);callbacks.success();return}if(config.dataChannel[label].readyState!=="open"){config.dataChannel[label].pending.push(data);callbacks.success();return}Janus.log("Sending data on data channel <"+label+">");Janus.debug(data);config.dataChannel[label].send(data);callbacks.success()}function sendDtmf(handleId,callbacks){callbacks=callbacks||{};callbacks.success=typeof callbacks.success=="function"?callbacks.success:Janus.noop;callbacks.error=typeof callbacks.error=="function"?callbacks.error:Janus.noop;var pluginHandle=pluginHandles[handleId];if(!pluginHandle||!pluginHandle.webrtcStuff){Janus.warn("Invalid handle");callbacks.error("Invalid handle");return}var config=pluginHandle.webrtcStuff;if(!config.dtmfSender){if(config.pc){var senders=config.pc.getSenders();var audioSender=senders.find(function(sender){return sender.track&&sender.track.kind==="audio"});if(!audioSender){Janus.warn("Invalid DTMF configuration (no audio track)");callbacks.error("Invalid DTMF configuration (no audio track)");return}config.dtmfSender=audioSender.dtmf;if(config.dtmfSender){Janus.log("Created DTMF Sender");config.dtmfSender.ontonechange=function(tone){Janus.debug("Sent DTMF tone: "+tone.tone)}}}if(!config.dtmfSender){Janus.warn("Invalid DTMF configuration");callbacks.error("Invalid DTMF configuration");return}}var dtmf=callbacks.dtmf;if(!dtmf){Janus.warn("Invalid DTMF parameters");callbacks.error("Invalid DTMF parameters");return}var tones=dtmf.tones;if(!tones){Janus.warn("Invalid DTMF string");callbacks.error("Invalid DTMF string");return}var duration=typeof dtmf.duration==="number"?dtmf.duration:500;var gap=typeof dtmf.gap==="number"?dtmf.gap:50;Janus.debug("Sending DTMF string "+tones+" (duration "+duration+"ms, gap "+gap+"ms)");config.dtmfSender.insertDTMF(tones,duration,gap);callbacks.success()}function destroyHandle(handleId,callbacks){callbacks=callbacks||{};callbacks.success=typeof callbacks.success=="function"?callbacks.success:Janus.noop;callbacks.error=typeof callbacks.error=="function"?callbacks.error:Janus.noop;var noRequest=callbacks.noRequest===true;Janus.log("Destroying handle "+handleId+" (only-locally="+noRequest+")");cleanupWebrtc(handleId);var pluginHandle=pluginHandles[handleId];if(!pluginHandle||pluginHandle.detached){delete pluginHandles[handleId];callbacks.success();return}if(noRequest){delete pluginHandles[handleId];callbacks.success();return}if(!connected){Janus.warn("Is the server down? (connected=false)");callbacks.error("Is the server down? (connected=false)");return}var request={janus:"detach",transaction:Janus.randomString(12)};if(pluginHandle.token)request["token"]=pluginHandle.token;if(apisecret)request["apisecret"]=apisecret;if(websockets){request["session_id"]=sessionId;request["handle_id"]=handleId;ws.send(JSON.stringify(request));delete pluginHandles[handleId];callbacks.success();return}Janus.httpAPICall(server+"/"+sessionId+"/"+handleId,{verb:"POST",withCredentials:withCredentials,body:request,success:function(json){Janus.log("Destroyed handle:");Janus.debug(json);if(json["janus"]!=="success"){Janus.error("Ooops: "+json["error"].code+" "+json["error"].reason)}delete pluginHandles[handleId];callbacks.success()},error:function(textStatus,errorThrown){Janus.error(textStatus+":",errorThrown);delete pluginHandles[handleId];callbacks.success()}})}function streamsDone(handleId,jsep,media,callbacks,stream){var pluginHandle=pluginHandles[handleId];if(!pluginHandle||!pluginHandle.webrtcStuff){Janus.warn("Invalid handle");if(!callbacks.stream){Janus.stopAllTracks(stream)}callbacks.error("Invalid handle");return}var config=pluginHandle.webrtcStuff;Janus.debug("streamsDone:",stream);if(stream){Janus.debug("  -- Audio tracks:",stream.getAudioTracks());Janus.debug("  -- Video tracks:",stream.getVideoTracks())}var addTracks=false;if(!config.myStream||!media.update||config.streamExternal){config.myStream=stream;addTracks=true}else{if((!media.update&&isAudioSendEnabled(media)||media.update&&(media.addAudio||media.replaceAudio))&&stream.getAudioTracks()&&stream.getAudioTracks().length){config.myStream.addTrack(stream.getAudioTracks()[0]);if(Janus.unifiedPlan){Janus.log((media.replaceAudio?"Replacing":"Adding")+" audio track:",stream.getAudioTracks()[0]);var audioTransceiver=null;var transceivers=config.pc.getTransceivers();if(transceivers&&transceivers.length>0){for(var t of transceivers){if(t.sender&&t.sender.track&&t.sender.track.kind==="audio"||t.receiver&&t.receiver.track&&t.receiver.track.kind==="audio"){audioTransceiver=t;break}}}if(audioTransceiver&&audioTransceiver.sender){audioTransceiver.sender.replaceTrack(stream.getAudioTracks()[0])}else{config.pc.addTrack(stream.getAudioTracks()[0],stream)}}else{Janus.log((media.replaceAudio?"Replacing":"Adding")+" audio track:",stream.getAudioTracks()[0]);config.pc.addTrack(stream.getAudioTracks()[0],stream)}}if((!media.update&&isVideoSendEnabled(media)||media.update&&(media.addVideo||media.replaceVideo))&&stream.getVideoTracks()&&stream.getVideoTracks().length){config.myStream.addTrack(stream.getVideoTracks()[0]);if(Janus.unifiedPlan){Janus.log((media.replaceVideo?"Replacing":"Adding")+" video track:",stream.getVideoTracks()[0]);var videoTransceiver=null;var transceivers=config.pc.getTransceivers();if(transceivers&&transceivers.length>0){for(var t of transceivers){if(t.sender&&t.sender.track&&t.sender.track.kind==="video"||t.receiver&&t.receiver.track&&t.receiver.track.kind==="video"){videoTransceiver=t;break}}}if(videoTransceiver&&videoTransceiver.sender){videoTransceiver.sender.replaceTrack(stream.getVideoTracks()[0])}else{config.pc.addTrack(stream.getVideoTracks()[0],stream)}}else{Janus.log((media.replaceVideo?"Replacing":"Adding")+" video track:",stream.getVideoTracks()[0]);config.pc.addTrack(stream.getVideoTracks()[0],stream)}}}if(!config.pc){var pc_config={iceServers:iceServers,iceTransportPolicy:"all",bundlePolicy:bundlePolicy};if(Janus.webRTCAdapter.browserDetails.browser==="chrome"){pc_config["sdpSemantics"]=Janus.webRTCAdapter.browserDetails.version<72?"plan-b":"unified-plan"}var pc_constraints={optional:[{DtlsSrtpKeyAgreement:true}]};if(ipv6Support){pc_constraints.optional.push({googIPv6:true})}if(callbacks.rtcConstraints&&typeof callbacks.rtcConstraints==="object"){Janus.debug("Adding custom PeerConnection constraints:",callbacks.rtcConstraints);for(var i in callbacks.rtcConstraints){pc_constraints.optional.push(callbacks.rtcConstraints[i])}}if(Janus.webRTCAdapter.browserDetails.browser==="edge"){pc_config.bundlePolicy="max-bundle"}if(RTCRtpSender&&(RTCRtpSender.prototype.createEncodedStreams||RTCRtpSender.prototype.createEncodedAudioStreams&&RTCRtpSender.prototype.createEncodedVideoStreams)&&(callbacks.senderTransforms||callbacks.receiverTransforms)){config.senderTransforms=callbacks.senderTransforms;config.receiverTransforms=callbacks.receiverTransforms;pc_config["forceEncodedAudioInsertableStreams"]=true;pc_config["forceEncodedVideoInsertableStreams"]=true;pc_config["encodedInsertableStreams"]=true}Janus.log("Creating PeerConnection");Janus.debug(pc_constraints);config.pc=new RTCPeerConnection(pc_config,pc_constraints);Janus.debug(config.pc);if(config.pc.getStats){config.volume={};config.bitrate.value="0 kbits/sec"}Janus.log("Preparing local SDP and gathering candidates (trickle="+config.trickle+")");config.pc.oniceconnectionstatechange=function(e){if(config.pc)pluginHandle.iceState(config.pc.iceConnectionState)};config.pc.onicecandidate=function(event){if(!event.candidate||Janus.webRTCAdapter.browserDetails.browser==="edge"&&event.candidate.candidate.indexOf("endOfCandidates")>0){Janus.log("End of candidates.");config.iceDone=true;if(config.trickle===true){sendTrickleCandidate(handleId,{completed:true})}else{sendSDP(handleId,callbacks)}}else{var candidate={candidate:event.candidate.candidate,sdpMid:event.candidate.sdpMid,sdpMLineIndex:event.candidate.sdpMLineIndex};if(config.trickle===true){sendTrickleCandidate(handleId,candidate)}}};config.pc.ontrack=function(event){Janus.log("Handling Remote Track");Janus.debug(event);if(!event.streams)return;config.remoteStream=event.streams[0];pluginHandle.onremotestream(config.remoteStream,event.track.kind);if(event.track.onended)return;if(config.receiverTransforms){var receiverStreams=null;if(RTCRtpSender.prototype.createEncodedStreams){receiverStreams=event.receiver.createEncodedStreams()}else if(RTCRtpSender.prototype.createAudioEncodedStreams||RTCRtpSender.prototype.createEncodedVideoStreams){if(event.track.kind==="audio"&&config.receiverTransforms["audio"]){receiverStreams=event.receiver.createEncodedAudioStreams()}else if(event.track.kind==="video"&&config.receiverTransforms["video"]){receiverStreams=event.receiver.createEncodedVideoStreams()}}if(receiverStreams){console.log(receiverStreams);if(receiverStreams.readableStream&&receiverStreams.writableStream){receiverStreams.readableStream.pipeThrough(config.receiverTransforms[event.track.kind]).pipeTo(receiverStreams.writableStream)}else if(receiverStreams.readable&&receiverStreams.writable){receiverStreams.readable.pipeThrough(config.receiverTransforms[event.track.kind]).pipeTo(receiverStreams.writable)}}}var trackMutedTimeoutId=null;Janus.log("Adding onended callback to track:",event.track);event.track.onended=function(ev){Janus.log("Remote track removed:",ev);if(config.remoteStream){clearTimeout(trackMutedTimeoutId);config.remoteStream.removeTrack(ev.target);pluginHandle.onremotestream(config.remoteStream)}};event.track.onmute=function(ev){Janus.log("Remote track muted:",ev);if(config.remoteStream&&trackMutedTimeoutId==null){trackMutedTimeoutId=setTimeout(function(){Janus.log("Removing remote track");if(config.remoteStream){config.remoteStream.removeTrack(ev.target);pluginHandle.onremotestream(config.remoteStream)}trackMutedTimeoutId=null},3*840)}};event.track.onunmute=function(ev){Janus.log("Remote track flowing again:",ev);if(trackMutedTimeoutId!=null){clearTimeout(trackMutedTimeoutId);trackMutedTimeoutId=null}else{try{config.remoteStream.addTrack(ev.target);pluginHandle.onremotestream(config.remoteStream)}catch(e){Janus.error(e)}}}}}if(addTracks&&stream){Janus.log("Adding local stream");var simulcast2=callbacks.simulcast2===true;stream.getTracks().forEach(function(track){Janus.log("Adding local track:",track);var sender=null;if(!simulcast2||track.kind==="audio"){sender=config.pc.addTrack(track,stream)}else{Janus.log("Enabling rid-based simulcasting:",track);var maxBitrates=getMaxBitrates(callbacks.simulcastMaxBitrates);var tr=config.pc.addTransceiver(track,{direction:"sendrecv",streams:[stream],sendEncodings:callbacks.sendEncodings||[{rid:"h",active:true,maxBitrate:maxBitrates.high},{rid:"m",active:true,maxBitrate:maxBitrates.medium,scaleResolutionDownBy:2},{rid:"l",active:true,maxBitrate:maxBitrates.low,scaleResolutionDownBy:4}]});if(tr)sender=tr.sender}if(sender&&config.senderTransforms){var senderStreams=null;if(RTCRtpSender.prototype.createEncodedStreams){senderStreams=sender.createEncodedStreams()}else if(RTCRtpSender.prototype.createAudioEncodedStreams||RTCRtpSender.prototype.createEncodedVideoStreams){if(sender.track.kind==="audio"&&config.senderTransforms["audio"]){senderStreams=sender.createEncodedAudioStreams()}else if(sender.track.kind==="video"&&config.senderTransforms["video"]){senderStreams=sender.createEncodedVideoStreams()}}if(senderStreams){console.log(senderStreams);if(senderStreams.readableStream&&senderStreams.writableStream){senderStreams.readableStream.pipeThrough(config.senderTransforms[sender.track.kind]).pipeTo(senderStreams.writableStream)}else if(senderStreams.readable&&senderStreams.writable){senderStreams.readable.pipeThrough(config.senderTransforms[sender.track.kind]).pipeTo(senderStreams.writable)}}}})}if(isDataEnabled(media)&&!config.dataChannel[Janus.dataChanDefaultLabel]){Janus.log("Creating default data channel");createDataChannel(handleId,Janus.dataChanDefaultLabel,null,false);config.pc.ondatachannel=function(event){Janus.log("Data channel created:",event);createDataChannel(handleId,event.channel.label,event.channel.protocol,event.channel)}}if(config.myStream){pluginHandle.onlocalstream(config.myStream)}if(!jsep){createOffer(handleId,media,callbacks)}else{config.pc.setRemoteDescription(jsep).then(function(){Janus.log("Remote description accepted!");config.remoteSdp=jsep.sdp;if(config.candidates&&config.candidates.length>0){for(var i=0;i<config.candidates.length;i++){var candidate=config.candidates[i];Janus.debug("Adding remote candidate:",candidate);if(!candidate||candidate.completed===true){config.pc.addIceCandidate(Janus.endOfCandidates)}else{config.pc.addIceCandidate(candidate)}}config.candidates=[]}createAnswer(handleId,media,callbacks)},callbacks.error)}}function prepareWebrtc(handleId,offer,callbacks){callbacks=callbacks||{};callbacks.success=typeof callbacks.success=="function"?callbacks.success:Janus.noop;callbacks.error=typeof callbacks.error=="function"?callbacks.error:webrtcError;var jsep=callbacks.jsep;if(offer&&jsep){Janus.error("Provided a JSEP to a createOffer");callbacks.error("Provided a JSEP to a createOffer");return}else if(!offer&&(!jsep||!jsep.type||!jsep.sdp)){Janus.error("A valid JSEP is required for createAnswer");callbacks.error("A valid JSEP is required for createAnswer");return}callbacks.media=typeof callbacks.media==="object"&&callbacks.media?callbacks.media:{audio:true,video:true};var media=callbacks.media;var pluginHandle=pluginHandles[handleId];if(!pluginHandle||!pluginHandle.webrtcStuff){Janus.warn("Invalid handle");callbacks.error("Invalid handle");return}var config=pluginHandle.webrtcStuff;config.trickle=isTrickleEnabled(callbacks.trickle);if(!config.pc){media.update=false;media.keepAudio=false;media.keepVideo=false}else{Janus.log("Updating existing media session");media.update=true;if(callbacks.stream){if(callbacks.stream!==config.myStream){Janus.log("Renegotiation involves a new external stream")}}else{if(media.addAudio){media.keepAudio=false;media.replaceAudio=false;media.removeAudio=false;media.audioSend=true;if(config.myStream&&config.myStream.getAudioTracks()&&config.myStream.getAudioTracks().length){Janus.error("Can't add audio stream, there already is one");callbacks.error("Can't add audio stream, there already is one");return}}else if(media.removeAudio){media.keepAudio=false;media.replaceAudio=false;media.addAudio=false;media.audioSend=false}else if(media.replaceAudio){media.keepAudio=false;media.addAudio=false;media.removeAudio=false;media.audioSend=true}if(!config.myStream){if(media.replaceAudio){media.keepAudio=false;media.replaceAudio=false;media.addAudio=true;media.audioSend=true}if(isAudioSendEnabled(media)){media.keepAudio=false;media.addAudio=true}}else{if(!config.myStream.getAudioTracks()||config.myStream.getAudioTracks().length===0){if(media.replaceAudio){media.keepAudio=false;media.replaceAudio=false;media.addAudio=true;media.audioSend=true}if(isAudioSendEnabled(media)){media.keepAudio=false;media.addAudio=true}}else{if(isAudioSendEnabled(media)&&!media.removeAudio&&!media.replaceAudio){media.keepAudio=true}}}if(media.addVideo){media.keepVideo=false;media.replaceVideo=false;media.removeVideo=false;media.videoSend=true;if(config.myStream&&config.myStream.getVideoTracks()&&config.myStream.getVideoTracks().length){Janus.error("Can't add video stream, there already is one");callbacks.error("Can't add video stream, there already is one");return}}else if(media.removeVideo){media.keepVideo=false;media.replaceVideo=false;media.addVideo=false;media.videoSend=false}else if(media.replaceVideo){media.keepVideo=false;media.addVideo=false;media.removeVideo=false;media.videoSend=true}if(!config.myStream){if(media.replaceVideo){media.keepVideo=false;media.replaceVideo=false;media.addVideo=true;media.videoSend=true}if(isVideoSendEnabled(media)){media.keepVideo=false;media.addVideo=true}}else{if(!config.myStream.getVideoTracks()||config.myStream.getVideoTracks().length===0){if(media.replaceVideo){media.keepVideo=false;media.replaceVideo=false;media.addVideo=true;media.videoSend=true}if(isVideoSendEnabled(media)){media.keepVideo=false;media.addVideo=true}}else{if(isVideoSendEnabled(media)&&!media.removeVideo&&!media.replaceVideo){media.keepVideo=true}}}if(media.addData){media.data=true}}if(isAudioSendEnabled(media)&&media.keepAudio&&(isVideoSendEnabled(media)&&media.keepVideo)){pluginHandle.consentDialog(false);streamsDone(handleId,jsep,media,callbacks,config.myStream);return}}if(media.update&&!config.streamExternal){if(media.removeAudio||media.replaceAudio){if(config.myStream&&config.myStream.getAudioTracks()&&config.myStream.getAudioTracks().length){var at=config.myStream.getAudioTracks()[0];Janus.log("Removing audio track:",at);config.myStream.removeTrack(at);try{at.stop()}catch(e){}}if(config.pc.getSenders()&&config.pc.getSenders().length){var ra=true;if(media.replaceAudio&&Janus.unifiedPlan){ra=false}if(ra){for(var asnd of config.pc.getSenders()){if(asnd&&asnd.track&&asnd.track.kind==="audio"){Janus.log("Removing audio sender:",asnd);config.pc.removeTrack(asnd)}}}}}if(media.removeVideo||media.replaceVideo){if(config.myStream&&config.myStream.getVideoTracks()&&config.myStream.getVideoTracks().length){var vt=config.myStream.getVideoTracks()[0];Janus.log("Removing video track:",vt);config.myStream.removeTrack(vt);try{vt.stop()}catch(e){}}if(config.pc.getSenders()&&config.pc.getSenders().length){var rv=true;if(media.replaceVideo&&Janus.unifiedPlan){rv=false}if(rv){for(var vsnd of config.pc.getSenders()){if(vsnd&&vsnd.track&&vsnd.track.kind==="video"){Janus.log("Removing video sender:",vsnd);config.pc.removeTrack(vsnd)}}}}}}if(callbacks.stream){var stream=callbacks.stream;Janus.log("MediaStream provided by the application");Janus.debug(stream);if(media.update){if(config.myStream&&config.myStream!==callbacks.stream&&!config.streamExternal){Janus.stopAllTracks(config.myStream);config.myStream=null}}config.streamExternal=true;pluginHandle.consentDialog(false);streamsDone(handleId,jsep,media,callbacks,stream);return}if(isAudioSendEnabled(media)||isVideoSendEnabled(media)){if(!Janus.isGetUserMediaAvailable()){callbacks.error("getUserMedia not available");return}var constraints={mandatory:{},optional:[]};pluginHandle.consentDialog(true);var audioSupport=isAudioSendEnabled(media);if(audioSupport&&media&&typeof media.audio==="object")audioSupport=media.audio;var videoSupport=isVideoSendEnabled(media);if(videoSupport&&media){var simulcast=callbacks.simulcast===true;var simulcast2=callbacks.simulcast2===true;if((simulcast||simulcast2)&&!jsep&&!media.video)media.video="hires";if(media.video&&media.video!="screen"&&media.video!="window"){if(typeof media.video==="object"){videoSupport=media.video}else{var width=0;var height=0,maxHeight=0;if(media.video==="lowres"){height=240;maxHeight=240;width=320}else if(media.video==="lowres-16:9"){height=180;maxHeight=180;width=320}else if(media.video==="hires"||media.video==="hires-16:9"||media.video==="hdres"){height=720;maxHeight=720;width=1280}else if(media.video==="fhdres"){height=1080;maxHeight=1080;width=1920}else if(media.video==="4kres"){height=2160;maxHeight=2160;width=3840}else if(media.video==="stdres"){height=480;maxHeight=480;width=640}else if(media.video==="stdres-16:9"){height=360;maxHeight=360;width=640}else{Janus.log("Default video setting is stdres 4:3");height=480;maxHeight=480;width=640}Janus.log("Adding media constraint:",media.video);videoSupport={height:{ideal:height},width:{ideal:width}};Janus.log("Adding video constraint:",videoSupport)}}else if(media.video==="screen"||media.video==="window"){if(navigator.mediaDevices&&navigator.mediaDevices.getDisplayMedia){constraints.video={};if(media.screenshareFrameRate){constraints.video.frameRate=media.screenshareFrameRate}if(media.screenshareHeight){constraints.video.height=media.screenshareHeight}if(media.screenshareWidth){constraints.video.width=media.screenshareWidth}constraints.audio=media.captureDesktopAudio;navigator.mediaDevices.getDisplayMedia(constraints).then(function(stream){pluginHandle.consentDialog(false);if(isAudioSendEnabled(media)&&!media.keepAudio){navigator.mediaDevices.getUserMedia({audio:true,video:false}).then(function(audioStream){stream.addTrack(audioStream.getAudioTracks()[0]);streamsDone(handleId,jsep,media,callbacks,stream)})}else{streamsDone(handleId,jsep,media,callbacks,stream)}},function(error){pluginHandle.consentDialog(false);callbacks.error(error)});return}function callbackUserMedia(error,stream){pluginHandle.consentDialog(false);if(error){callbacks.error(error)}else{streamsDone(handleId,jsep,media,callbacks,stream)}}function getScreenMedia(constraints,gsmCallback,useAudio){Janus.log("Adding media constraint (screen capture)");Janus.debug(constraints);navigator.mediaDevices.getUserMedia(constraints).then(function(stream){if(useAudio){navigator.mediaDevices.getUserMedia({audio:true,video:false}).then(function(audioStream){stream.addTrack(audioStream.getAudioTracks()[0]);gsmCallback(null,stream)})}else{gsmCallback(null,stream)}}).catch(function(error){pluginHandle.consentDialog(false);gsmCallback(error)})}if(Janus.webRTCAdapter.browserDetails.browser==="chrome"){var chromever=Janus.webRTCAdapter.browserDetails.version;var maxver=33;if(window.navigator.userAgent.match("Linux"))maxver=35;if(chromever>=26&&chromever<=maxver){constraints={video:{mandatory:{googLeakyBucket:true,maxWidth:window.screen.width,maxHeight:window.screen.height,minFrameRate:media.screenshareFrameRate,maxFrameRate:media.screenshareFrameRate,chromeMediaSource:"screen"}},audio:isAudioSendEnabled(media)&&!media.keepAudio};getScreenMedia(constraints,callbackUserMedia)}else{Janus.extension.getScreen(function(error,sourceId){if(error){pluginHandle.consentDialog(false);return callbacks.error(error)}constraints={audio:false,video:{mandatory:{chromeMediaSource:"desktop",maxWidth:window.screen.width,maxHeight:window.screen.height,minFrameRate:media.screenshareFrameRate,maxFrameRate:media.screenshareFrameRate},optional:[{googLeakyBucket:true},{googTemporalLayeredScreencast:true}]}};constraints.video.mandatory.chromeMediaSourceId=sourceId;getScreenMedia(constraints,callbackUserMedia,isAudioSendEnabled(media)&&!media.keepAudio)})}}else if(Janus.webRTCAdapter.browserDetails.browser==="firefox"){if(Janus.webRTCAdapter.browserDetails.version>=33){constraints={video:{mozMediaSource:media.video,mediaSource:media.video},audio:isAudioSendEnabled(media)&&!media.keepAudio};getScreenMedia(constraints,function(err,stream){callbackUserMedia(err,stream);if(!err){var lastTime=stream.currentTime;var polly=window.setInterval(function(){if(!stream)window.clearInterval(polly);if(stream.currentTime==lastTime){window.clearInterval(polly);if(stream.onended){stream.onended()}}lastTime=stream.currentTime},500)}})}else{var error=new Error("NavigatorUserMediaError");error.name="Your version of Firefox does not support screen sharing, please install Firefox 33 (or more recent versions)";pluginHandle.consentDialog(false);callbacks.error(error);return}}return}}if(!media||media.video!=="screen"){navigator.mediaDevices.enumerateDevices().then(function(devices){var audioExist=devices.some(function(device){return device.kind==="audioinput"}),videoExist=isScreenSendEnabled(media)||devices.some(function(device){return device.kind==="videoinput"});var audioSend=isAudioSendEnabled(media);var videoSend=isVideoSendEnabled(media);var needAudioDevice=isAudioSendRequired(media);var needVideoDevice=isVideoSendRequired(media);if(audioSend||videoSend||needAudioDevice||needVideoDevice){var haveAudioDevice=audioSend?audioExist:false;var haveVideoDevice=videoSend?videoExist:false;if(!haveAudioDevice&&!haveVideoDevice){pluginHandle.consentDialog(false);callbacks.error("No capture device found");return false}else if(!haveAudioDevice&&needAudioDevice){pluginHandle.consentDialog(false);callbacks.error("Audio capture is required, but no capture device found");return false}else if(!haveVideoDevice&&needVideoDevice){pluginHandle.consentDialog(false);callbacks.error("Video capture is required, but no capture device found");return false}}var gumConstraints={audio:audioExist&&!media.keepAudio?audioSupport:false,video:videoExist&&!media.keepVideo?videoSupport:false};Janus.debug("getUserMedia constraints",gumConstraints);if(!gumConstraints.audio&&!gumConstraints.video){pluginHandle.consentDialog(false);streamsDone(handleId,jsep,media,callbacks,stream)}else{navigator.mediaDevices.getUserMedia(gumConstraints).then(function(stream){pluginHandle.consentDialog(false);streamsDone(handleId,jsep,media,callbacks,stream)}).catch(function(error){pluginHandle.consentDialog(false);callbacks.error({code:error.code,name:error.name,message:error.message})})}}).catch(function(error){pluginHandle.consentDialog(false);callbacks.error(error)})}}else{streamsDone(handleId,jsep,media,callbacks)}}function prepareWebrtcPeer(handleId,callbacks){callbacks=callbacks||{};callbacks.success=typeof callbacks.success=="function"?callbacks.success:Janus.noop;callbacks.error=typeof callbacks.error=="function"?callbacks.error:webrtcError;var jsep=callbacks.jsep;var pluginHandle=pluginHandles[handleId];if(!pluginHandle||!pluginHandle.webrtcStuff){Janus.warn("Invalid handle");callbacks.error("Invalid handle");return}var config=pluginHandle.webrtcStuff;if(jsep){if(!config.pc){Janus.warn("Wait, no PeerConnection?? if this is an answer, use createAnswer and not handleRemoteJsep");callbacks.error("No PeerConnection: if this is an answer, use createAnswer and not handleRemoteJsep");return}config.pc.setRemoteDescription(jsep).then(function(){Janus.log("Remote description accepted!");config.remoteSdp=jsep.sdp;if(config.candidates&&config.candidates.length>0){for(var i=0;i<config.candidates.length;i++){var candidate=config.candidates[i];Janus.debug("Adding remote candidate:",candidate);if(!candidate||candidate.completed===true){config.pc.addIceCandidate(Janus.endOfCandidates)}else{config.pc.addIceCandidate(candidate)}}config.candidates=[]}callbacks.success()},callbacks.error)}else{callbacks.error("Invalid JSEP")}}function createOffer(handleId,media,callbacks){callbacks=callbacks||{};callbacks.success=typeof callbacks.success=="function"?callbacks.success:Janus.noop;callbacks.error=typeof callbacks.error=="function"?callbacks.error:Janus.noop;callbacks.customizeSdp=typeof callbacks.customizeSdp=="function"?callbacks.customizeSdp:Janus.noop;var pluginHandle=pluginHandles[handleId];if(!pluginHandle||!pluginHandle.webrtcStuff){Janus.warn("Invalid handle");callbacks.error("Invalid handle");return}var config=pluginHandle.webrtcStuff;var simulcast=callbacks.simulcast===true;if(!simulcast){Janus.log("Creating offer (iceDone="+config.iceDone+")")}else{Janus.log("Creating offer (iceDone="+config.iceDone+", simulcast="+simulcast+")")}var mediaConstraints={};if(Janus.unifiedPlan){var audioTransceiver=null,videoTransceiver=null;var transceivers=config.pc.getTransceivers();if(transceivers&&transceivers.length>0){for(var t of transceivers){if(t.sender&&t.sender.track&&t.sender.track.kind==="audio"||t.receiver&&t.receiver.track&&t.receiver.track.kind==="audio"){if(!audioTransceiver){audioTransceiver=t}continue}if(t.sender&&t.sender.track&&t.sender.track.kind==="video"||t.receiver&&t.receiver.track&&t.receiver.track.kind==="video"){if(!videoTransceiver){videoTransceiver=t}continue}}}var audioSend=isAudioSendEnabled(media);var audioRecv=isAudioRecvEnabled(media);if(!audioSend&&!audioRecv){if(media.removeAudio&&audioTransceiver){if(audioTransceiver.setDirection){audioTransceiver.setDirection("inactive")}else{audioTransceiver.direction="inactive"}Janus.log("Setting audio transceiver to inactive:",audioTransceiver)}}else{if(audioSend&&audioRecv){if(audioTransceiver){if(audioTransceiver.setDirection){audioTransceiver.setDirection("sendrecv")}else{audioTransceiver.direction="sendrecv"}Janus.log("Setting audio transceiver to sendrecv:",audioTransceiver)}}else if(audioSend&&!audioRecv){if(audioTransceiver){if(audioTransceiver.setDirection){audioTransceiver.setDirection("sendonly")}else{audioTransceiver.direction="sendonly"}Janus.log("Setting audio transceiver to sendonly:",audioTransceiver)}}else if(!audioSend&&audioRecv){if(audioTransceiver){if(audioTransceiver.setDirection){audioTransceiver.setDirection("recvonly")}else{audioTransceiver.direction="recvonly"}Janus.log("Setting audio transceiver to recvonly:",audioTransceiver)}else{audioTransceiver=config.pc.addTransceiver("audio",{direction:"recvonly"});Janus.log("Adding recvonly audio transceiver:",audioTransceiver)}}}var videoSend=isVideoSendEnabled(media);var videoRecv=isVideoRecvEnabled(media);if(!videoSend&&!videoRecv){if(media.removeVideo&&videoTransceiver){if(videoTransceiver.setDirection){videoTransceiver.setDirection("inactive")}else{videoTransceiver.direction="inactive"}Janus.log("Setting video transceiver to inactive:",videoTransceiver)}}else{if(videoSend&&videoRecv){if(videoTransceiver){if(videoTransceiver.setDirection){videoTransceiver.setDirection("sendrecv")}else{videoTransceiver.direction="sendrecv"}Janus.log("Setting video transceiver to sendrecv:",videoTransceiver)}}else if(videoSend&&!videoRecv){if(videoTransceiver){if(videoTransceiver.setDirection){videoTransceiver.setDirection("sendonly")}else{videoTransceiver.direction="sendonly"}Janus.log("Setting video transceiver to sendonly:",videoTransceiver)}}else if(!videoSend&&videoRecv){if(videoTransceiver){if(videoTransceiver.setDirection){videoTransceiver.setDirection("recvonly")}else{videoTransceiver.direction="recvonly"}Janus.log("Setting video transceiver to recvonly:",videoTransceiver)}else{videoTransceiver=config.pc.addTransceiver("video",{direction:"recvonly"});Janus.log("Adding recvonly video transceiver:",videoTransceiver)}}}}else{mediaConstraints["offerToReceiveAudio"]=isAudioRecvEnabled(media);mediaConstraints["offerToReceiveVideo"]=isVideoRecvEnabled(media)}var iceRestart=callbacks.iceRestart===true;if(iceRestart){mediaConstraints["iceRestart"]=true}Janus.debug(mediaConstraints);var sendVideo=isVideoSendEnabled(media);if(sendVideo&&simulcast&&Janus.webRTCAdapter.browserDetails.browser==="firefox"){Janus.log("Enabling Simulcasting for Firefox (RID)");var sender=config.pc.getSenders().find(function(s){return s.track.kind==="video"});if(sender){var parameters=sender.getParameters();if(!parameters){parameters={}}var maxBitrates=getMaxBitrates(callbacks.simulcastMaxBitrates);parameters.encodings=callbacks.sendEncodings||[{rid:"h",active:true,maxBitrate:maxBitrates.high},{rid:"m",active:true,maxBitrate:maxBitrates.medium,scaleResolutionDownBy:2},{rid:"l",active:true,maxBitrate:maxBitrates.low,scaleResolutionDownBy:4}];sender.setParameters(parameters)}}config.pc.createOffer(mediaConstraints).then(function(offer){Janus.debug(offer);var jsep={type:offer.type,sdp:offer.sdp};callbacks.customizeSdp(jsep);offer.sdp=jsep.sdp;Janus.log("Setting local description");if(sendVideo&&simulcast){if(Janus.webRTCAdapter.browserDetails.browser==="chrome"||Janus.webRTCAdapter.browserDetails.browser==="safari"){Janus.log("Enabling Simulcasting for Chrome (SDP munging)");offer.sdp=mungeSdpForSimulcasting(offer.sdp)}else if(Janus.webRTCAdapter.browserDetails.browser!=="firefox"){Janus.warn("simulcast=true, but this is not Chrome nor Firefox, ignoring")}}config.mySdp={type:"offer",sdp:offer.sdp};config.pc.setLocalDescription(offer).catch(callbacks.error);config.mediaConstraints=mediaConstraints;if(!config.iceDone&&!config.trickle){Janus.log("Waiting for all candidates...");return}if(config.senderTransforms||config.receiverTransforms){offer["e2ee"]=true}callbacks.success(offer)},callbacks.error)}function createAnswer(handleId,media,callbacks){callbacks=callbacks||{};callbacks.success=typeof callbacks.success=="function"?callbacks.success:Janus.noop;callbacks.error=typeof callbacks.error=="function"?callbacks.error:Janus.noop;callbacks.customizeSdp=typeof callbacks.customizeSdp=="function"?callbacks.customizeSdp:Janus.noop;var pluginHandle=pluginHandles[handleId];if(!pluginHandle||!pluginHandle.webrtcStuff){Janus.warn("Invalid handle");callbacks.error("Invalid handle");return}var config=pluginHandle.webrtcStuff;var simulcast=callbacks.simulcast===true;if(!simulcast){Janus.log("Creating answer (iceDone="+config.iceDone+")")}else{Janus.log("Creating answer (iceDone="+config.iceDone+", simulcast="+simulcast+")")}var mediaConstraints=null;if(Janus.unifiedPlan){mediaConstraints={};var audioTransceiver=null,videoTransceiver=null;var transceivers=config.pc.getTransceivers();if(transceivers&&transceivers.length>0){for(var t of transceivers){if(t.sender&&t.sender.track&&t.sender.track.kind==="audio"||t.receiver&&t.receiver.track&&t.receiver.track.kind==="audio"){if(!audioTransceiver)audioTransceiver=t;continue}if(t.sender&&t.sender.track&&t.sender.track.kind==="video"||t.receiver&&t.receiver.track&&t.receiver.track.kind==="video"){if(!videoTransceiver)videoTransceiver=t;continue}}}var audioSend=isAudioSendEnabled(media);var audioRecv=isAudioRecvEnabled(media);if(!audioSend&&!audioRecv){if(media.removeAudio&&audioTransceiver){try{if(audioTransceiver.setDirection){audioTransceiver.setDirection("inactive")}else{audioTransceiver.direction="inactive"}Janus.log("Setting audio transceiver to inactive:",audioTransceiver)}catch(e){Janus.error(e)}}}else{if(audioSend&&audioRecv){if(audioTransceiver){try{if(audioTransceiver.setDirection){audioTransceiver.setDirection("sendrecv")}else{audioTransceiver.direction="sendrecv"}Janus.log("Setting audio transceiver to sendrecv:",audioTransceiver)}catch(e){Janus.error(e)}}}else if(audioSend&&!audioRecv){try{if(audioTransceiver){if(audioTransceiver.setDirection){audioTransceiver.setDirection("sendonly")}else{audioTransceiver.direction="sendonly"}Janus.log("Setting audio transceiver to sendonly:",audioTransceiver)}}catch(e){Janus.error(e)}}else if(!audioSend&&audioRecv){if(audioTransceiver){try{if(audioTransceiver.setDirection){audioTransceiver.setDirection("recvonly")}else{audioTransceiver.direction="recvonly"}Janus.log("Setting audio transceiver to recvonly:",audioTransceiver)}catch(e){Janus.error(e)}}else{audioTransceiver=config.pc.addTransceiver("audio",{direction:"recvonly"});Janus.log("Adding recvonly audio transceiver:",audioTransceiver)}}}var videoSend=isVideoSendEnabled(media);var videoRecv=isVideoRecvEnabled(media);if(!videoSend&&!videoRecv){if(media.removeVideo&&videoTransceiver){try{if(videoTransceiver.setDirection){videoTransceiver.setDirection("inactive")}else{videoTransceiver.direction="inactive"}Janus.log("Setting video transceiver to inactive:",videoTransceiver)}catch(e){Janus.error(e)}}}else{if(videoSend&&videoRecv){if(videoTransceiver){try{if(videoTransceiver.setDirection){videoTransceiver.setDirection("sendrecv")}else{videoTransceiver.direction="sendrecv"}Janus.log("Setting video transceiver to sendrecv:",videoTransceiver)}catch(e){Janus.error(e)}}}else if(videoSend&&!videoRecv){if(videoTransceiver){try{if(videoTransceiver.setDirection){videoTransceiver.setDirection("sendonly")}else{videoTransceiver.direction="sendonly"}Janus.log("Setting video transceiver to sendonly:",videoTransceiver)}catch(e){Janus.error(e)}}}else if(!videoSend&&videoRecv){if(videoTransceiver){try{if(videoTransceiver.setDirection){videoTransceiver.setDirection("recvonly")}else{videoTransceiver.direction="recvonly"}Janus.log("Setting video transceiver to recvonly:",videoTransceiver)}catch(e){Janus.error(e)}}else{videoTransceiver=config.pc.addTransceiver("video",{direction:"recvonly"});Janus.log("Adding recvonly video transceiver:",videoTransceiver)}}}}else{if(Janus.webRTCAdapter.browserDetails.browser==="firefox"||Janus.webRTCAdapter.browserDetails.browser==="edge"){mediaConstraints={offerToReceiveAudio:isAudioRecvEnabled(media),offerToReceiveVideo:isVideoRecvEnabled(media)}}else{mediaConstraints={mandatory:{OfferToReceiveAudio:isAudioRecvEnabled(media),OfferToReceiveVideo:isVideoRecvEnabled(media)}}}}Janus.debug(mediaConstraints);var sendVideo=isVideoSendEnabled(media);if(sendVideo&&simulcast&&Janus.webRTCAdapter.browserDetails.browser==="firefox"){Janus.log("Enabling Simulcasting for Firefox (RID)");var sender=config.pc.getSenders()[1];Janus.log(sender);var parameters=sender.getParameters();Janus.log(parameters);var maxBitrates=getMaxBitrates(callbacks.simulcastMaxBitrates);sender.setParameters({encodings:callbacks.sendEncodings||[{rid:"h",active:true,maxBitrate:maxBitrates.high},{rid:"m",active:true,maxBitrate:maxBitrates.medium,scaleResolutionDownBy:2},{rid:"l",active:true,maxBitrate:maxBitrates.low,scaleResolutionDownBy:4}]})}config.pc.createAnswer(mediaConstraints).then(function(answer){Janus.debug(answer);var jsep={type:answer.type,sdp:answer.sdp};callbacks.customizeSdp(jsep);answer.sdp=jsep.sdp;Janus.log("Setting local description");if(sendVideo&&simulcast){if(Janus.webRTCAdapter.browserDetails.browser==="chrome"){Janus.warn("simulcast=true, but this is an answer, and video breaks in Chrome if we enable it")}else if(Janus.webRTCAdapter.browserDetails.browser!=="firefox"){Janus.warn("simulcast=true, but this is not Chrome nor Firefox, ignoring")}}config.mySdp={type:"answer",sdp:answer.sdp};config.pc.setLocalDescription(answer).catch(callbacks.error);config.mediaConstraints=mediaConstraints;if(!config.iceDone&&!config.trickle){Janus.log("Waiting for all candidates...");return}if(config.senderTransforms||config.receiverTransforms){answer["e2ee"]=true}callbacks.success(answer)},callbacks.error)}function sendSDP(handleId,callbacks){callbacks=callbacks||{};callbacks.success=typeof callbacks.success=="function"?callbacks.success:Janus.noop;callbacks.error=typeof callbacks.error=="function"?callbacks.error:Janus.noop;var pluginHandle=pluginHandles[handleId];if(!pluginHandle||!pluginHandle.webrtcStuff){Janus.warn("Invalid handle, not sending anything");return}var config=pluginHandle.webrtcStuff;Janus.log("Sending offer/answer SDP...");if(!config.mySdp){Janus.warn("Local SDP instance is invalid, not sending anything...");return}config.mySdp={type:config.pc.localDescription.type,sdp:config.pc.localDescription.sdp};if(config.trickle===false)config.mySdp["trickle"]=false;Janus.debug(callbacks);config.sdpSent=true;callbacks.success(config.mySdp)}function getVolume(handleId,remote){var pluginHandle=pluginHandles[handleId];if(!pluginHandle||!pluginHandle.webrtcStuff){Janus.warn("Invalid handle");return 0}var stream=remote?"remote":"local";var config=pluginHandle.webrtcStuff;if(!config.volume[stream])config.volume[stream]={value:0};if(config.pc.getStats&&(Janus.webRTCAdapter.browserDetails.browser==="chrome"||Janus.webRTCAdapter.browserDetails.browser==="safari")){if(remote&&!config.remoteStream){Janus.warn("Remote stream unavailable");return 0}else if(!remote&&!config.myStream){Janus.warn("Local stream unavailable");return 0}if(!config.volume[stream].timer){Janus.log("Starting "+stream+" volume monitor");config.volume[stream].timer=setInterval(function(){config.pc.getStats().then(function(stats){stats.forEach(function(res){if(!res||res.kind!=="audio")return;if(remote&&!res.remoteSource||!remote&&res.type!=="media-source")return;config.volume[stream].value=res.audioLevel?res.audioLevel:0})})},200);return 0}return config.volume[stream].value}else{Janus.warn("Getting the "+stream+" volume unsupported by browser");return 0}}function isMuted(handleId,video){var pluginHandle=pluginHandles[handleId];if(!pluginHandle||!pluginHandle.webrtcStuff){Janus.warn("Invalid handle");return true}var config=pluginHandle.webrtcStuff;if(!config.pc){Janus.warn("Invalid PeerConnection");return true}if(!config.myStream){Janus.warn("Invalid local MediaStream");return true}if(video){if(!config.myStream.getVideoTracks()||config.myStream.getVideoTracks().length===0){Janus.warn("No video track");return true}return!config.myStream.getVideoTracks()[0].enabled}else{if(!config.myStream.getAudioTracks()||config.myStream.getAudioTracks().length===0){Janus.warn("No audio track");return true}return!config.myStream.getAudioTracks()[0].enabled}}function mute(handleId,video,mute){var pluginHandle=pluginHandles[handleId];if(!pluginHandle||!pluginHandle.webrtcStuff){Janus.warn("Invalid handle");return false}var config=pluginHandle.webrtcStuff;if(!config.pc){Janus.warn("Invalid PeerConnection");return false}if(!config.myStream){Janus.warn("Invalid local MediaStream");return false}if(video){if(!config.myStream.getVideoTracks()||config.myStream.getVideoTracks().length===0){Janus.warn("No video track");return false}config.myStream.getVideoTracks()[0].enabled=!mute;return true}else{if(!config.myStream.getAudioTracks()||config.myStream.getAudioTracks().length===0){Janus.warn("No audio track");return false}config.myStream.getAudioTracks()[0].enabled=!mute;return true}}function getBitrate(handleId){var pluginHandle=pluginHandles[handleId];if(!pluginHandle||!pluginHandle.webrtcStuff){Janus.warn("Invalid handle");return"Invalid handle"}var config=pluginHandle.webrtcStuff;if(!config.pc)return"Invalid PeerConnection";if(config.pc.getStats){if(!config.bitrate.timer){Janus.log("Starting bitrate timer (via getStats)");config.bitrate.timer=setInterval(function(){config.pc.getStats().then(function(stats){stats.forEach(function(res){if(!res)return;var inStats=false;if((res.mediaType==="video"||res.id.toLowerCase().indexOf("video")>-1)&&res.type==="inbound-rtp"&&res.id.indexOf("rtcp")<0){inStats=true}else if(res.type=="ssrc"&&res.bytesReceived&&(res.googCodecName==="VP8"||res.googCodecName==="")){inStats=true}if(inStats){config.bitrate.bsnow=res.bytesReceived;config.bitrate.tsnow=res.timestamp;if(config.bitrate.bsbefore===null||config.bitrate.tsbefore===null){config.bitrate.bsbefore=config.bitrate.bsnow;config.bitrate.tsbefore=config.bitrate.tsnow}else{var timePassed=config.bitrate.tsnow-config.bitrate.tsbefore;if(Janus.webRTCAdapter.browserDetails.browser==="safari")timePassed=timePassed/1e3;var bitRate=Math.round((config.bitrate.bsnow-config.bitrate.bsbefore)*8/timePassed);if(Janus.webRTCAdapter.browserDetails.browser==="safari")bitRate=parseInt(bitRate/1e3);config.bitrate.value=bitRate+" kbits/sec";config.bitrate.bsbefore=config.bitrate.bsnow;config.bitrate.tsbefore=config.bitrate.tsnow}}})})},1e3);return"0 kbits/sec"}return config.bitrate.value}else{Janus.warn("Getting the video bitrate unsupported by browser");return"Feature unsupported by browser"}}function webrtcError(error){Janus.error("WebRTC error:",error)}function cleanupWebrtc(handleId,hangupRequest){Janus.log("Cleaning WebRTC stuff");var pluginHandle=pluginHandles[handleId];if(!pluginHandle){return}var config=pluginHandle.webrtcStuff;if(config){if(hangupRequest===true){var request={janus:"hangup",transaction:Janus.randomString(12)};if(pluginHandle.token)request["token"]=pluginHandle.token;if(apisecret)request["apisecret"]=apisecret;Janus.debug("Sending hangup request (handle="+handleId+"):");Janus.debug(request);if(websockets){request["session_id"]=sessionId;request["handle_id"]=handleId;ws.send(JSON.stringify(request))}else{Janus.httpAPICall(server+"/"+sessionId+"/"+handleId,{verb:"POST",withCredentials:withCredentials,body:request})}}config.remoteStream=null;if(config.volume){if(config.volume["local"]&&config.volume["local"].timer)clearInterval(config.volume["local"].timer);if(config.volume["remote"]&&config.volume["remote"].timer)clearInterval(config.volume["remote"].timer)}config.volume={};if(config.bitrate.timer)clearInterval(config.bitrate.timer);config.bitrate.timer=null;config.bitrate.bsnow=null;config.bitrate.bsbefore=null;config.bitrate.tsnow=null;config.bitrate.tsbefore=null;config.bitrate.value=null;if(!config.streamExternal&&config.myStream){Janus.log("Stopping local stream tracks");Janus.stopAllTracks(config.myStream)}config.streamExternal=false;config.myStream=null;try{config.pc.close()}catch(e){}config.pc=null;config.candidates=null;config.mySdp=null;config.remoteSdp=null;config.iceDone=false;config.dataChannel={};config.dtmfSender=null;config.senderTransforms=null;config.receiverTransforms=null}pluginHandle.oncleanup()}function mungeSdpForSimulcasting(sdp){var lines=sdp.split("\r\n");var video=false;var ssrc=[-1],ssrc_fid=[-1];var cname=null,msid=null,mslabel=null,label=null;var insertAt=-1;for(var i=0;i<lines.length;i++){var mline=lines[i].match(/m=(\w+) */);if(mline){var medium=mline[1];if(medium==="video"){if(ssrc[0]<0){video=true}else{insertAt=i;break}}else{if(ssrc[0]>-1){insertAt=i;break}}continue}if(!video)continue;var sim=lines[i].match(/a=ssrc-group:SIM (\d+) (\d+) (\d+)/);if(sim){Janus.warn("The SDP already contains a SIM attribute, munging will be skipped");return sdp}var fid=lines[i].match(/a=ssrc-group:FID (\d+) (\d+)/);if(fid){ssrc[0]=fid[1];ssrc_fid[0]=fid[2];lines.splice(i,1);i--;continue}if(ssrc[0]){var match=lines[i].match("a=ssrc:"+ssrc[0]+" cname:(.+)");if(match){cname=match[1]}match=lines[i].match("a=ssrc:"+ssrc[0]+" msid:(.+)");if(match){msid=match[1]}match=lines[i].match("a=ssrc:"+ssrc[0]+" mslabel:(.+)");if(match){mslabel=match[1]}match=lines[i].match("a=ssrc:"+ssrc[0]+" label:(.+)");if(match){label=match[1]}if(lines[i].indexOf("a=ssrc:"+ssrc_fid[0])===0){lines.splice(i,1);i--;continue}if(lines[i].indexOf("a=ssrc:"+ssrc[0])===0){lines.splice(i,1);i--;continue}}if(lines[i].length==0){lines.splice(i,1);i--;continue}}if(ssrc[0]<0){insertAt=-1;video=false;for(var i=0;i<lines.length;i++){var mline=lines[i].match(/m=(\w+) */);if(mline){var medium=mline[1];if(medium==="video"){if(ssrc[0]<0){video=true}else{insertAt=i;break}}else{if(ssrc[0]>-1){insertAt=i;break}}continue}if(!video)continue;if(ssrc[0]<0){var value=lines[i].match(/a=ssrc:(\d+)/);if(value){ssrc[0]=value[1];lines.splice(i,1);i--;continue}}else{var match=lines[i].match("a=ssrc:"+ssrc[0]+" cname:(.+)");if(match){cname=match[1]}match=lines[i].match("a=ssrc:"+ssrc[0]+" msid:(.+)");if(match){msid=match[1]}match=lines[i].match("a=ssrc:"+ssrc[0]+" mslabel:(.+)");if(match){mslabel=match[1]}match=lines[i].match("a=ssrc:"+ssrc[0]+" label:(.+)");if(match){label=match[1]}if(lines[i].indexOf("a=ssrc:"+ssrc_fid[0])===0){lines.splice(i,1);i--;continue}if(lines[i].indexOf("a=ssrc:"+ssrc[0])===0){lines.splice(i,1);i--;continue}}if(lines[i].length===0){lines.splice(i,1);i--;continue}}}if(ssrc[0]<0){Janus.warn("Couldn't find the video SSRC, simulcasting NOT enabled");return sdp}if(insertAt<0){insertAt=lines.length}ssrc[1]=Math.floor(Math.random()*4294967295);ssrc[2]=Math.floor(Math.random()*4294967295);ssrc_fid[1]=Math.floor(Math.random()*4294967295);ssrc_fid[2]=Math.floor(Math.random()*4294967295);for(var i=0;i<ssrc.length;i++){if(cname){lines.splice(insertAt,0,"a=ssrc:"+ssrc[i]+" cname:"+cname);insertAt++}if(msid){lines.splice(insertAt,0,"a=ssrc:"+ssrc[i]+" msid:"+msid);insertAt++}if(mslabel){lines.splice(insertAt,0,"a=ssrc:"+ssrc[i]+" mslabel:"+mslabel);insertAt++}if(label){lines.splice(insertAt,0,"a=ssrc:"+ssrc[i]+" label:"+label);insertAt++}if(cname){lines.splice(insertAt,0,"a=ssrc:"+ssrc_fid[i]+" cname:"+cname);insertAt++}if(msid){lines.splice(insertAt,0,"a=ssrc:"+ssrc_fid[i]+" msid:"+msid);insertAt++}if(mslabel){lines.splice(insertAt,0,"a=ssrc:"+ssrc_fid[i]+" mslabel:"+mslabel);insertAt++}if(label){lines.splice(insertAt,0,"a=ssrc:"+ssrc_fid[i]+" label:"+label);insertAt++}}lines.splice(insertAt,0,"a=ssrc-group:FID "+ssrc[2]+" "+ssrc_fid[2]);lines.splice(insertAt,0,"a=ssrc-group:FID "+ssrc[1]+" "+ssrc_fid[1]);lines.splice(insertAt,0,"a=ssrc-group:FID "+ssrc[0]+" "+ssrc_fid[0]);lines.splice(insertAt,0,"a=ssrc-group:SIM "+ssrc[0]+" "+ssrc[1]+" "+ssrc[2]);sdp=lines.join("\r\n");if(!sdp.endsWith("\r\n"))sdp+="\r\n";return sdp}function isAudioSendEnabled(media){Janus.debug("isAudioSendEnabled:",media);if(!media)return true;if(media.audio===false)return false;if(media.audioSend===undefined||media.audioSend===null)return true;return media.audioSend===true}function isAudioSendRequired(media){Janus.debug("isAudioSendRequired:",media);if(!media)return false;if(media.audio===false||media.audioSend===false)return false;if(media.failIfNoAudio===undefined||media.failIfNoAudio===null)return false;return media.failIfNoAudio===true}function isAudioRecvEnabled(media){Janus.debug("isAudioRecvEnabled:",media);if(!media)return true;if(media.audio===false)return false;if(media.audioRecv===undefined||media.audioRecv===null)return true;return media.audioRecv===true}function isVideoSendEnabled(media){Janus.debug("isVideoSendEnabled:",media);if(!media)return true;if(media.video===false)return false;if(media.videoSend===undefined||media.videoSend===null)return true;return media.videoSend===true}function isVideoSendRequired(media){Janus.debug("isVideoSendRequired:",media);if(!media)return false;if(media.video===false||media.videoSend===false)return false;if(media.failIfNoVideo===undefined||media.failIfNoVideo===null)return false;return media.failIfNoVideo===true}function isVideoRecvEnabled(media){Janus.debug("isVideoRecvEnabled:",media);if(!media)return true;if(media.video===false)return false;if(media.videoRecv===undefined||media.videoRecv===null)return true;return media.videoRecv===true}function isScreenSendEnabled(media){Janus.debug("isScreenSendEnabled:",media);if(!media)return false;if(typeof media.video!=="object"||typeof media.video.mandatory!=="object")return false;var constraints=media.video.mandatory;if(constraints.chromeMediaSource)return constraints.chromeMediaSource==="desktop"||constraints.chromeMediaSource==="screen";else if(constraints.mozMediaSource)return constraints.mozMediaSource==="window"||constraints.mozMediaSource==="screen";else if(constraints.mediaSource)return constraints.mediaSource==="window"||constraints.mediaSource==="screen";return false}function isDataEnabled(media){Janus.debug("isDataEnabled:",media);if(Janus.webRTCAdapter.browserDetails.browser==="edge"){Janus.warn("Edge doesn't support data channels yet");return false}if(media===undefined||media===null)return false;return media.data===true}function isTrickleEnabled(trickle){Janus.debug("isTrickleEnabled:",trickle);return trickle===false?false:true}}